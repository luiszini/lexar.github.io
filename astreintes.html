<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>C√°lculo de Astreintes</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --fs-base:11px;
      --fs-sm:10px;
      --fs-h:13px;
      --pad:12px;
      --gap:8px;
      --primary-color:#0066CC;
      --primary-dark:#0052A3;
      --primary-darker:#003D7A;
      --success-color:#10B981;
      --success-dark:#059669;
      --error-color:#EF4444;
      --error-dark:#DC2626;
    }
    
    *{
      box-sizing:border-box;
      margin:0;
      padding:0;
    }
    
    html,body{
      margin:0;
      font-family:'Roboto','Segoe UI',system-ui,-apple-system,Arial,sans-serif;
      font-size:var(--fs-base);
      color:#1E293B;
      background:linear-gradient(135deg, #F8FAFC 0%, #F1F5F9 100%);
      min-height:100vh;
      font-weight:400;
    }
    
    /* Header moderno con gradiente */
    .header{
      display:flex;
      align-items:center;
      gap:10px;
      background:linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
      padding:4px 10px;
      box-shadow:0 2px 8px rgba(0, 102, 204, 0.15);
      min-height:40px;
    }
    
    .logo-section{
      display:flex;
      align-items:center;
      gap:10px;
    }

    .logo-img{
      width:32px;
      height:32px;
      background:white;
      border-radius:6px;
      padding:4px;
      box-shadow:0 2px 6px rgba(0, 0, 0, 0.1);
    }

    .logo-text h1{
      color:white;
      font-size:16px;
      font-weight:700;
      margin:0;
      line-height:1.2;
    }

    .logo-text p{
      color:rgba(255, 255, 255, 0.9);
      font-size:11px;
      font-weight:400;
      margin:0;
      line-height:1.2;
    }
    
    .header h3{
      font-size:16px;
      font-weight:700;
      margin:0;
      flex:1;
      color:#FFFFFF;
      letter-spacing:0.3px;
    }
    
    .header .btn{
      background:transparent;
      color:#FFFFFF;
      border:1px solid transparent;
      padding:8px 12px;
      border-radius:6px;
      font-size:12px;
      font-weight:500;
      cursor:pointer;
      transition:all 0.2s ease;
    }
    
    .header .btn:hover{
      background:rgba(255, 255, 255, 0.15);
      border:1px solid rgba(255, 255, 255, 0.3);
    }
    
    .header .btn:active{
      background:rgba(255, 255, 255, 0.2);
    }
    
    main{
      padding:10px;
      max-width:900px;
      margin:0 auto;
    }

    /* Secciones con dise√±o moderno */
    .section{
      background:#FFFFFF;
      border:1px solid #E2E8F0;
      border-radius:8px;
      padding:var(--pad);
      margin-bottom:5px;
      box-shadow:0 1px 3px rgba(0, 0, 0, 0.08), 0 1px 2px rgba(0, 0, 0, 0.04);
      transition:all 0.3s ease;
    }
    
    .section:hover{
      box-shadow:0 4px 12px rgba(0, 102, 204, 0.12), 0 2px 6px rgba(0, 102, 204, 0.06);
      border-color:#CBD5E1;
      transform:translateY(-2px);
    }
    
    .section h4{
      font-size:var(--fs-h);
      font-weight:700;
      margin:0 0 8px;
      color:#1E293B;
      border-bottom:2px solid #E2E8F0;
      padding-bottom:4px;
    }
    
    .field-row{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:var(--gap);
      margin-bottom:8px;
      padding:4px 6px;
      background:#F8FAFC;
      border-radius:6px;
      border:1px solid #E2E8F0;
    }
    
    .field-row label{
      min-width:100px;
      font-weight:500;
      color:#475569;
      font-size:var(--fs-base);
    }
    
    .input-text,.input-date,.input-number{
      padding:4px 6px;
      border:1px solid #CBD5E1;
      border-radius:6px;
      font-size:var(--fs-base);
      font-weight:500;
      color:#1E293B;
      min-width:120px;
      flex:1;
      background:#FFFFFF;
      transition:all 0.3s ease;
    }
    
    .input-text:focus,.input-date:focus,.input-number:focus{
      outline:none;
      border-color:var(--primary-color);
      box-shadow:0 0 0 3px rgba(0, 102, 204, 0.1);
      transform:translateY(-1px);
    }
    
    .note{
      font-size:var(--fs-sm);
      color:#64748B;
      font-style:italic;
      background:#F8FAFC;
      padding:4px 8px;
      border-radius:6px;
      border-left:3px solid var(--primary-color);
      margin-bottom:6px;
    }
    
    .switch{
      display:flex;
      align-items:center;
      gap:6px;
      margin-bottom:6px;
    }
    
    .switch input[type="checkbox"]{
      width:14px;
      height:14px;
      cursor:pointer;
    }
    
    .switch label{
      font-weight:600;
      color:#475569;
      cursor:pointer;
      font-size:var(--fs-base);
    }
    
    .hidden{
      display:none;
    }
    
    .print-only{
      display:none;
    }
    
    /* Tablas con dise√±o moderno */
    table{
      width:100%;
      border-collapse:collapse;
      font-size:var(--fs-base);
      margin-bottom:4px;
      border-radius:8px;
      overflow:hidden;
      box-shadow:0 1px 3px rgba(0, 0, 0, 0.08), 0 1px 2px rgba(0, 0, 0, 0.04);
    }
    
    th,td{
      border:1px solid #E2E8F0;
      padding:6px 8px;
      text-align:left;
      font-weight:500;
    }
    
    th{
      background:linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
      color:#FFFFFF;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.3px;
      font-size:var(--fs-base);
    }
    
    td{
      background:#FFFFFF;
      color:#1E293B;
    }
    
    tr:nth-child(even) td{
      background:#F8FAFC;
    }
    
    tr:hover td{
      background:#EFF6FF;
      transition:all 0.2s ease;
    }
    
    /* Botones con gradientes */
    .btn{
      background:linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
      color:#FFFFFF;
      border:none;
      padding:6px 10px;
      margin-top:2px;
      margin-right:4px;
      cursor:pointer;
      border-radius:6px;
      font-size:var(--fs-base);
      font-weight:600;
      letter-spacing:0.3px;
      transition:all 0.3s ease;
      box-shadow:0 2px 4px rgba(0, 102, 204, 0.2);
    }
    
    .btn:hover{
      background:linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-darker) 100%);
      transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(0, 102, 204, 0.3);
    }
    
    .btn:active{
      transform:translateY(0);
      box-shadow:0 2px 4px rgba(0, 102, 204, 0.2);
    }
    
    .btn-ghost{
      background:transparent;
      color:var(--primary-color);
      border:1px solid #CBD5E1;
      box-shadow:none;
    }
    
    .btn-ghost:hover{
      background:#EFF6FF;
      border-color:var(--primary-color);
      box-shadow:0 2px 6px rgba(0, 102, 204, 0.15);
    }
    
    .btn-ghost:active{
      background:#DBEAFE;
    }
    
    .btn-primary{
      background:linear-gradient(135deg, var(--success-color) 0%, var(--success-dark) 100%);
      box-shadow:0 2px 4px rgba(16, 185, 129, 0.2);
    }
    
    .btn-primary:hover{
      background:linear-gradient(135deg, var(--success-dark) 0%, #047857 100%);
      box-shadow:0 4px 12px rgba(16, 185, 129, 0.3);
    }
    
    .btn-primary:active{
      transform:translateY(0);
      box-shadow:0 2px 4px rgba(16, 185, 129, 0.2);
    }
    
    .resultado{
      margin-top:10px;
      padding:var(--pad);
      background:#FFFFFF;
      border-radius:8px;
      border:1px solid #E2E8F0;
      box-shadow:0 1px 3px rgba(0, 0, 0, 0.08), 0 1px 2px rgba(0, 0, 0, 0.04);
    }
    
    .resultado h5{
      font-size:var(--fs-h);
      font-weight:700;
      margin:8px 0 4px;
      color:#1E293B;
      border-bottom:2px solid #E2E8F0;
      padding-bottom:4px;
    }
    
    .resultado ul{
      margin:0 0 8px 18px;
      color:#475569;
      font-weight:500;
      list-style-type:disc;
    }
    
    .resultado ul li{
      margin-bottom:2px;
    }
    
    /* Mensajes de estado */
    .msg{
      margin:8px 0;
      padding:8px 10px;
      border-left:4px solid;
      border-radius:6px;
      background:#F7F7F7;
      font-weight:500;
    }
    
    .msg.error{
      border-color:var(--error-color);
      background:#FEE2E2;
      color:#991B1B;
    }
    
    .msg.success{
      border-color:var(--success-color);
      background:#D1FAE5;
      color:#065F46;
    }
    
    .msg.info{
      border-color:#3B82F6;
      background:#DBEAFE;
      color:#1E40AF;
    }

    /* Lado a lado para Datos + Fechas */
    .row-two{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:12px;
      align-items:flex-start;
    }
    
    .row-two>.section{
      flex:1 1 320px;
      margin-bottom:0;
    }

    /* Responsive */
    @media (max-width: 720px){
      .row-two{
        flex-direction:column;
      }
      
      .row-two>.section{
        flex:1 1 auto;
      }
      
      .field-row label{
        min-width:100px;
      }
      
      .input-text,.input-date,.input-number{
        min-width:0;
      }
    }

    @media (max-width: 768px){
      .header{
        flex-wrap:wrap;
        gap:8px;
      }
      
      .header h3{
        font-size:14px;
      }
      
      .header .btn{
        padding:5px 8px;
        font-size:10px;
      }
      
      .user-info{
        width:100%;
        order:10;
        margin-left:0;
      }
      
      .user-details{
        display:none;
      }
    }

    @media (max-width: 420px){
      :root{
        --fs-base:10px;
        --fs-sm:9px;
        --fs-h:12px;
        --pad:10px;
      }
      
      .header{
        padding:6px 10px;
      }
      
      .header h3{
        font-size:12px;
      }
      
      .header .btn{
        padding:4px 8px;
        font-size:9px;
      }
      
      .field-row{
        gap:6px;
        padding:4px;
      }
      
      .field-row label{
        min-width:92px;
      }
    }

    /* Estilos para informaci√≥n del usuario */
    .user-info{
      display:flex;
      align-items:center;
      gap:8px;
      background:rgba(255, 255, 255, 0.1);
      backdrop-filter:blur(10px);
      border:1px solid rgba(255, 255, 255, 0.2);
      border-radius:6px;
      padding:3px 8px;
      margin-left:auto;
      position:relative;
      height:32px;
    }
    
    .user-profile{
      display:flex;
      align-items:center;
      gap:8px;
    }
    
    .user-avatar{
      width:26px;
      height:26px;
      border-radius:50%;
      background:linear-gradient(135deg, #4168ea 0%, #1e40af 100%);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#FFFFFF;
      font-weight:600;
      font-size:12px;
      position:relative;
      overflow:hidden;
      flex-shrink:0;
    }
    
    .user-avatar img{
      width:100%;
      height:100%;
      object-fit:cover;
      border-radius:50%;
    }
    
    .user-details{
      display:flex;
      flex-direction:column;
      gap:0px;
      line-height:1.2;
    }
    
    .user-name{
      font-weight:600;
      color:#FFFFFF;
      font-size:12px;
      white-space:nowrap;
    }
    
    .user-email{
      color:rgba(255, 255, 255, 0.8);
      font-size:10px;
      white-space:nowrap;
    }
    
    .user-menu-btn{
      background:rgba(255, 255, 255, 0.1);
      border:1px solid rgba(255, 255, 255, 0.2);
      color:#FFFFFF;
      width:26px;
      height:26px;
      border-radius:50%;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:16px;
      transition:all 0.3s ease;
      flex-shrink:0;
    }
    
    .user-menu-btn:hover{
      background:rgba(255, 255, 255, 0.2);
      transform:scale(1.1);
      box-shadow:0 2px 8px rgba(0, 0, 0, 0.15);
    }
    
    .user-menu-btn:active{
      transform:scale(1.05);
    }
    
    /* Dropdown del usuario */
    .user-dropdown{
      position:absolute;
      top:100%;
      right:0;
      margin-top:8px;
      background:#FFFFFF;
      border-radius:10px;
      box-shadow:0 10px 30px rgba(0, 0, 0, 0.15);
      border:1px solid #E2E8F0;
      min-width:200px;
      z-index:1000;
      display:none;
    }
    
    .user-dropdown.show{
      display:block;
      animation:dropdownFadeIn 0.2s ease;
    }
    
    @keyframes dropdownFadeIn{
      from{
        opacity:0;
        transform:translateY(-10px);
      }
      to{
        opacity:1;
        transform:translateY(0);
      }
    }
    
    .user-dropdown-item{
      padding:12px 16px;
      cursor:pointer;
      transition:all 0.2s ease;
      display:flex;
      align-items:center;
      gap:10px;
      color:#1E293B;
      font-weight:500;
    }
    
    .user-dropdown-item:hover{
      background:#F8FAFC;
      transform:translateX(4px);
    }
    
    .user-dropdown-item:first-child{
      border-radius:10px 10px 0 0;
    }
    
    .user-dropdown-item:last-child{
      border-radius:0 0 10px 10px;
    }

    @media print{
      .header,button{
        display:none!important;
      }
      
      #resultadoExclusiones{
        page-break-before:always;
      }
      
      .print-only{
        display:block;
      }
      
      body{
        background:#fff;
      }
      
      .section{
        box-shadow:none;
        page-break-inside:avoid;
      }
      
      #resultadoResumen{
        page-break-inside:avoid;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="logo-section">
      <img src="logo.png" alt="LEXAR" class="logo-img" onerror="this.style.display='none'">
      <div class="logo-text">
        <h1>LEXAR</h1>
        <p>C√°lculo de Astreintes</p>
      </div>
    </div>
    <button onclick="window.location.href='dashboard.html'" class="btn btn-ghost" title="Volver al Dashboard">üè† Inicio</button>
    <button id="btnNuevo" class="btn">Nuevo</button>
    <button id="btnImprimir" class="btn">Imprimir</button>
    
    <!-- User Info -->
    <div class="user-info" id="userInfo">
      <div class="user-profile">
        <div class="user-avatar" id="userAvatar">
          <img id="userAvatarImg" src="" alt="Avatar" style="display: none;">
          <span id="userInitials">U</span>
        </div>
        <div class="user-details">
          <span class="user-name" id="userName">Usuario</span>
          <span class="user-email" id="userEmail">usuario@lexar.com</span>
        </div>
      </div>
      <button class="user-menu-btn" id="userMenuBtn">‚ãÆ</button>
      <div class="user-dropdown" id="userDropdown">
        <div class="user-dropdown-item" onclick="changeUserAvatar()">
          <span>üì∑</span>
          <span>Cambiar foto</span>
        </div>
        <div class="user-dropdown-item" onclick="logout()">
          <span>üö™</span>
          <span>Cerrar sesi√≥n</span>
        </div>
      </div>
    </div>
  </header>

  <!-- Encabezado para impresi√≥n -->
  <div id="printHeader" class="print-only hidden" style="padding:10px 12px;border-bottom:1px solid #ddd;margin:0 10px 10px"></div>

  <main>
    <div class="row-two">
      <section class="section">
        <h4>Datos del expediente</h4>
        <div class="field-row"><label for="caratula">Car√°tula</label><input id="caratula" class="input-text" type="text"/></div>
        <div class="field-row"><label for="numeroExpediente">Expediente</label><input id="numeroExpediente" class="input-text" type="text"/></div>
        <div class="field-row"><label for="juzgado">Juzgado</label><input id="juzgado" class="input-text" type="text"/></div>
      </section>

      <section class="section">
        <h4>Fechas del per√≠odo</h4>
        <div class="field-row"><label for="fechaInicio">Inicio</label><input id="fechaInicio" class="input-date" type="date"/></div>
        <div class="field-row"><label for="fechaFin">Corte</label><input id="fechaFin" class="input-date" type="date"/></div>
      </section>
    </div>

    <section class="section">
      <div class="switch"><input id="chkFerias" type="checkbox"/> <label for="chkFerias">Habilitar modificaci√≥n de ferias</label></div>
      <p class="note">Si no se habilita, se usan por defecto: 1 al 31 de enero, y 3er lunes de julio por 14 d√≠as.</p>
      <div id="feriasUI" class="hidden">
        <div class="field-row"><label for="veranoInicio">Verano desde</label><input id="veranoInicio" class="input-date" type="date"/> <label for="veranoFin" style="min-width:unset">hasta</label><input id="veranoFin" class="input-date" type="date"/></div>
        <div class="field-row"><label for="inviernoInicio">Invierno desde</label><input id="inviernoInicio" class="input-date" type="date"/> <label for="inviernoFin" style="min-width:unset">hasta</label><input id="inviernoFin" class="input-date" type="date"/></div>
      </div>
    </section>

    <section class="section">
      <div class="switch"><input id="chkTramos" type="checkbox"/> <label for="chkTramos">Habilitar tramos</label></div>
      <div id="tramosUI" class="hidden">
        <h4 style="margin-top:8px">Tramos de monto diario</h4>
        <table id="tramosTable"><thead><tr><th>Desde d√≠a</th><th>Hasta d√≠a</th><th>Monto diario</th><th></th></tr></thead><tbody></tbody></table>
        <button id="btnAddTramo" class="btn btn-ghost" type="button">Agregar tramo</button>
      </div>
      <div id="montoUnicoUI" class="field-row" style="margin-top:8px">
        <label for="montoUnico">Monto diario √∫nico</label><input id="montoUnico" class="input-number" type="number" step="0.01" placeholder="0,00"/>
      </div>
    </section>

    <section class="section">
      <h4>Exclusiones manuales</h4>
      <div class="switch"><input id="chkExclusiones" type="checkbox"/> <label for="chkExclusiones">Habilitar exclusiones manuales</label></div>
      <div id="exclusionesUI" class="hidden">
        <table id="exclusionesTable"><thead><tr><th>Fecha</th><th>Motivo</th><th></th></tr></thead><tbody></tbody></table>
        <button id="btnAddExclusion" class="btn btn-ghost" type="button">Agregar exclusi√≥n</button>
      </div>
    </section>

    <section class="section">
      <div id="msg" class="msg hidden"></div>
      <button id="btnCalcular" class="btn btn-primary" type="button">Calcular</button>
      <button id="btnImprimir2" class="btn" type="button">Imprimir</button>
      <div id="resultadoResumen" class="resultado"></div>
      <div id="resultadoExclusiones" class="resultado"></div>
    </section>
  </main>

  <script>
    const $ = (id) => document.getElementById(id);

    function showMsg(type, text){
      const box = $('msg');
      box.className = 'msg ' + (type||'info');
      box.textContent = text;
      box.classList.remove('hidden');
      box.scrollIntoView({behavior:'smooth', block:'center'});
    }
    function clearMsg(){ const box=$('msg'); box.textContent=''; box.classList.add('hidden'); }

    function calculateEasterDate(y){let a=y%19,b=Math.floor(y/100),c=y%100,d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25),g=Math.floor((b-f+1)/3),h=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4,l=(32+2*e+2*i-h-k)%7,m=Math.floor((a+11*h+22*l)/451),mo=Math.floor((h+l-7*m+114)/31),da=((h+l-7*m+114)%31)+1;return new Date(y,mo-1,da)}
    function getNationalHolidays(y){const H=[];H.push({date:new Date(y,0,1),name:'A√±o Nuevo'});H.push({date:new Date(y,2,24),name:'Memoria, Verdad y Justicia'});H.push({date:new Date(y,3,2),name:'Veteranos de Malvinas'});H.push({date:new Date(y,4,1),name:'D√≠a del Trabajador'});H.push({date:new Date(y,4,25),name:'Revoluci√≥n de Mayo'});H.push({date:new Date(y,5,20),name:'Belgrano'});H.push({date:new Date(y,6,9),name:'Independencia'});H.push({date:new Date(y,11,8),name:'Inmaculada Concepci√≥n'});H.push({date:new Date(y,11,25),name:'Navidad'});[{date:new Date(y,7,17),name:'San Mart√≠n'},{date:new Date(y,9,12),name:'Diversidad Cultural'},{date:new Date(y,10,20),name:'Soberan√≠a'},{date:new Date(y,5,17),name:'G√ºemes'}].forEach(it=>{const wd=it.date.getDay();let d=new Date(it.date);if(wd===2||wd===3){d.setDate(d.getDate()-(wd-1));}else if( wd===4||wd===5){d.setDate(d.getDate()+(8-wd));}H.push({date:d,name:it.name});});const eas=calculateEasterDate(y);const cm=new Date(eas);cm.setDate(cm.getDate()-48);const ct=new Date(eas);ct.setDate(ct.getDate()-47);const js=new Date(eas);js.setDate(js.getDate()-3);const vs=new Date(eas);vs.setDate(eas.getDate()-2);H.push({date:cm,name:'Carnaval'});H.push({date:ct,name:'Carnaval'});H.push({date:js,name:'Jueves Santo'});H.push({date:vs,name:'Viernes Santo'});return H}
    function getFeriaVerano(y){return {start:new Date(y,0,1),end:new Date(y,0,31)}}
    function getFeriaInvierno(y){const J=6;let d=new Date(y,J,1),m=0;while(true){if(d.getDay()===1){m++;if(m===3)break}d.setDate(d.getDate()+1)}const s=new Date(d),e=new Date(s);e.setDate(e.getDate()+13);return {start:s,end:e}}
    function fDate(d){return d.toISOString().split('T')[0]}
    function pDate(v){return v?new Date(v+'T00:00:00'):null}

    function addTramoRow(fromDay='',toDay='',monto=''){
      const tb=$('tramosTable').querySelector('tbody');
      const tr=document.createElement('tr');
      tr.innerHTML=`<td><input type=\"number\" min=\"1\" class=\"input-number tramo-from\" value=\"${fromDay}\"></td>
                     <td><input type=\"number\" min=\"1\" class=\"input-number tramo-to\" value=\"${toDay}\"></td>
                     <td><input type=\"number\" min=\"0\" step=\"0.01\" class=\"input-number tramo-monto\" value=\"${monto}\"></td>
                     <td><button type=\"button\" class=\"btn btn-ghost btn-remove-tramo\">Eliminar</button></td>`;
      tb.appendChild(tr);
    }
    function addExclusionRow(date='',motivo=''){
      const tb=$('exclusionesTable').querySelector('tbody');
      const tr=document.createElement('tr');
      tr.innerHTML=`<td><input type=\"date\" class=\"input-date exclusion-date\" value=\"${date}\"></td>
                     <td><input type=\"text\" class=\"input-text exclusion-motivo\" value=\"${motivo}\"></td>
                     <td><button type=\"button\" class=\"btn btn-ghost btn-remove-exclusion\">Eliminar</button></td>`;
      tb.appendChild(tr);
    }

    function initializeForm(){
      $('tramosTable').querySelector('tbody').innerHTML='';
      $('exclusionesTable').querySelector('tbody').innerHTML='';
      $('chkTramos').checked=false; $('tramosUI').classList.add('hidden'); $('montoUnicoUI').classList.remove('hidden');
      $('chkFerias').checked=false; $('feriasUI').classList.add('hidden');
      $('chkExclusiones').checked=false; $('exclusionesUI').classList.add('hidden');
      ['caratula','numeroExpediente','juzgado','fechaInicio','fechaFin','montoUnico'].forEach(id=>$(id).value='');
      const y=new Date().getFullYear();
      const v=getFeriaVerano(y), inv=getFeriaInvierno(y);
      $('veranoInicio').value=fDate(v.start);
      $('veranoFin').value=fDate(v.end);
      $('inviernoInicio').value=fDate(inv.start);
      $('inviernoFin').value=fDate(inv.end);
      $('resultadoResumen').innerHTML='';
      $('resultadoExclusiones').innerHTML='';
      clearMsg();
    }

    function validateTramos(tramos){
      const f=tramos.filter(t=>t.monto!==''&&t.fromDay!==null).sort((a,b)=>a.fromDay-b.fromDay);
      let lastEnd=0;for(const t of f){if(t.fromDay<=lastEnd) return 'Tramos superpuestos o desordenados.';if(t.toDay&&t.toDay<t.fromDay) return '"Hasta d√≠a" no puede ser menor que "Desde d√≠a".';lastEnd=t.toDay||Infinity}return null;
    }

    function buildHolidaysMap(startDate,endDate){
      const years=[]; for(let y=startDate.getFullYear(); y<=endDate.getFullYear(); y++) years.push(y);
      const map={}; years.forEach(y=>{
        getNationalHolidays(y).forEach(h=>{map[fDate(h.date)]=h.name});
        let d=getFeriaVerano(y), x=new Date(d.start); while(x<=d.end){map[fDate(x)]='Feria judicial de verano'; x.setDate(x.getDate()+1)}
        d=getFeriaInvierno(y); x=new Date(d.start); while(x<=d.end){map[fDate(x)]='Feria judicial de invierno'; x.setDate(x.getDate()+1)}
      });
      return map;
    }

    function overrideFeriaRange(map,start,end,label){ if(!start||!end) return; let d=new Date(start); while(d<=end){ map[fDate(d)]=label; d.setDate(d.getDate()+1) } }

    function calcular(){
      clearMsg();
      const startVal=$('fechaInicio').value, endVal=$('fechaFin').value;
      if(!startVal||!endVal){showMsg('error','Seleccione fecha de inicio y de corte.'); return}
      const startDate=pDate(startVal), endDate=pDate(endVal);
      if(!(startDate instanceof Date && !isNaN(startDate)) || !(endDate instanceof Date && !isNaN(endDate))){showMsg('error','Fechas inv√°lidas.');return}
      if(endDate<startDate){showMsg('error','La fecha de corte no puede ser anterior a la de inicio.'); return}

      let holidays=buildHolidaysMap(startDate,endDate);
      if($('chkFerias').checked){
        holidays=buildHolidaysMap(startDate,endDate);
        overrideFeriaRange(holidays,pDate($('veranoInicio').value),pDate($('veranoFin').value),'Feria judicial de verano');
        overrideFeriaRange(holidays,pDate($('inviernoInicio').value),pDate($('inviernoFin').value),'Feria judicial de invierno');
      }

      const manualEnabled=$('chkExclusiones').checked; const manualExcl={};
      if(manualEnabled){
        $('exclusionesTable').querySelectorAll('tbody tr').forEach(r=>{
          const dateVal=r.querySelector('.exclusion-date').value; const motivo=r.querySelector('.exclusion-motivo').value.trim()||'Exclusi√≥n manual';
          if(dateVal) manualExcl[dateVal]=motivo;
        });
      }

      const useTramos=$('chkTramos').checked; const tramos=[];
      if(useTramos){
        $('tramosTable').querySelectorAll('tbody tr').forEach(r=>{
          const fd=r.querySelector('.tramo-from').value, td=r.querySelector('.tramo-to').value, m=r.querySelector('.tramo-monto').value;
          const fromDay=fd?parseInt(fd):null, toDay=td?parseInt(td):null, monto=m!==''?parseFloat(m):null; if(fromDay!==null&&monto!==null) tramos.push({fromDay,toDay,monto});
        });
        const eMsg=validateTramos(tramos); if(eMsg){showMsg('error',eMsg); return}
        tramos.sort((a,b)=>a.fromDay-b.fromDay);
      } else {
        const m=parseFloat($('montoUnico').value||'0');
        if(!(m>0)){showMsg('error','Ingrese un monto diario √∫nico v√°lido (> 0).'); return}
        tramos.push({fromDay:1,toDay:null,monto:m});
      }

      let cur=new Date(startDate), dias=0, total=0, excl=[]; const det=tramos.map(t=>({tramo:t,dias:0,subtotal:0}));
      while(cur<=endDate){
        const s=fDate(cur), dow=cur.getDay(), weekend=(dow===6||dow===0), man=manualExcl[s], fer=holidays[s];
        if(man){excl.push({date:s,motivo:man});}
        else if(weekend){} else if(fer){excl.push({date:s,motivo:fer});}
        else{dias++; let montoDia=0; for(let i=0;i<tramos.length;i++){const t=tramos[i]; if(dias>=t.fromDay && (t.toDay===null || dias<=t.toDay)){montoDia=t.monto; det[i].dias++; det[i].subtotal+=t.monto; break;}} total+=montoDia;}
        cur.setDate(cur.getDate()+1);
      }

      let res='';
      res+='<h5>Datos</h5><ul>' + `<li>Car√°tula: ${$('caratula').value||'-'}</li><li>Expediente: ${$('numeroExpediente').value||'-'}</li><li>Juzgado: ${$('juzgado').value||'-'}</li></ul>`;
      res+='<h5>Per√≠odo</h5><ul>' + `<li>Inicio: ${startVal}</li><li>Corte: ${endVal}</li></ul>`;
      res+='<h5>Tramos/Monto</h5><ul>';
      tramos.forEach(t=>{const r=t.toDay?`${t.fromDay}-${t.toDay}`:`desde ${t.fromDay}`; res+=`<li>D√≠as ${r}: $${t.monto.toFixed(2)}</li>`});
      res+='</ul>';
      res+='<h5>Resultados</h5><ul>' + `<li>D√≠as h√°biles: ${dias}</li><li>Total astreintes: $${total.toFixed(2)}</li></ul>`;
      res+='<h5>Detalle por tramo</h5><ul>';
      det.forEach(d=>{const l=d.tramo.toDay?`${d.tramo.fromDay}-${d.tramo.toDay}`:`desde ${d.tramo.fromDay}`; res+=`<li>${l}: ${d.dias} d√≠as ‚Äî $${d.subtotal.toFixed(2)}</li>`});
      res+='</ul>';
      $('resultadoResumen').innerHTML=res;

      let exhtml=''; if(excl.length>0){ exhtml+='<h5>D√≠as excluidos</h5><ul>'; excl.forEach(it=>exhtml+=`<li>${it.date}: ${it.motivo}</li>`); exhtml+='</ul>'; }
      $('resultadoExclusiones').innerHTML=exhtml;
      showMsg('success','C√°lculo realizado. Pod√©s revisar el resumen debajo.');
    }

    function buildPrintHeader(){
      const h=$('printHeader');
      const now=new Date();
      const fmt=now.toLocaleString();
      const car=$('caratula').value||'-';
      const exp=$('numeroExpediente').value||'-';
      const juz=$('juzgado').value||'-';
      const ini=$('fechaInicio').value||'-';
      const fin=$('fechaFin').value||'-';
      h.innerHTML = `
        <div style=\"display:flex;align-items:center;gap:10px;\">
          <div><strong>LEXAR</strong></div>
          <div style=\"flex:1\"></div>
          <div style=\"font-size:12px;\">Impreso: ${fmt}</div>
        </div>
        <h2 style=\"margin:6px 0 4px;font-size:18px\">C√°lculo de Astreintes</h2>
        <div style=\"font-size:12px\">
          <div><strong>Car√°tula:</strong> ${car}</div>
          <div><strong>Expediente:</strong> ${exp}</div>
          <div><strong>Juzgado:</strong> ${juz}</div>
          <div><strong>Per√≠odo:</strong> ${ini} ‚Üí ${fin}</div>
        </div>
      `;
      h.classList.remove('hidden');
    }

    function imprimir(){
      const hasResultado = ($('resultadoResumen').innerHTML||'').trim().length>0;
      if(!hasResultado){
        calcular();
        const ok = ($('resultadoResumen').innerHTML||'').trim().length>0;
        if(!ok){ showMsg('error','Complet√° los campos m√≠nimos y toc√° Calcular antes de imprimir.'); return; }
      }
      buildPrintHeader();
      setTimeout(()=>window.print(), 50);
    }

    // ========== FUNCIONES DE USER INFO ==========
    
    // Funci√≥n para mostrar informaci√≥n del usuario
    function showUserInfo() {
      const userEmail = localStorage.getItem('lexar_user_email');
      if (userEmail) {
        const userInfo = $('userInfo');
        const userName = $('userName');
        const userEmailSpan = $('userEmail');
        const userInitials = $('userInitials');
        
        // Extraer nombre del email (antes del @)
        const name = userEmail.split('@')[0];
        const initials = name.substring(0, 2).toUpperCase();
        
        userName.textContent = name.charAt(0).toUpperCase() + name.slice(1);
        userEmailSpan.textContent = userEmail;
        userInitials.textContent = initials;
        
        userInfo.style.display = 'flex';
        loadUserAvatar();
      }
    }

    // Funci√≥n para cargar foto de perfil
    function loadUserAvatar() {
      const avatarImg = $('userAvatarImg');
      const userInitials = $('userInitials');
      
      // Intentar cargar foto desde localStorage
      const savedAvatar = localStorage.getItem('lexar_user_avatar');
      if (savedAvatar) {
        avatarImg.src = savedAvatar;
        avatarImg.style.display = 'block';
        userInitials.style.display = 'none';
      } else {
        avatarImg.style.display = 'none';
        userInitials.style.display = 'flex';
      }
    }

    // Funci√≥n para cambiar foto de perfil
    function changeUserAvatar() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(event) {
            const avatarImg = $('userAvatarImg');
            const userInitials = $('userInitials');
            
            avatarImg.src = event.target.result;
            avatarImg.style.display = 'block';
            userInitials.style.display = 'none';
            
            // Guardar en localStorage
            localStorage.setItem('lexar_user_avatar', event.target.result);
          };
          reader.readAsDataURL(file);
        }
      };
      input.click();
    }

    // Funci√≥n para cerrar sesi√≥n
    function logout() {
      if (confirm('¬øEst√°s seguro de que deseas cerrar sesi√≥n?')) {
        localStorage.removeItem('lexar_authenticated');
        localStorage.removeItem('lexar_user_email');
        window.location.href = 'index.html';
      }
    }

    document.addEventListener('DOMContentLoaded',()=>{
      initializeForm();
      
      // Inicializar user info
      showUserInfo();
      
      // Event listener para el dropdown del usuario
      const userMenuBtn = $('userMenuBtn');
      const userDropdown = $('userDropdown');
      
      if (userMenuBtn && userDropdown) {
        userMenuBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          userDropdown.classList.toggle('show');
        });

        // Cerrar dropdown al hacer clic fuera
        document.addEventListener('click', function(e) {
          if (!userMenuBtn.contains(e.target) && !userDropdown.contains(e.target)) {
            userDropdown.classList.remove('show');
          }
        });
      }
      
      $('btnNuevo').addEventListener('click',initializeForm);
      $('btnImprimir').addEventListener('click',imprimir);
      $('btnImprimir2').addEventListener('click',imprimir);
      $('chkTramos').addEventListener('change',e=>{ $('tramosUI').classList.toggle('hidden',!e.target.checked); $('montoUnicoUI').classList.toggle('hidden',e.target.checked); clearMsg(); });
      $('chkFerias').addEventListener('change',e=>{ $('feriasUI').classList.toggle('hidden',!e.target.checked); clearMsg(); });
      $('chkExclusiones').addEventListener('change',e=>{ $('exclusionesUI').classList.toggle('hidden',!e.target.checked); clearMsg(); });
      $('btnAddTramo').addEventListener('click',()=>{ addTramoRow(); clearMsg(); });
      $('tramosTable').querySelector('tbody').addEventListener('click',e=>{ if(e.target.classList.contains('btn-remove-tramo')) {e.target.closest('tr').remove(); clearMsg();} });
      $('btnAddExclusion').addEventListener('click',()=>{ addExclusionRow(); clearMsg(); });
      $('exclusionesTable').querySelector('tbody').addEventListener('click',e=>{ if(e.target.classList.contains('btn-remove-exclusion')) {e.target.closest('tr').remove(); clearMsg();} });
      $('btnCalcular').addEventListener('click',calcular);
    });
  </script>
</body>
</html>
