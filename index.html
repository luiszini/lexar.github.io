<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Computo derecho previsional</title>
  <style>
    body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  background: #f8f7ff;
  color: #202020;
  margin-left: 10px;
  margin-right: 10px;
  padding: 0;
  min-height: 100vh;
  font-size: 11px; /* máximo 11px */
  font-weight: 400; /* lighter weight */
    }
    #main-container {
  max-width: 900px;
    }
    h1 {
      font-size: 13px;
      font-weight: 600;
      margin: 0;
      text-align: left;
      color: #575757;
      padding: 5px;
      border: 1px solid #b6b2ff;
      box-shadow: 0 2px 4px rgba(139, 127, 255, 0.2);
    }
    
    /* Estilos del Header */
    .main-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      width: 100%;
      background: #e3e3e3;
      background: linear-gradient(180deg, rgba(227, 227, 227, 1) 0%, rgba(255, 255, 255, 1) 100%);
      border-bottom: 1px solid #858585;
      margin-bottom: 10px;
      z-index: 1000;
    }
    
    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 3px 10px;
      max-height: 30px;
    }
    
    .header-left {
      flex: 0 0 auto;
    }
    
    .header-center {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      max-width: 400px;
      margin: 0 20px;
      height: 100%;
      gap: 0;
    }
    
    .header-right {
      display: flex;
      align-items: center;
      flex: 0 0 auto;
      height: 100%;
    }
    
    .logo-section h1 {
      background: none;
      border: none;
      box-shadow: none;
      padding: 0;
      font-size: 16px;
    }
    
    /* Estilos de búsqueda */
    
    .search-input {
      flex: 1;
      padding: 4px 10px;
      border: 1px solid #858585;
      border-radius: 4px 0 0 4px;
      font-size: 12px;
      background: #858585;
      outline: none;
      height: 25px;
      box-sizing: border-box;
      display: flex;
      align-items: center;
      color: #858585;
    }
    
    .search-input:focus {
      background: #abcbda;
      border-color: #4f6fc7;
    }
    
    .search-btn {
      padding: 4px 12px;
      background: #858585;
      color: #858585;
      border: 1px solid #858585;
      border-radius: 0 4px 4px 0;
      cursor: pointer;
      font-size: 11px;
      height: 25px;
      box-sizing: border-box;
      transition: background-color 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .search-btn:hover {
      background: #abcbda;
      border: 1px solid #4f6fc7;
    }
    
    /* Estilos de navegación */
    .main-nav {
      display: flex;
      gap: 0;
    }
    
    .dropdown {
      position: relative;
      display: inline-block;
    }
    
    .dropdown-btn {
      background: transparent;
      color: #202020;
      border: none;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      transition: background-color 0.2s;
      border: 1px solid transparent;
    }
    
    .dropdown-btn:hover {
      background: #abcbda;
      border: 1px solid #4f6fc7;
    }
    
    .dropdown-content {
      display: none;
      position: absolute;
      background: white;
      min-width: 180px;
      border: 1px solid #858585;
      z-index: 1001; /* Por encima del header fijo */
      top: 100%;
      left: 0;
    }
    
    /* Posicionamiento especial para dropdowns del lado derecho */
    .dropdown:last-child .dropdown-content,
    .dropdown:nth-last-child(2) .dropdown-content {
      left: auto;
      right: 0;
    }
    
    .dropdown-content a {
      color: #202020;
      padding: 8px 12px;
      text-decoration: none;
      display: block;
      font-size: 11px;
      transition: background-color 0.2s;
      border: 1px solid transparent;
    }
    
    .dropdown-content a:hover {
      background: #abcbda;
      border: 1px solid #4f6fc7;
    }
    
    .dropdown-content hr {
      margin: 4px 0;
      border: none;
      border-top: 1px solid #e2e8f0;
    }
    
    .dropdown:hover .dropdown-content {
      display: block;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        gap: 10px;
        padding: 10px;
      }
      
      .header-center {
        margin: 0;
        max-width: 100%;
      }
      
      .main-nav {
        flex-wrap: wrap;
        justify-content: center;
      }
      
      .main-layout {
        margin-top: 80px; /* Más espacio en móviles para el header */
        margin-bottom: 100px; /* Más espacio en móviles para la barra de botones */
      }
    }
    fieldset {
      border: 1px solid #858585;
      background: #ffffff;
      padding: 10px;
      margin: 5px;
    }
    legend {
      font-weight: 600;
      font-size: 11px;
      color: #202020;
      background: #f0efff;
      border: 1px solid #858585;
    }
    label {
      display: block;
      font-size: 11px;
      color: #202020;
      font-weight: 500;
      margin-bottom: 4px;
    }
    input, select {
      font-size: 11px;
      outline: none;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      border: 1px solid #b3b3b3;
      background: #fff;
      color: #202020;
      padding: 3px 3px;
      transition: border-color 0.2s ease;
    }
    input:focus, select:focus {
      border-color: #003399;
      background: #f8f7ff;
    }
    .fieldset-main .grid input,
    .fieldset-main .grid select {
      width: 100%;
      box-sizing: border-box;
    }
    /* Fecha: más anchos por defecto y responsivos. Números mantienen tamaño reducido. */
    input[type="date"] {
      box-sizing: border-box;
      min-width: 120px;
      max-width: 120px;
      width: 100%;
    }
    input[type="number"] {
      max-width: 40px;
      min-width: 40px;
    }
  .grid { display: grid; gap: 0.2rem; }
    .g2 { grid-template-columns: repeat(2, 1fr); }
    .g3 { grid-template-columns: repeat(3, 1fr); }
    .muted { color: #2b2b2b; }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 4px;
      background: #fff;
      border: 1px solid #858585;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    th, td {
      border: 1px solid #858585;
      padding: 2px 4px;
      font-size: 11px;
    }
    th {
      background: #858585;
      color: #202020;
      font-weight: 600;
      text-align: left;
      font-size: 11px;
    }
    td {
      background: #fff;
    }
    tr.warn td { background: #fef3c7 !important; color: #92400e; }
    tr.ok td { background: #d1fae5 !important; color: #065f46; }
    tr.danger td { background: #fee2e2 !important; color: #991b1b; }
    tr.editing td { background: #dbeafe !important; color: #1e40af; }
    tr.newrow td { background: #e0e7ff !important; color: #3730a3; }
    tr:hover td { background: #f1f5f9; }
    tfoot td { font-weight: 600; background: #e2e8f0; color: #1e293b; }
    
    .btn {
      background: #858585;
      color: #202020;
      border: 1px solid #858585;
      font-weight: 500;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      font-size: 11px;
      padding: 6px;
      cursor: pointer;
      margin: 2px 4px 2px 0;
      transition: background-color 0.2s ease;
    }
    .btn:hover {
      background: #ffffff;
      border: 1px solid #858585;
    }
    .btn:active {
      background: #005a9e;
    }
    
    /* Estilos para indicadores de atajos de teclado */
    .btn {
      position: relative;
    }
    
    .shortcut-indicator {
      position: absolute;
      top: 2px;
      right: 2px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      font-size: 8.8px;
      padding: 1px 3px;
      border-radius: 2px;
      font-weight: bold;
      line-height: 1;
      z-index: 10;
    }
    .btn-main {
      min-width: 78px;
      min-height: 26px;
    }
    .row-actions {
      min-width: 60px;
      text-align: left;
    }
    .row-actions .btn {
  margin-right: 2px;
  min-width: 32px;
  height: 24px;
  width: 32px;
  padding: 0;
  font-size: 10px;
  line-height: 1;
  vertical-align: middle;
    }
    .row-actions .btn:last-child { margin-right: 0; }

    .pill {
      display: inline-block;
      padding: 4px 8px;
      background: #e2e8f0;
      color: #202020;
      font-size: 11px;
      margin-right: 6px;
      border: 1px solid #cbd5e1;
      font-weight: 500;
    }
    .pill.warn { background: #fef3c7; color: #92400e; border-color: #f59e0b; }
    .pill.ok { background: #d1fae5; color: #065f46; border-color: #10b981; }
    .pill.danger { background: #fee2e2; color: #991b1b; border-color: #ef4444; }
    
    .hidden { display: none; }
    .note { font-size: 10px; color: #7f8c8d; font-style: italic; }
    .inline { display: inline-block; margin-right: 10px; }
    details summary { cursor: pointer; }
    
    .tests small { color: #333; }
    .tests .btn { margin-right: 6px; margin-bottom: 6px; }
    
    pre#testLog {
      background: #fff;
      color: #222;
      padding: 2px;
      border: 1px solid #b0b0b0;
      max-height: 120px;
      overflow: auto;
      font-size: 11px;
    }
    .editing td, tr.editing td { background: #eaf6ff !important; }
    .cell-input {
      width: 100%;
      box-sizing: border-box;
      border: 1px solid #cbd5e1;
      background: #fff;
      outline: none;
      font-size: 11px;
      color: #1e293b;
      padding: 2px 4px;
      transition: border-color 0.2s ease;
    }
    .cell-input:focus {
      background: #f8fafc;
      border-color: #1e40af;
    }
    /* Inputs dentro de tablas: mimetizar con celdas */
    table .cell-input,
    table input[type="date"],
    table input[type="text"],
    table select {
      background: #fff;
      border: 1px solid #cbd5e1;
      padding: 2px 4px;
      margin: 0;
      font: inherit;
      color: #1e293b;
      outline: none;
      transition: border-color 0.2s ease;
    }
    table .cell-input:focus,
    table input[type="date"]:focus,
    table input[type="text"]:focus,
    table select:focus {
      background: #f8fafc;
      border-color: #1e40af;
    }
    .newrow td { background: #f6fff6 !important; }
    
    tr[data-tipo="Común"] td { border-left: 3px solid #003399; }
    tr[data-tipo="Insalubre"] td,
    tr[data-tipo="Privilegiado"] td,
    tr[data-tipo="Especial"] td { border-left: 3px solid #b0b0b0; }
    tr.warn td { border-left: 3px solid #b0b0b0 !important; }
    tr.editing td { border-left: 3px solid #003399 !important; }
    
    .main-layout {
      display: flex;
      flex-wrap: wrap;
      align-items: flex-start;
      margin-top: 60px; /* Espacio para el header superior */
      margin-bottom: 80px; /* Más espacio para la barra de botones inferior */
    }
    .fieldset-main {
      min-width: 300px;
    }
    .fieldset-side {
      min-width: 140px;
      max-width: 140px;
    }
  /* .datos-flex removed (no styles needed) */
    .datos-col1 {
      flex: 1 1 0px;
    }
    .datos-col2 {
      min-width: 220px;
      flex: 1 1 220px;
    }
    .datos-row {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
      max-width: 340px;
    }
    .datos-row label {
      width: 110px;
      margin-right: 4px;
    }
    .datos-col2 .datos-row label {
      width: 90px; /* reducir separación en la columna derecha */
    }
    /* Evitar que los date inputs en la columna derecha se expandan demasiado
       y que queden muy separados del label. */
    .datos-col2 .datos-row input[type="date"] {
      width: auto;
      box-sizing: border-box;
    }
    .datos-col2 .datos-row input {
      flex: 1;
    }
    .input-short {
      flex: 1 1 120px;
      max-width: 180px;
      min-width: 80px;
    }
    .action-bar {
      margin-top: 10px;
    }
    .pills-container {
      margin-top: 10px;
    }
    .derecho-actions {
      display:flex;
      gap:4px;
      align-items:center;
    }
    
    .derecho-actions-stacked {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 15px;
      align-items: center;
    }
    
    .derecho-actions-stacked .btn {
      flex: 1;
      min-width: 120px;
      margin: 0;
    }
    #resumen {
      margin-top: 12px;
    }

    @media (max-width: 900px) {
      .g3, .g2 { grid-template-columns: 1fr; }
      fieldset { padding: 6px 2px; }
      h1 { font-size: 10px; }
      th, td { font-size: 10px; }
      .datos-flex { flex-direction: column;}
      .datos-row { max-width: 100%; }
      .input-short { max-width: 100%; }
    }
    
    .custom-modal-backdrop {
      position: fixed; left: 0; top: 0; width: 100vw; height: 100vh;
      background: rgba(30, 41, 59, 0.8); z-index: 1000; display: flex; align-items: center; justify-content: center;
    }
    .custom-modal {
      background: #ffffff;
      min-width: 200px; max-width: 90vw;
      padding: 20px;
      border: 1px solid #cbd5e1;
      text-align: center;
      font-size: 11px;
      color: #1e293b;
      position: relative;
      animation: modalIn 0.2s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    @keyframes modalIn { from { opacity: 0; transform: translateY(20px);} to { opacity: 1; transform: translateY(0); } }
    .custom-modal-buttons { margin-top: 16px; display: flex; gap: 8px; justify-content: center; }
    .custom-modal .btn {
      min-width: 80px;
      padding: 8px 16px;
      font-size: 11px;
      border: 1px solid #1d4ed8;
      color: white;
    }
    
    
    /* Estilos específicos para modo claro - sobrescribir modo oscuro */
    select {
      background: white !important;
      border: 1px solid #858585 !important;
      color: #202020 !important;
    }
    
    select:focus {
      border-color: #003399 !important;
      box-shadow: 0 0 0 2px #2563eb;
    }
    
    /* Barra de botones de acción */
    .action-buttons-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      width: 100%;
      height: 60px;
      background: #f8fafc;
      border-top: 1px solid #858585;
      display: flex;
      flex-direction: row;
      gap: 8px;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }
    
    .action-btn {
      width: 80px;
      height: 44px;
      border: 1px solid #858585;
      background: #f1f5f9;
      color: #202020;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 8px;
      font-weight: 500;
      transition: background-color 0.2s;
      position: relative;
      text-align: center;
      line-height: 1.1;
      overflow: hidden;
      word-wrap: break-word;
    }
    
    .action-btn .icon {
      font-size: 14px;
      margin-bottom: 2px;
    }
    
    .action-btn .text {
      font-size: 9px;
      line-height: 1.1;
      text-align: center;
    }
    
    .action-btn:hover {
      background: #e2e8f0;
    }
    
    .action-btn-primary {
      background: #667eea;
      color: white;
      border-color: #2563eb;
    }
    
    .action-btn-primary:hover {
      background: #abcbda;
      border: 1px solid #003399;
    }
    
    /* Ajustar margen del contenido principal */
    body {
      padding-bottom: 80px; /* Más espacio para la barra de botones inferior */
      box-sizing: border-box;
    }
    
    
    
  </style>
</head>
<body>
  <!-- Header completo con menús desplegables -->
  <header class="main-header" id="mainHeader" style="display: none;">
    <div class="header-content">
      <div class="header-left">
        <div class="logo-section">
          <h1>LEX▲R - Cómputo de derecho Previsional</h1>
        </div>
      </div>
      
      <div class="header-center">
        <input type="text" id="searchInput" placeholder="Buscar cómputos guardados..." class="search-input">
        <button id="searchBtn" class="search-btn">🔍</button>
      </div>
      
      <div class="header-right">
      
      <div class="header-right">
        <nav class="main-nav">
          <!-- Menú Archivo -->
          <div class="dropdown">
            <button class="dropdown-btn">Archivo</button>
            <div class="dropdown-content">
              <a href="#" id="newComputation">Nuevo Cómputo</a>
              <a href="#" id="openComputation">Abrir Cómputo</a>
              <a href="#" id="saveComputation">Guardar Cómputo</a>
              <a href="#" id="manageComputations">🗂️ Gestionar Cómputos</a>
              <a href="#" id="exportPDF">Exportar PDF</a>
              <hr>
              <a href="#" id="exitApp">Salir</a>
            </div>
          </div>
          
          <!-- Menú Editar -->
          <div class="dropdown">
            <button class="dropdown-btn">Editar</button>
            <div class="dropdown-content">
              <a href="#" id="undoAction">Deshacer</a>
              <a href="#" id="redoAction">Rehacer</a>
              <hr>
              <a href="#" id="clearAll">Limpiar Todo</a>
              <a href="#" id="resetForm">Restablecer</a>
            </div>
          </div>
          
          <!-- Menú Ver -->
          <div class="dropdown">
            <button class="dropdown-btn">Ver</button>
            <div class="dropdown-content">
              <a href="#" id="togglePreview">Vista Previa</a>
              <a href="#" id="fullScreen">Pantalla Completa</a>
              <hr>
              <a href="#" id="zoomIn">Acercar</a>
              <a href="#" id="zoomOut">Alejar</a>
              <hr>
              <a href="#" id="toggleShortcuts">⌨️ Comandos de Teclado</a>
            </div>
          </div>
          
          <!-- Menú Herramientas -->
          <div class="dropdown">
            <button class="dropdown-btn">Herramientas</button>
            <div class="dropdown-content">
              <a href="#" id="calculator">Calculadora</a>
              <a href="#" id="dateCalculator">Calculadora de Fechas</a>
              <a href="#" id="converter">Convertidor</a>
              <hr>
              <a href="#" id="settings">Configuración</a>
            </div>
          </div>
          
          <!-- Menú Ayuda -->
          <div class="dropdown">
            <button class="dropdown-btn">Ayuda</button>
            <div class="dropdown-content">
              <a href="#" id="helpContent">Contenido de Ayuda</a>
              <a href="#" id="userGuide">Guía del Usuario</a>
              <a href="#" id="shortcuts">Atajos de Teclado</a>
              <hr>
              <a href="#" id="aboutApp">Acerca de LEX▲R</a>
            </div>
          </div>
        </nav>
      </div>
    </div>
    
    <div class="user-info" id="userInfo" style="display: none;">
      <div class="user-profile">
        <div class="user-avatar" id="userAvatar">
          <img id="userAvatarImg" src="" alt="Avatar" style="display: none;">
          <span id="userInitials">U</span>
        </div>
        <div class="user-details">
          <span class="user-name" id="userName">Usuario</span>
          <span class="user-email" id="userEmail">usuario@lexar.com</span>
        </div>
      </div>
      <button class="user-menu-btn" id="userMenuBtn">⋮</button>
      <div class="user-dropdown" id="userDropdown">
        <div class="user-dropdown-item" onclick="changeUserAvatar()">
          <span>📷</span>
          <span>Cambiar foto</span>
        </div>
        <div class="user-dropdown-item" onclick="logout()">
          <span>🚪</span>
          <span>Cerrar sesión</span>
        </div>
      </div>
    </div>
  </header>

  

  <!-- Barra de botones de acción -->
  <div class="action-buttons-bar" id="actionButtonsBar" style="display: none;">
    <button id="btnCalcular" type="button" class="action-btn action-btn-primary">
      <span class="icon">✅</span>
      <span class="text">Calcular</span>
    </button>
    <button id="btnPlanificacion" type="button" class="action-btn action-btn-primary">
      <span class="icon">🎯</span>
      <span class="text">Planificar</span>
    </button>
    <button id="btnImprimir" type="button" class="action-btn action-btn-primary">
      <span class="icon">🖨️</span>
      <span class="text">Imprimir</span>
    </button>
    <button id="btnExportResumen" type="button" class="action-btn">
      <span class="icon">📄</span>
      <span class="text">Exportar</span>
    </button>
    <button id="btnCopyResumen" type="button" class="action-btn">
      <span class="icon">📋</span>
      <span class="text">Copiar</span>
    </button>
  </div>

  <div class="main-layout" id="mainLayout" style="display: none;">
    <fieldset class="fieldset-main">
      <legend>Datos para el cálculo</legend>
      <div class="grid g3">
        <div>
          <label>Nombre</label>
          <input id="nombre" type="text" placeholder="Nombre y Apellido" />
        </div>
        <div>
          <label>CUIL</label>
          <input id="cuil" type="text" placeholder="##-########-#" />
        </div>
        <div>
          <label>Beneficio</label>
          <select id="beneficio">
            <option>Jubilación</option>
            <option>Pensión de PBU</option>
            <option>Retiro por Invalidez</option>
            <option>PUAM</option>
            <option>Prestación por edad avanzada</option>
          </select>
        </div>
        
        <!-- Campos específicos para PBU -->
        <div id="pbuFields" style="display:none;">
          <div>
            <label>Tipo de beneficiario</label>
            <select id="tipoBeneficiario">
              <option value="">Seleccionar...</option>
              <option value="conyuge">Cónyuge</option>
              <option value="conviviente">Conviviente</option>
              <option value="hijo">Hijo</option>
            </select>
          </div>
          <div id="convivienteFields" style="display:none;">
            <div>
              <label>Años de convivencia antes del fallecimiento</label>
              <input id="anosConvivencia" type="number" min="0" step="0.1" />
            </div>
            <div>
              <label>Tienen hijo reconocido por ambos</label>
              <select id="tienenHijoReconocido">
                <option value="no">No</option>
                <option value="si">Sí</option>
              </select>
            </div>
          </div>
          <div id="hijoFields" style="display:none;">
            <div>
              <label>Edad del hijo al momento del fallecimiento</label>
              <input id="edadHijoFallecimiento" type="number" min="0" max="18" />
            </div>
            <div>
              <label>Estado civil del hijo</label>
              <select id="estadoCivilHijo">
                <option value="soltero">Soltero</option>
                <option value="casado">Casado</option>
                <option value="divorciado">Divorciado</option>
                <option value="viudo">Viudo</option>
              </select>
            </div>
            <div>
              <label>Cobra otra prestación</label>
              <select id="cobraOtraPrestacion">
                <option value="no">No</option>
                <option value="si">Sí</option>
              </select>
            </div>
            <div>
              <label>Está incapacitado para trabajar</label>
              <select id="incapacitadoTrabajar">
                <option value="no">No</option>
                <option value="si">Sí</option>
              </select>
            </div>
          </div>
        </div>
        <div>
          <label>Sexo</label>
          <select id="sexo">
            <option value="M">Masculino</option>
            <option value="F">Femenino</option>
            <option value="X">Otro / No binario</option>
          </select>
        </div>
        <div>
          <label>Nacionalidad</label>
          <select id="nacionalidad">
            <option value="AR">Argentina</option>
            <option value="EX">Extranjera</option>
          </select>
        </div>
        <div id="boxIngresoPais">
          <label>Ingreso país (solo extranjeros)</label>
          <input id="fIngreso" type="date" />
        </div>
        <div id="boxNaturalizado" style="display:none;">
          <label>
            <input id="chkNaturalizado" type="checkbox" />
            Argentino naturalizado (requiere 10 años de residencia)
          </label>
        </div>
        <div>
          <label>F. nacimiento</label>
          <input id="fNac" type="date" />
        </div>
        <div>
          <label>F. fallecimiento</label>
          <input id="fFall" type="date" />
        </div>
        <div>
          <label>F. solicitud</label>
          <input id="fSol" type="date" />
        </div>
      </div>
    </fieldset>
    <fieldset id="boxD475" class="fieldset-side">
      <legend>Decreto 475/21</legend>
      <div class="grid g2">
        <div>
          <label>Hijos</label>
          <input id="hNacidos" type="number" value="0" min="0" />
        </div>
        <div>
          <label>Adop.</label>
          <input id="hAdoptados" type="number" value="0" min="0" />
        </div>
        <div>
          <label>Disc.</label>
          <input id="hDisc" type="number" value="0" min="0" />
        </div>
        <div>
          <label>AUH</label>
          <input id="hAUH" type="number" value="0" min="0" />
        </div>
      </div>
    </fieldset>
    <fieldset class="fieldset-side">
      <legend>Edad</legend>
      <div id="edadCalc" class="muted">Complete fecha de nacimiento para calcular.</div>
    </fieldset>
    
    <fieldset id="seccionAportes">
    <legend>Carga de aportes</legend>

    <div class="action-bar">
      <select id="moratoria" class="input-short" style="margin-right:12px">
        <option value="NINGUNA">Ninguna</option>
        <option value="24476">Moratoria Ley 24476</option>
        <option value="27705">Plan Ley 27705</option>
      </select>
  <button id="btnAutoMoratoria" type="button" class="btn btn-main">🔁 Cargar moratoria</button>
  <button id="btnQuitarMoratoria" type="button" class="btn btn-main">🧹 Quitar moratorias</button>
  <button id="btnRestoreD475" type="button" class="btn" style="margin-left:8px">♻️ Restaurar D.475/21</button>
  <button id="btnRestoreEX" type="button" class="btn" style="margin-left:6px">♻️ Restaurar Art. 19</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Fecha desde</th>
          <th>Fecha hasta</th>
          <th>Razón social</th>
          <th>Caja</th>
          <th>Tipo</th>
          <th>Edad req.</th>
          <th>Aportes req.</th>
          <th>Años</th>
          <th>Meses</th>
          <th>Días</th>
          <th>Acciones</th>
        </tr>
        <tr class="newrow">
          <td>➕</td>
          <td><input id="new-desde" class="cell-input" type="date"/></td>
          <td><input id="new-hasta" class="cell-input" type="date"/></td>
          <td><input id="new-razon" class="cell-input" type="text" placeholder="Empleador / Actividad"/></td>
          <td>
            <select id="new-caja" class="cell-input">
              <option>ANSES</option>
              <option>Provincia No Adherida</option>
              <option>Caja Profesional</option>
            </select>
          </td>
          <td>
            <select id="new-tipo" class="cell-input">
              <option>Común</option>
              <option>Insalubre</option>
              <option>Privilegiado</option>
              <option>Especial</option>
            </select>
          </td>
          <td><input id="new-edadreq" class="cell-input" type="number" min="0" value="0"/></td>
          <td><input id="new-apreq" class="cell-input" type="number" min="0" value="30"/></td>
          <td id="new-y">0</td>
          <td id="new-m">0</td>
          <td id="new-d">0</td>
          <td><button id="btnAddRow" type="button" class="btn">➕ Añadir</button></td>
        </tr>
      </thead>
      <tbody id="aportesBody"></tbody>
      <tfoot>
        <tr>
          <td colspan="8">Total aportes</td>
          <td id="totY">0</td>
          <td id="totM">0</td>
          <td id="totD">0</td>
          <td></td>
        </tr>
      </tfoot>
    </table>

    <div class="pills-container">
      <span class="pill" id="pill475">D. 475/2021: <b><span id="cred475Y">0</span></b> años</span>
      <span class="pill" id="pillExceso">Art. 19: <b><span id="credExY">0</span> años</b> <b><span id="credExM">0</span> meses</b> <b><span id="credExD">0</span> días</b></span>
      <span class="pill" id="pillInsalubre">Compensación insalubre: <b><span id="credInsY">0</span> años</b> <b><span id="credInsM">0</span> meses</b> <b><span id="credInsD">0</span> días</b></span>
    </div>
  </fieldset>

    <fieldset id="seccionDerecho" style="display: none;">
      <legend>Derecho</legend>
      
      <!-- Opciones de cálculo -->
      <div style="margin-top: 15px; padding: 10px; background: #f8fafc; border-radius: 5px; border: 1px solid #e2e8f0; display: none;">
        <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
          <input type="checkbox" id="chkProrrateo" style="margin: 0;">
          <span style="font-weight: 600; color: #374151;">Aplicar prorrateo ANSES para regímenes especiales (se activa automáticamente)</span>
        </label>
      </div>
      
      <div id="resumen"></div>
      
      <!-- Contenedor para la planificación -->
      <div id="planificacion" style="margin-top: 15px;"></div>
    </fieldset>
  </div>

  <!-- Modal de Login -->
  <div id="loginModal" class="modal" style="display: block; background: rgba(0, 0, 0, 0.5);">
    <div class="modal-content login-modal">
      <div class="login-container">
        <div class="login-header">
          <div class="login-logo">
            <h1>LEX▲R</h1>
            <p>Cómputo de derecho Previsional</p>
          </div>
        </div>
        <div class="login-form-container">
          <h2>🔐 Iniciar Sesión</h2>
          <form id="loginForm">
            <div class="form-group">
              <label for="email">Correo Electrónico:</label>
              <input type="email" id="email" name="email" placeholder="usuario@lexar.com" required>
            </div>
            <div class="form-group">
              <label for="password">Contraseña:</label>
              <input type="password" id="password" name="password" placeholder="••••••••" required>
            </div>
            <div class="form-actions">
              <button type="submit" class="btn btn-primary login-btn">
                <span class="btn-icon">🔑</span>
                Iniciar Sesión
              </button>
            </div>
          </form>
          <div id="loginError" class="error-message" style="display: none;"></div>
        </div>
        <div class="login-footer">
          <p>Sistema de cómputo previsional profesional</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal HTML -->
  <div id="customModalBackdrop" class="custom-modal-backdrop" style="display:none;">
    <div class="custom-modal" id="customModalBox">
      <div id="customModalMsg"></div>
      <div class="custom-modal-buttons" id="customModalBtns"></div>
    </div>
  </div>

  <script>
    // ================= Utilidades de fechas (convención 360/30) =================
    function parseISO(d){
      if(!d) return null;
      // Si ya tiene hora, usar normal. Si es solo fecha, agregar T12:00:00 para evitar desfase por zona horaria
      if (/^\d{4}-\d{2}-\d{2}$/.test(d)) {
        d = d + 'T12:00:00';
      }
      const x = new Date(d);
      return isNaN(x) ? null : x;
    }
  function fmtDMY2(date){ if(!date) return ''; const dd=String(date.getDate()).padStart(2,'0'); const mm=String(date.getMonth()+1).padStart(2,'0'); const yy=String(date.getFullYear()%100).padStart(2,'0'); return `${dd}.${mm}.${yy}`; }
  function fmtDMY4(date){ if(!date) return ''; const dd=String(date.getDate()).padStart(2,'0'); const mm=String(date.getMonth()+1).padStart(2,'0'); const yyyy=String(date.getFullYear()); return `${dd}.${mm}.${yyyy}`; }
    function toInputDate(date){ if(!date) return ''; const y=date.getFullYear(); const m=String(date.getMonth()+1).padStart(2,'0'); const d=String(date.getDate()).padStart(2,'0'); return `${y}-${m}-${d}` }
    function diff360(d1, d2){
      if(!d1||!d2) return {y:0,m:0,d:0,totalDays:0};
      let a=new Date(d1.getTime()), b=new Date(d2.getTime());
      if(a>b){const t=a;a=b;b=t}
      let dA=a.getDate(), mA=a.getMonth()+1, yA=a.getFullYear();
      let dB=b.getDate(), mB=b.getMonth()+1, yB=b.getFullYear();
      // Convención: todos los meses 30 días, todos los años 360 días
      if(dA>30) dA=30;
      if(dB>30) dB=30;
      // Sumar 1 día para que ambos extremos sean inclusivos
      let days = (yB-yA)*360 + (mB-mA)*30 + (dB-dA) + 1;
      if(days<0) days=0;
      let y = Math.floor(days/360);
      days %= 360;
      let m = Math.floor(days/30);
      let d = days%30;
      return {y,m,d,totalDays:(y*360+m*30+d)};
    }
    function sumYMD(a,b){ let y=a.y+b.y, m=a.m+b.m, d=a.d+b.d; while(d>=30){d-=30;m++} while(m>=12){m-=12;y++} return {y,m,d} }
    function cmpRanges(r1, r2){ 
      const oneDay=86400000; 
      // Dos rangos se superponen si: r1.desde <= r2.hasta && r2.desde <= r1.hasta
      return (r1.desde.getTime() <= r2.hasta.getTime() + oneDay) && (r2.desde.getTime() <= r1.hasta.getTime() + oneDay); 
    }
    function subtractRanges(base, blockers){
      let pieces=[{desde:new Date(base.desde), hasta:new Date(base.hasta)}];
      for(const b of blockers){
        const nxt=[];
        for(const p of pieces){
          if(p.hasta<b.desde || p.desde>b.hasta){ nxt.push(p); continue }
          // Si hay parte antes del bloqueador
          if(p.desde<b.desde){
            nxt.push({desde:p.desde, hasta:new Date(b.desde.getTime()-1*86400000)}); // hasta el día anterior al bloqueador
          }
          // Si hay parte después del bloqueador
          if(p.hasta>b.hasta){
            nxt.push({desde:new Date(b.hasta.getTime()+1*86400000), hasta:p.hasta}); // desde el día siguiente al bloqueador
          }
        }
        pieces=nxt.filter(x=>x.desde<=x.hasta);
      }
      return pieces;
    }

  // ================= Estado =================
  const state = { aportes: [], seq: 1, computedDisabled: { D475:false, EX:false } }
  
  // Variable para rastrear el cómputo que se está editando
  let editingComputationId = null;
    const $ = sel => document.querySelector(sel);

// Lista de tipos de servicio (usada en selects)
const SERVICE_TYPES = [
'Común',
'Autónomo Común',
'Trabajo riesgoso o insalubre',
'Minería subterránea',
'Laminación / acería / fundición (ambiente penoso/insalubre)',
'Forja y fragua',
'Electricidad (servicios eléctricos – tareas riesgosas)',
'Aeronavegantes (personal de vuelo)',
'Industria de la Construcción',
'Trabajador/a agrario/a',
'Casas particulares',
'Docente común (con 10 años al frente)',
'Docente común (sin reducción)',
'Docente universitario',
'Investigadores científicos/tecnológicos',
'Poder Judicial y Ministerio Público',
'Estibadores portuarios',
'Capataces de estibadores portuarios',
'Amarradores de barcazas (sistema de empuje)',
'Dragado y balizamiento (personal embarcado)',
'Personal de ferrobarcos (FFCC Argentinos)',
'Señaleros ferroviarios',
'Petróleo y gas (boca de pozo / campaña)'
];

// Reglas por tipo (edad y aportes requeridos). Valores por sexo cuando aplica.
const SERVICE_RULES = {
  'Común': { default: () => ({edad: edadRequeridaBase(), ap: 30}) },
  'Autónomo Común': { M: {edad:65, ap:30}, F: {edad:60, ap:30} },
  'Trabajo riesgoso o insalubre': { M: {edad:55, ap:30}, F: {edad:52, ap:30} },
  'Minería subterránea': { default:{edad:50,ap:25} },
  'Laminación / acería / fundición (ambiente penoso/insalubre)': { default:{edad:50,ap:25} },
  'Forja y fragua': { default:{edad:50,ap:25} },
  'Electricidad (servicios eléctricos – tareas riesgosas)': { default:{edad:55,ap:30} },
  'Aeronavegantes (personal de vuelo)': { default:{edad:50,ap:30} },
  'Industria de la Construcción': { default:{edad:55,ap:25} },
  'Trabajador/a agrario/a': { default:{edad:57,ap:25} },
  'Casas particulares': { M:{edad:65,ap:30}, F:{edad:60,ap:30} },
  'Docente común (con 10 años al frente)': { M:{edad:60,ap:25}, F:{edad:57,ap:25} },
  'Docente común (sin reducción)': { M:{edad:60,ap:30}, F:{edad:57,ap:30} },
  'Docente universitario': { M:{edad:65,ap:25}, F:{edad:60,ap:25} },
  'Investigadores científicos/tecnológicos': { M:{edad:65,ap:30}, F:{edad:60,ap:30} },
  'Poder Judicial y Ministerio Público': { M:{edad:65,ap:30}, F:{edad:60,ap:30} },
  'Estibadores portuarios': { default:{edad:52,ap:30} },
  'Capataces de estibadores portuarios': { default:{edad:55,ap:30} },
  'Amarradores de barcazas (sistema de empuje)': { default:{edad:52,ap:25} },
  'Dragado y balizamiento (personal embarcado)': { default:{edad:52,ap:25} },
  'Personal de ferrobarcos (FFCC Argentinos)': { default:{edad:52,ap:25} },
  'Señaleros ferroviarios': { default:{edad:55,ap:30} },
  'Petróleo y gas (boca de pozo / campaña)': { default:{edad:50,ap:25} }
};

function getRequirementsFor(tipo, sex, fechaAporte = null){
  if(!tipo) return {edad: edadRequeridaBase(), ap: 30};
  
  // Caso especial: Industria de la Construcción (Ley 22.250)
  if(tipo === 'Industria de la Construcción'){
    return getRequirementsConstruccion(sex, fechaAporte);
  }
  
  const rule = SERVICE_RULES[tipo];
  if(!rule) return {edad: edadRequeridaBase(), ap: 30};
  if(typeof rule.default === 'function'){
    const d = rule.default();
    return {edad: d.edad, ap: d.ap};
  }
  if(sex && rule[sex]) return {edad: rule[sex].edad, ap: rule[sex].ap};
  if(rule.default) return {edad: rule.default.edad, ap: rule.default.ap};
  return {edad: edadRequeridaBase(), ap:30};
}

// Función especial para construcción según Ley 22.250
function getRequirementsConstruccion(sexo, fechaAporte = null){
  if(sexo === 'F'){
    // Para mujeres: 55 años desde el 1/5/2009
    return {edad: 55, ap: 25};
  } else {
    // Para hombres: edad variable según el período de aportes
    let fechaReferencia = fechaAporte;
    
    // Si no se proporciona fecha específica, buscar el período más reciente
    if(!fechaReferencia){
      const aportesConstruccion = state.aportes.filter(p => 
        !p.esCredito && 
        !p.esMoratoria && 
        p.tipo === 'Industria de la Construcción' &&
        p.desde && p.hasta
      );
      
      if(aportesConstruccion.length === 0){
        return {edad: 55, ap: 25};
      }
      
      // Encontrar el período más reciente
      for(const aporte of aportesConstruccion){
        if(!fechaReferencia || aporte.hasta > fechaReferencia){
          fechaReferencia = aporte.hasta;
        }
      }
    }
    
    if(!fechaReferencia) return {edad: 55, ap: 25};
    
    // Determinar la edad requerida según el período de aportes
    const fecha2009 = new Date(2009, 4, 1); // 1/5/2009
    const fecha2010 = new Date(2010, 4, 1); // 1/5/2010
    const fecha2011 = new Date(2011, 4, 1); // 1/5/2011
    const fecha2012 = new Date(2012, 4, 1); // 1/5/2012
    
    if(fechaReferencia >= fecha2009 && fechaReferencia < fecha2010){
      // Del 1/5/2009 al 30/4/2010: 60 años
      return {edad: 60, ap: 25};
    } else if(fechaReferencia >= fecha2010 && fechaReferencia < fecha2011){
      // Del 1/5/2010 al 30/4/2011: 57 años
      return {edad: 57, ap: 25};
    } else if(fechaReferencia >= fecha2011 && fechaReferencia < fecha2012){
      // Del 1/5/2011 al 30/4/2012: 56 años
      return {edad: 56, ap: 25};
    } else if(fechaReferencia >= fecha2012){
      // Desde el 1/5/2012: 55 años
      return {edad: 55, ap: 25};
    } else {
      // Si los aportes son anteriores a 2009, usar 55 años
      return {edad: 55, ap: 25};
    }
  }
}

    function render(){
      // Ensure computed credits (D.475 / exceso de edad) are present as regular rows
      syncComputedRows();
  state.aportes.sort((a,b)=> ((a.desde? a.desde.getTime():0) - (b.desde? b.desde.getTime():0)) || a.id-b.id);
      const tbody=$('#aportesBody'); tbody.innerHTML='';
      for(let i=0;i<state.aportes.length;i++){
        const p=state.aportes[i];
        const tr=document.createElement('tr');
        tr.setAttribute('data-id', String(p.id));
        if(p.esMoratoria) tr.classList.add('warn');
        if(p._editing){
          tr.classList.add('editing');
          tr.innerHTML = `
            <td>${i+1}</td>
            <td><input class="cell-input" type="date" value="${toInputDate(p.desde)}" data-field="desde"/></td>
            <td><input class="cell-input" type="date" value="${toInputDate(p.hasta)}" data-field="hasta"/></td>
            <td><input class="cell-input" type="text" value="${p.razon||''}" data-field="razon"/></td>
            <td>
              <select class="cell-input" data-field="caja">
                ${['ANSES','Provincia No Adherida','Caja Profesional'].map(v=>`<option ${p.caja===v?'selected':''}>${v}</option>`).join('')}
              </select>
            </td>
            <td>
              <select class="cell-input" data-field="tipo">
                ${SERVICE_TYPES.map(v=>`<option value="${v}" ${p.tipo===v?'selected':''}>${v}</option>`).join('')}
              </select>
            </td>
            <td><input class="cell-input" type="number" min="0" value="${p.edadReq||0}" data-field="edadReq"/></td>
            <td><input class="cell-input" type="number" min="0" value="${p.apReq||30}" data-field="apReq"/></td>
            <td colspan="3" class="dur-cell">${p.ymd.y}a ${p.ymd.m}m ${p.ymd.d}d</td>
            <td class="row-actions">
              <button type="button" data-act="save" data-id="${p.id}">💾</button>
              <button type="button" data-act="cancel" data-id="${p.id}">↩️</button>
              <button type="button" data-act="del" data-id="${p.id}">🗑️</button>
            </td>`;
        } else {
          tr.innerHTML = `
            <td>${i+1}</td>
            <td>${fmtDMY4(p.desde)}</td>
            <td>${fmtDMY4(p.hasta)}</td>
            <td>${p.razon||''}</td>
            <td>${p.caja||''}</td>
            <td>${p.tipo||''}</td>
            <td>${(() => {
              if(p.tipo === 'Industria de la Construcción'){
                const reqs = getRequirementsFor(p.tipo, $('#sexo').value, p.hasta);
                return reqs.edad;
              }
              return (p.edadReq!=null?p.edadReq:'');
            })()}</td>
            <td>${(() => {
              if(p.tipo === 'Industria de la Construcción'){
                const reqs = getRequirementsFor(p.tipo, $('#sexo').value, p.hasta);
                return reqs.ap;
              }
              return (p.apReq!=null?p.apReq:'');
            })()}</td>
            <td>${p.ymd.y}</td>
            <td>${p.ymd.m}</td>
            <td>${p.ymd.d}</td>
            <td class="row-actions">
              <button data-act="edit" data-id="${p.id}" type="button">✏️</button>
              <button data-act="del" data-id="${p.id}" type="button">🗑️</button>
            </td>`;
        }
        tbody.appendChild(tr);
      }


      // Totales: sumamos todas las filas efectivas en state.aportes (las filas computadas ya están sincronizadas allí)
      const tot = state.aportes.reduce((acc,p)=>sumYMD(acc,p.ymd),{y:0,m:0,d:0});
      $('#totY').textContent=tot.y; $('#totM').textContent=tot.m; $('#totD').textContent=tot.d;
      update475Pill(); updateExcesoPill(); updateInsalubrePill(); updateEdadActual();
      
      // Detectar automáticamente regímenes especiales y activar/desactivar prorrateo
      activarProrrateoAutomatico();
    }

    function periodoYMD(desde, hasta){ return diff360(desde, hasta) }

    function tieneSolapamiento(nuevo, ignorarId){
      for(const p of state.aportes){
        if(ignorarId && p.id===ignorarId) continue;
        // ignorar aportes sin fechas completas o beneficios generados
        if(!p.desde || !p.hasta) continue;
        if(p.esCredito) continue;
        if(cmpRanges({desde:p.desde,hasta:p.hasta}, nuevo)) return true;
      }
      return false;
    }

    async function pedirAutoFix(nuevo){
  const overl = state.aportes.filter(p=>p.desde && p.hasta && !p.esCredito && cmpRanges({desde:p.desde,hasta:p.hasta}, nuevo));
      const ans = await showConfirmModal(`Se detectaron períodos superpuestos. ¿Desea que el sistema ajuste automáticamente el nuevo período para evitar superposición?\n(Cancelar = editar manualmente).`);
      if(!ans) return null;
      let res=[{desde:new Date(nuevo.desde), hasta:new Date(nuevo.hasta)}];
      for(const p of overl){
        const parts=[];
        for(const r of res){
          const cut = subtractRanges(r, [{desde:p.desde, hasta:p.hasta}]);
          for(const c of cut) parts.push(c);
        }
        res=parts;
      }
      if(res.length===0) return null;
      res.sort((a,b)=> (b.hasta-b.desde)-(a.hasta-a.desde));
      const fixed=res[0];
      await showModal(`Período ajustado automáticamente a: ${fmtDMY2(fixed.desde)} a ${fmtDMY2(fixed.hasta)}.`);
      return fixed;
    }

    // ============ Aportes adicionales ==========
    function computeAporte475(){ if($('#sexo').value!=='F') return {y:0,m:0,d:0}; const n=+($('#hNacidos').value||0), a=+($('#hAdoptados').value||0), d=+($('#hDisc').value||0), auh=+($('#hAUH').value||0); return {y:n+a+d+auh,m:0,d:0} }
    function update475Pill(){ const c=computeAporte475(); $('#cred475Y').textContent=c.y }

    function edadRequeridaBase(){ const sexo=$('#sexo').value, ben=$('#beneficio').value; if(ben==='PUAM') return 65; if(ben==='Prestación por edad avanzada') return 70; if(ben==='Retiro por Invalidez') return 0; return (sexo==='F'?60:65) }
    function edadRequeridaYMD(){ const edad = edadRequeridaBase(); return {y:edad, m:0, d:0}; }
    function evalDate(){ return parseISO($('#fSol').value) || new Date() }
    function computeExcesoEdad(){ 
      const fN=parseISO($('#fNac').value), fS=evalDate(); 
      if(!fN) return {y:0,m:0,d:0}; 
      
      // Para Retiro por Invalidez, no hay exceso de edad
      const beneficio = $('#beneficio').value;
      if (beneficio === 'Retiro por Invalidez') {
        return {y:0,m:0,d:0};
      }
      
      // Verificar si hay prorrateo ANSES habilitado
      const usarProrrateo = $('#chkProrrateo').checked;
      if (usarProrrateo) {
        const prorrateoInfo = calcularProrrateo();
        if (prorrateoInfo && (prorrateoInfo.tipo === 'prorrateado_anses' || prorrateoInfo.tipo === 'prorrateado_anses_multi')) {
          // Si hay compensación del prorrateo ANSES, usarla
          if (prorrateoInfo.compensacion && (prorrateoInfo.compensacion.y > 0 || prorrateoInfo.compensacion.m > 0 || prorrateoInfo.compensacion.d > 0)) {
            return prorrateoInfo.compensacion;
          }
        }
      }
      
      // Cálculo tradicional de exceso de edad
      const req=edadRequeridaBase(); 
      const fechaReq=new Date(fN); 
      fechaReq.setFullYear(fechaReq.getFullYear()+req); 
      if(fS<=fechaReq) return {y:0,m:0,d:0}; 
      const exc=diff360(fechaReq,fS); 
      // Convertir excedente completo a días, dividir por 2, y convertir de vuelta
      const totalDiasExcedente = (exc.y * 360) + (exc.m * 30) + exc.d;
      const compensacionDias = Math.floor(totalDiasExcedente / 2);
      
      // Convertir días de compensación de vuelta a años, meses y días
      const compensacionAños = Math.floor(compensacionDias / 360);
      const diasRestantes = compensacionDias % 360;
      const compensacionMeses = Math.floor(diasRestantes / 30);
      const compensacionDiasFinal = diasRestantes % 30;
      
      return {
        y: compensacionAños,
        m: compensacionMeses,
        d: compensacionDiasFinal
      } 
    }
    function updateExcesoPill(){ const c=computeExcesoEdad(); $('#credExY').textContent=c.y; $('#credExM').textContent=c.m; $('#credExD').textContent=c.d }
    function updateInsalubrePill(){ const c=calcularCompensacionInsalubre(); $('#credInsY').textContent=c.y; $('#credInsM').textContent=c.m; $('#credInsD').textContent=c.d }
    
    // Actualizar requisitos en todas las filas de la tabla
    function updateRequirementsInTable(){
      const sexo = $('#sexo').value;
      
      // Actualizar fila nueva
      const tipoNuevo = document.getElementById('new-tipo').value;
      if(tipoNuevo){
        const fechaNueva = parseISO(document.getElementById('new-hasta').value);
        const reqsNuevo = getRequirementsFor(tipoNuevo, sexo, fechaNueva);
        document.getElementById('new-edadreq').value = reqsNuevo.edad;
        document.getElementById('new-apreq').value = reqsNuevo.ap;
      }
      
      // Actualizar filas existentes en modo edición
      const filasEdicion = document.querySelectorAll('#aportesBody tr.editing');
      filasEdicion.forEach(fila => {
        const tipoSelect = fila.querySelector('select[data-field="tipo"]');
        if(tipoSelect){
          const tipo = tipoSelect.value;
          const fechaInput = fila.querySelector('input[data-field="hasta"]');
          const fechaAporte = fechaInput ? parseISO(fechaInput.value) : null;
          const reqs = getRequirementsFor(tipo, sexo, fechaAporte);
          
          const edadReqInput = fila.querySelector('input[data-field="edadReq"]');
          const apReqInput = fila.querySelector('input[data-field="apReq"]');
          
          if(edadReqInput) edadReqInput.value = reqs.edad;
          if(apReqInput) apReqInput.value = reqs.ap;
        }
      });
    }

    // Sincroniza las filas computadas (D.475 y Exceso de edad) como aportes generados en state.aportes
    function syncComputedRows(){
      // D.475 (si el usuario no lo deshabilitó)
      const c475 = computeAporte475();
      const ymd475 = {y:c475.y||0, m:c475.m||0, d:c475.d||0};
      let found475 = state.aportes.find(p=>p.generatedType==='D475');
      if(!state.computedDisabled.D475){
        if(!found475){
          found475 = { id: state.seq++, desde:null, hasta:null, razon:'D.475/21', caja:'ANSES', tipo:'Común', edadReq:'', apReq:'', ymd:ymd475, generatedType:'D475', esCredito:true };
          state.aportes.push(found475);
        } else {
          found475.razon = 'D.475/21';
          found475.caja = 'ANSES';
          found475.tipo = 'Común';
          found475.ymd = ymd475;
        }
      } else if(found475){
        // eliminada por el usuario, mantener eliminada
        state.aportes = state.aportes.filter(p=>p.generatedType!=='D475');
      }

      // Exceso de edad (siempre presente)
      const cEx = computeExcesoEdad();
      const ymdEx = {y:cEx.y||0, m:cEx.m||0, d:cEx.d||0};
      let foundEx = state.aportes.find(p=>p.generatedType==='EX');
      
      // Determinar si la compensación viene del prorrateo ANSES
      const usarProrrateo = $('#chkProrrateo').checked;
      let razonExcedente = 'Art.19 Ley 24241';
      if (usarProrrateo) {
        const prorrateoInfo = calcularProrrateo();
        if (prorrateoInfo && (prorrateoInfo.tipo === 'prorrateado_anses' || prorrateoInfo.tipo === 'prorrateado_anses_multi')) {
          if (prorrateoInfo.compensacion && (prorrateoInfo.compensacion.y > 0 || prorrateoInfo.compensacion.m > 0 || prorrateoInfo.compensacion.d > 0)) {
            razonExcedente = 'Aportes por excedente de edad (prorrateo ANSES)';
          }
        }
      }
      
      if(!state.computedDisabled.EX){
        if(!foundEx){
          foundEx = { id: state.seq++, desde:null, hasta:null, razon:razonExcedente, caja:'ANSES', tipo:'Común', edadReq:'', apReq:'', ymd:ymdEx, generatedType:'EX', esCredito:true };
          state.aportes.push(foundEx);
        } else {
          foundEx.razon = razonExcedente;
          foundEx.caja = 'ANSES';
          foundEx.tipo = 'Común';
          foundEx.ymd = ymdEx;
        }
      } else if(foundEx){
        state.aportes = state.aportes.filter(p=>p.generatedType!=='EX');
      }
      // Nota: no eliminamos estas filas automáticamente; el usuario puede borrarlas manualmente si lo desea.
    }

    // ============ Moratorias ==========
    function capMoratoria(){ const t=$('#moratoria').value; if(t==='24476') return new Date(1993,8,30); if(t==='27705') return new Date(2012,11,31); return null }
    function fechaInicioMoratoria(){ const fN=parseISO($('#fNac').value); if(!fN) return null; const desde18=new Date(fN); desde18.setFullYear(desde18.getFullYear()+18); if($('#nacionalidad').value==='EX'){ const fI=parseISO($('#fIngreso').value); return fI? (fI>desde18?fI:desde18):desde18 } return desde18 }
    function cumplioEdadJubilatoriaAFecha(fecha){ const req=edadRequeridaBase(); const fN=parseISO($('#fNac').value); if(!fN) return false; const fechaReq=new Date(fN); fechaReq.setFullYear(fechaReq.getFullYear()+req); return fecha>=fechaReq }

    async function cargarMoratoriaAuto(){
      const tipo=$('#moratoria').value; if(tipo==='NINGUNA'){ await showModal('Seleccione un tipo de moratoria.'); return }
      const fEval = evalDate(); if(tipo==='27705' && cumplioEdadJubilatoriaAFecha(fEval)){ await showModal(`Plan 27.705 no aplica: a la fecha de cálculo (${fmtDMY2(fEval)}) la persona ya cumplió la edad jubilatoria.`); return }
      const ini=fechaInicioMoratoria(), fin=capMoratoria(); if(!ini||!fin){ await showModal('Complete fecha de nacimiento (y de ingreso si es extranjera/o) y verifique tipo de moratoria.'); return }
      if(ini>fin){ await showModal(`La ventana de moratoria resulta vacía (desde ${fmtDMY2(ini)} hasta ${fmtDMY2(fin)}).`); return }
      
      // Cargar toda la moratoria disponible sin importar si ya cumple los requisitos
      const base={desde:new Date(ini), hasta:new Date(fin)};
  // blockers: sólo las aportaciones con fechas reales (no las computadas generadas)
  const blockers=state.aportes.filter(p=>!p.esMoratoria && !p.esCredito && p.desde && p.hasta).map(p=>({desde:new Date(p.desde), hasta:new Date(p.hasta)}));
  let piezas=subtractRanges(base, blockers); if(piezas.length===0){ await showModal('No hay tramos disponibles sin superposición con aportes existentes.'); return }
      
      state.aportes = state.aportes.filter(p=>!(p.esMoratoria && p.razon.indexOf(tipo)!==-1));
      for(const r of piezas){ 
        const sexo = $('#sexo').value;
        const reqs = getRequirementsFor('Autónomo Común', sexo);
        const per={id:state.seq++, desde:r.desde, hasta:r.hasta, razon:`Moratoria ${tipo}`, caja:'ANSES', tipo:'Autónomo Común', edadReq:reqs.edad, apReq:reqs.ap, esMoratoria:true}; 
        per.ymd=periodoYMD(per.desde, per.hasta); 
        state.aportes.push(per) 
      }
      render(); await showModal(`Moratoria ${tipo} cargada en ${piezas.length} tramo(s). Se cargó toda la moratoria disponible sin importar los aportes requeridos.`);
    }
    function quitarMoratorias(){ state.aportes = state.aportes.filter(p=>!p.esMoratoria); render(); }

    // ============ Compensación por régimen insalubre ==========
    function calcularCompensacionInsalubre(){
      const sexo = $('#sexo').value;
      let compensacionTotal = {y:0,m:0,d:0};
      
      // Verificar si se cumple el requisito de construcción (12 años de los últimos 15)
      const validacionConstruccion = validarConstruccion();
      const cumpleConstruccion = validacionConstruccion.cumple;
      
      // Filtrar aportes en régimen insalubre (excluyendo beneficios generados y moratorias)
      let aportesInsalubres = state.aportes.filter(p => 
        !p.esCredito && 
        !p.esMoratoria && 
        p.tipo && 
        (p.tipo.includes('Insalubre') || p.tipo.includes('riesgoso') || p.tipo.includes('insalubre') || 
         p.tipo.includes('riesgosas') || p.tipo.includes('penoso') || p.tipo.includes('Minería') ||
         p.tipo.includes('Laminación') || p.tipo.includes('Forja') || p.tipo.includes('Construcción') ||
         p.tipo.includes('agrario') || p.tipo.includes('Amarradores') || p.tipo.includes('Dragado') ||
         p.tipo.includes('ferrobarcos') || p.tipo.includes('Petróleo'))
      );
      
      // Si cumple requisito de construcción, agregar todos los servicios comunes como insalubres
      if(cumpleConstruccion){
        const aportesComunes = state.aportes.filter(p => 
          !p.esCredito && 
          !p.esMoratoria && 
          p.tipo === 'Común'
        );
        aportesInsalubres = [...aportesInsalubres, ...aportesComunes];
        console.log('Cumple requisito construcción: servicios comunes tratados como insalubres');
      }
      
      console.log('Aportes insalubres encontrados:', aportesInsalubres);
      
      for(const aporte of aportesInsalubres){
        // Para servicios comunes que se tratan como insalubres, usar reglas de construcción
        const tipoAporte = (cumpleConstruccion && aporte.tipo === 'Común') ? 'Industria de la Construcción' : aporte.tipo;
        const reqs = getRequirementsFor(tipoAporte, sexo, aporte.hasta);
        console.log(`Aporte insalubre: ${aporte.tipo} -> ${tipoAporte}, reqs:`, reqs, 'ymd:', aporte.ymd);
        
        // Aplicar compensación según los aportes requeridos
        if(reqs.ap === 25){
          // Multiplicar por 1.2 cuando se requieren 25 años
          const diasOriginales = aporte.ymd.y * 360 + aporte.ymd.m * 30 + aporte.ymd.d;
          const diasCompensados = Math.floor(diasOriginales * 1.2);
          const diasExtra = diasCompensados - diasOriginales;
          
          const y = Math.floor(diasExtra / 360);
          const m = Math.floor((diasExtra % 360) / 30);
          const d = diasExtra % 30;
          
          console.log(`Compensación 25 años: ${diasOriginales} -> ${diasCompensados}, extra: ${diasExtra}, ymd: ${y}a ${m}m ${d}d`);
          compensacionTotal = sumYMD(compensacionTotal, {y,m,d});
        } else if(reqs.ap === 27){
          // Multiplicar por 1.11 cuando se requieren 27 años
          const diasOriginales = aporte.ymd.y * 360 + aporte.ymd.m * 30 + aporte.ymd.d;
          const diasCompensados = Math.floor(diasOriginales * 1.11);
          const diasExtra = diasCompensados - diasOriginales;
          
          const y = Math.floor(diasExtra / 360);
          const m = Math.floor((diasExtra % 360) / 30);
          const d = diasExtra % 30;
          
          console.log(`Compensación 27 años: ${diasOriginales} -> ${diasCompensados}, extra: ${diasExtra}, ymd: ${y}a ${m}m ${d}d`);
          compensacionTotal = sumYMD(compensacionTotal, {y,m,d});
        }
      }
      
      console.log('Compensación total insalubre:', compensacionTotal);
      return compensacionTotal;
    }

    // ============ Validación especial para construcción ==========
    function validarConstruccion(){
      const fS = evalDate();
      const fechaLimite = new Date(fS);
      fechaLimite.setFullYear(fechaLimite.getFullYear() - 15); // 15 años atrás
      
      // Filtrar aportes en construcción de los últimos 15 años
      const aportesConstruccion = state.aportes.filter(p => 
        !p.esCredito && 
        !p.esMoratoria && 
        p.tipo === 'Industria de la Construcción' &&
        p.hasta && p.hasta >= fechaLimite
      );
      
      // Calcular total de años en construcción de los últimos 15 años
      const totalConstruccion = aportesConstruccion.reduce((acc,p)=>sumYMD(acc,p.ymd||{y:0,m:0,d:0}),{y:0,m:0,d:0});
      
      // Verificar si cumple el requisito de al menos 12 años
      const cumpleRequisito = totalConstruccion.y >= 12;
      
      return {
        cumple: cumpleRequisito,
        añosConstruccion: totalConstruccion,
        aportesConstruccion: aportesConstruccion,
        fechaLimite: fechaLimite
      };
    }

    // ============ Totales y derecho ==========
    function totalAportesYMD(){
  // base: suma de aportes reales (excluye beneficios generados)
      const base = state.aportes.filter(p=>!p.esCredito).reduce((acc,p)=>sumYMD(acc,p.ymd||{y:0,m:0,d:0}),{y:0,m:0,d:0});
      const ap475 = computeAporte475();
      const apEx = computeExcesoEdad();
      
      // Calcular compensación por régimen insalubre
      const compensacionInsalubre = calcularCompensacionInsalubre();
      
  // total: suma de todas las filas efectivas en la tabla (incluye beneficios generados) + compensación insalubre
      const total = state.aportes.reduce((acc,p)=>sumYMD(acc,p.ymd||{y:0,m:0,d:0}),{y:0,m:0,d:0});
      const totalConCompensacion = sumYMD(total, compensacionInsalubre);
      
      
      return {base,ap475,apEx,total:totalConCompensacion,compensacionInsalubre};
    }

    // ============ Detección automática de regímenes especiales ==========
    function detectarRegimenesEspeciales() {
      const aportesReales = state.aportes.filter(p => !p.esCredito && !p.esMoratoria);
      
      // Lista de regímenes especiales (excluyendo 'Común')
      const regímenesEspeciales = aportesReales.filter(aporte => 
        aporte.tipo && aporte.tipo !== 'Común'
      );
      
      return {
        tieneRegimenesEspeciales: regímenesEspeciales.length > 0,
        regímenesEspeciales: regímenesEspeciales.map(r => r.tipo),
        cantidad: regímenesEspeciales.length
      };
    }
    
    // Función para activar automáticamente el prorrateo si hay regímenes especiales
    function activarProrrateoAutomatico() {
      const deteccion = detectarRegimenesEspeciales();
      const checkbox = document.getElementById('chkProrrateo');
      
      if (deteccion.tieneRegimenesEspeciales && !checkbox.checked) {
        checkbox.checked = true;
        console.log('Prorrateo activado automáticamente. Regímenes especiales detectados:', deteccion.regímenesEspeciales);
        
        // Mostrar notificación visual
        const label = checkbox.parentElement.querySelector('span');
        if (label) {
          label.style.color = '#059669'; // Verde para indicar activación
          label.style.fontWeight = '700';
          setTimeout(() => {
            label.style.color = '#374151';
            label.style.fontWeight = '600';
          }, 2000);
        }
        
        // Actualizar las filas computadas
        syncComputedRows();
        render();
        
        // Si hay un resumen calculado, recalcular automáticamente
        if(document.getElementById('resumen').innerHTML.trim()) {
          calcularDerecho();
        }
      } else if (!deteccion.tieneRegimenesEspeciales && checkbox.checked) {
        // Si no hay regímenes especiales pero el prorrateo está activado, desactivarlo
        checkbox.checked = false;
        console.log('Prorrateo desactivado automáticamente. No se detectaron regímenes especiales.');
        
        // Actualizar las filas computadas
        syncComputedRows();
        render();
        
        // Si hay un resumen calculado, recalcular automáticamente
        if(document.getElementById('resumen').innerHTML.trim()) {
          calcularDerecho();
        }
      }
    }

    // ============ Prorrateo para regímenes especiales según instructivo ANSES ==========
    function calcularProrrateo() {
      const sexo = $('#sexo').value;
      const aportesReales = state.aportes.filter(p => !p.esCredito && !p.esMoratoria);
      
      // Agrupar aportes por tipo de régimen
      const regímenes = {};
      
      aportesReales.forEach(aporte => {
        const tipo = aporte.tipo || 'Común';
        if (!regímenes[tipo]) {
          regímenes[tipo] = { aportes: [], totalYMD: {y:0,m:0,d:0} };
        }
        regímenes[tipo].aportes.push(aporte);
        regímenes[tipo].totalYMD = sumYMD(regímenes[tipo].totalYMD, aporte.ymd || {y:0,m:0,d:0});
      });
      
      // Identificar regímenes especiales (no comunes)
      const regímenesEspeciales = Object.keys(regímenes).filter(tipo => tipo !== 'Común');
      
      if (regímenesEspeciales.length === 0) {
        return null; // No hay regímenes especiales para prorratear
      }
      
      // Calcular totales de regímenes especiales
      let totalDiasEspeciales = 0;
      let totalDiasComunes = 0;
      const regimenComun = regímenes['Común'] || { totalYMD: {y:0,m:0,d:0} };
      
      // Sumar todos los regímenes especiales
      regímenesEspeciales.forEach(tipo => {
        const dias = regímenes[tipo].totalYMD.y * 360 + regímenes[tipo].totalYMD.m * 30 + regímenes[tipo].totalYMD.d;
        totalDiasEspeciales += dias;
      });
      
      totalDiasComunes = regimenComun.totalYMD.y * 360 + regimenComun.totalYMD.m * 30 + regimenComun.totalYMD.d;
      
      // Calcular requisitos ponderados para regímenes especiales
      let requisitosPonderadosEspeciales = 0;
      let edadPonderadaEspeciales = 0;
      let totalDiasRequeridosEspeciales = 0;
      
      regímenesEspeciales.forEach(tipo => {
        const dias = regímenes[tipo].totalYMD.y * 360 + regímenes[tipo].totalYMD.m * 30 + regímenes[tipo].totalYMD.d;
        const reqs = getRequirementsFor(tipo, sexo);
        const peso = dias / totalDiasEspeciales; // Peso proporcional de este régimen especial
        
        requisitosPonderadosEspeciales += reqs.ap * peso;
        edadPonderadaEspeciales += reqs.edad * peso;
        totalDiasRequeridosEspeciales += reqs.ap * 360 * peso;
      });
      
      const reqsComun = getRequirementsFor('Común', sexo);
      const diasRequeridosComun = reqsComun.ap * 360;
      
      // Verificar si cumple completamente algún régimen especial
      for (const tipo of regímenesEspeciales) {
        const dias = regímenes[tipo].totalYMD.y * 360 + regímenes[tipo].totalYMD.m * 30 + regímenes[tipo].totalYMD.d;
        const reqs = getRequirementsFor(tipo, sexo);
        const diasRequeridos = reqs.ap * 360;
        
        if (dias >= diasRequeridos) {
          return {
            tipo: 'completo',
            regimen: tipo,
            cumple: true,
            mensaje: `Cumple completamente el régimen especial: ${tipo}`
          };
        }
      }
      
      // ========== APLICAR FÓRMULAS DEL INSTRUCTIVO ANSES ==========
      
      // 1. FÓRMULA DE EQUIVALENCIA: TSD/I x SCR = SCE / SD/IR
      // TSD/I = Total de servicios diferenciales/insalubres computados (suma de todos los regímenes especiales)
      // SCR = Servicios comunes requeridos (30 años)
      // SD/IR = Servicios diferenciales/insalubres requeridos (ponderado)
      // SCE = Servicios comunes equivalentes
      
      const TSD_I = totalDiasEspeciales; // Total servicios diferenciales/insalubres en días
      const SCR = 30 * 360; // Servicios comunes requeridos (30 años en días)
      const SD_IR = totalDiasRequeridosEspeciales; // Servicios diferenciales/insalubres requeridos ponderados en días
      
      const SCE = (TSD_I * SCR) / SD_IR; // Servicios comunes equivalentes
      
      // 2. FÓRMULA DE EDAD REQUERIDA PRORRATEADA
      // TSD/I = TD% * ER / SD/IR
      // Donde:
      // TD% = Tiempo diferencial en porcentaje
      // ER = Edad Requerida Servicios Diferenciales (ponderada)
      
      const TD_porcentaje = (TSD_I / SD_IR) * 100; // Porcentaje de tiempo diferencial
      const ER_SD = edadPonderadaEspeciales; // Edad requerida servicios diferenciales ponderada
      const tiempo_edad_requerida_servicios_diferenciales = (TD_porcentaje * ER_SD) / 100;
      
      // Tiempo común en porcentaje
      const TC_porcentaje = 100 - TD_porcentaje;
      
      // Tiempo edad requerida servicios comunes
      const ER_SC = reqsComun.edad; // Edad requerida servicios comunes
      const tiempo_edad_requerida_servicios_comunes = (TC_porcentaje * ER_SC) / 100;
      
      // Total tiempo edad requerida
      const total_tiempo_edad_requerida = tiempo_edad_requerida_servicios_diferenciales + tiempo_edad_requerida_servicios_comunes;
      
      // Convertir a años, meses y días
      const años = Math.floor(total_tiempo_edad_requerida);
      const mesesDecimalesEdad = (total_tiempo_edad_requerida - años) * 12;
      const meses = Math.floor(mesesDecimalesEdad);
      const días = Math.round((mesesDecimalesEdad - meses) * 30);
      
      // 3. CÁLCULO DE COMPENSACIÓN POR EXCEDENTE DE EDAD
      const fNComp = parseISO($('#fNac').value);
      const fSComp = evalDate();
      
      let compensacion = {y:0,m:0,d:0};
      if (fNComp) {
        const fechaReq = new Date(fNComp);
        fechaReq.setFullYear(fechaReq.getFullYear() + años);
        fechaReq.setMonth(fechaReq.getMonth() + meses);
        fechaReq.setDate(fechaReq.getDate() + días);
        
        if (fSComp > fechaReq) {
          const excedente = diff360(fechaReq, fSComp);
          // Convertir excedente completo a días, dividir por 2, y convertir de vuelta
          const totalDiasExcedente = (excedente.y * 360) + (excedente.m * 30) + excedente.d;
          const compensacionDias = Math.floor(totalDiasExcedente / 2);
          
          // Convertir días de compensación de vuelta a años, meses y días
          const compensacionAños = Math.floor(compensacionDias / 360);
          const diasRestantes = compensacionDias % 360;
          const compensacionMeses = Math.floor(diasRestantes / 30);
          const compensacionDiasFinal = diasRestantes % 30;
          
          compensacion = {
            y: compensacionAños,
            m: compensacionMeses,
            d: compensacionDiasFinal
          };
        }
      }
      
      // 4. TOTAL DE SERVICIOS CON APORTES (incluyendo compensación)
      // Sumar todos los regímenes especiales
      let totalServiciosEspeciales = {y:0,m:0,d:0};
      regímenesEspeciales.forEach(tipo => {
        totalServiciosEspeciales = sumYMD(totalServiciosEspeciales, regímenes[tipo].totalYMD);
      });
      
      const serviciosConAportes = sumYMD(
        sumYMD(totalServiciosEspeciales, regimenComun.totalYMD),
        compensacion
      );
      
      // 5. VALIDACIONES SEGÚN INSTRUCTIVO ANSES
      // Límite máximo de servicios computables por declaración jurada (art. 38)
      const fNVal = parseISO($('#fNac').value);
      const fSVal = evalDate();
      let limiteDeclaracionJurada = 0;
      
      if (fNVal && fSVal) {
        // Calcular años desde el nacimiento hasta la fecha de cese/solicitud
        const añosDesdeNacimiento = fSVal.getFullYear() - fNVal.getFullYear();
        // El límite es 3 años por declaración jurada según el instructivo
        limiteDeclaracionJurada = 3;
      }
      
      // Verificar si cumple los requisitos (30 años total)
      const cumple = serviciosConAportes.y >= 30;
      
      // Verificar si necesita declaración jurada para completar los 30 años
      const necesitaDeclaracionJurada = serviciosConAportes.y < 30 && (serviciosConAportes.y + limiteDeclaracionJurada) >= 30;
      
      const resultado = {
        tipo: 'prorrateado_anses_multi',
        regímenesEspeciales: regímenesEspeciales,
        regimenComun: 'Común',
        formulas: {
          equivalencia: {
            TSD_I: TSD_I,
            SCR: SCR,
            SD_IR: SD_IR,
            SCE: SCE,
            formula: `(${TSD_I} × ${SCR}) ÷ ${SD_IR} = ${SCE.toFixed(2)} días equivalentes`
          },
          edad: {
            TD_porcentaje: TD_porcentaje.toFixed(2),
            TC_porcentaje: TC_porcentaje.toFixed(2),
            ER_SD: ER_SD.toFixed(2),
            ER_SC: ER_SC,
            tiempo_edad_diferencial: tiempo_edad_requerida_servicios_diferenciales.toFixed(2),
            tiempo_edad_comun: tiempo_edad_requerida_servicios_comunes.toFixed(2),
            total_edad_requerida: total_tiempo_edad_requerida.toFixed(2)
          }
        },
        edadProrrateada: { años, meses, días },
        compensacion: compensacion,
        serviciosConAportes: serviciosConAportes,
        cumple: cumple,
        validaciones: {
          limiteDeclaracionJurada: limiteDeclaracionJurada,
          necesitaDeclaracionJurada: necesitaDeclaracionJurada,
          serviciosFaltantes: Math.max(0, 30 - serviciosConAportes.y)
        },
        detalle: {
          especiales: regímenesEspeciales.map(tipo => {
            const dias = regímenes[tipo].totalYMD.y * 360 + regímenes[tipo].totalYMD.m * 30 + regímenes[tipo].totalYMD.d;
            const reqs = getRequirementsFor(tipo, sexo);
            const peso = totalDiasEspeciales > 0 ? (dias / totalDiasEspeciales) * 100 : 0;
            
            return {
              tipo: tipo,
              dias: dias,
              ymd: regímenes[tipo].totalYMD,
              peso: peso.toFixed(2),
              edad: reqs.edad,
              aportesRequeridos: reqs.ap,
              porcentaje: peso.toFixed(2)
            };
          }),
          comun: {
            tipo: 'Común',
            dias: totalDiasComunes,
            ymd: regimenComun.totalYMD,
            porcentaje: TC_porcentaje.toFixed(2),
            edad: ER_SC,
            aportesRequeridos: reqsComun.ap
          },
          totales: {
            diasEspeciales: totalDiasEspeciales,
            diasComunes: totalDiasComunes,
            diasTotales: totalDiasEspeciales + totalDiasComunes,
            requisitosPonderadosEspeciales: requisitosPonderadosEspeciales.toFixed(2),
            edadPonderadaEspeciales: edadPonderadaEspeciales.toFixed(2)
          }
        }
      };
      
      console.log('Prorrateo ANSES calculado:', resultado);
      return resultado;
    }
    function aportesRequeridosGlobal(){ const ben=$('#beneficio').value; if(ben==='PUAM') return {y:0,m:0,d:0}; if(ben==='Retiro por Invalidez') return {y:0,m:0,d:0}; if(ben==='Prestación por edad avanzada') return {y:10,m:0,d:0}; return {y:30,m:0,d:0} }
    function ymdGte(a,b){ return (a.y*360+a.m*30+a.d) >= (b.y*360+b.m*30+b.d) }
    
    // Función para generar planificación de requisitos faltantes
    function generarPlanificacion(datos) {
      const { cumple, cumpleEdad, cumpleAportes, edadActual, edadRequeridaFinal, total, tieneConstruccion, validacionConstruccion, fS, sexo } = datos;
      
      // Helper para mostrar Y/M/D con formato agradable
      const fmtYMD = (ymd) => `${ymd.y}a ${ymd.m}m ${ymd.d}d`;
      
      // Si ya cumple todos los requisitos, no mostrar planificación
      if (cumple) {
        return `
          <details style="margin-top:12px">
            <summary style="padding:10px;background:#dcfce7;border:1px solid #16a34a;border-radius:6px;color:#166534;font-weight:600">🎯 Planificación de Requisitos - ✅ Todos los requisitos cumplidos</summary>
            <div style="padding:10px;background:#dcfce7;border:1px solid #16a34a;border-top:0;border-radius:0 0 6px 6px;font-size:10px;color:#166534">
              ✅ <b>¡Felicitaciones!</b> Ya cumple todos los requisitos para acceder al beneficio.
            </div>
          </details>
        `;
      }
      
      // Analizar qué falta para cumplir requisitos
      const faltaEdad = edadRequeridaFinal - edadActual;
      const aportesRequeridos = tieneConstruccion ? {y:25,m:0,d:0} : {y:30,m:0,d:0};
      const faltaAportes = calcularFaltanteAportes(total, aportesRequeridos);
      
      // Crear resumen para el summary
      let resumenFaltantes = [];
      if (!cumpleEdad && faltaEdad > 0) {
        resumenFaltantes.push(`📅 Falta edad: ${fmtYMD(añosAYMD(faltaEdad))}`);
      }
      if (!cumpleAportes && (faltaAportes.y > 0 || faltaAportes.m > 0 || faltaAportes.d > 0)) {
        resumenFaltantes.push(`💼 Falta aportes: ${fmtYMD(faltaAportes)}`);
      }
      if (tieneConstruccion && !validacionConstruccion.cumple) {
        const faltaConstruccion = calcularFaltanteAportes(validacionConstruccion.añosConstruccion, {y:12,m:0,d:0});
        resumenFaltantes.push(`🏗️ Falta construcción: ${fmtYMD(faltaConstruccion)}`);
      }
      
      const resumenTexto = resumenFaltantes.length > 0 ? resumenFaltantes.join(' | ') : 'Revisar requisitos detallados';
      
      // Función para convertir años enteros a años, meses y días
      function añosAYMD(años) {
        return { y: años, m: 0, d: 0 };
      }
      
      let planificacionHTML = `
        <details style="margin-top:12px">
          <summary style="padding:10px;background:#fef3c7;border:1px solid #f59e0b;border-radius:6px;color:#92400e;font-weight:600">🎯 Planificación de Requisitos Faltantes - ${resumenTexto}</summary>
          <div style="padding:10px;background:#fef3c7;border:1px solid #f59e0b;border-top:0;border-radius:0 0 6px 6px;font-size:10px">
      `;
      
      // Planificación por edad
      if (!cumpleEdad && faltaEdad > 0) {
        const fechaCumpleEdad = new Date(fS);
        fechaCumpleEdad.setFullYear(fechaCumpleEdad.getFullYear() + faltaEdad);
        
        planificacionHTML += `
          <div style="margin-bottom:8px;padding:8px;background:#fef2f2;border-radius:4px;border-left:4px solid #dc2626">
            <div><b>📅 Requisito de Edad</b></div>
            <div style="font-size:10px;color:#6b7280;margin-top:4px">
              <div><b>Falta:</b> ${fmtYMD(añosAYMD(faltaEdad))}</div>
              <div><b>Fecha estimada para cumplir:</b> ${fmtDMY4(fechaCumpleEdad)}</div>
              <div style="margin-top:4px;color:#dc2626">
                <b>Acción requerida:</b> Esperar hasta cumplir la edad requerida o considerar solicitar en una fecha posterior.
              </div>
            </div>
          </div>
        `;
      } else if (cumpleEdad) {
        planificacionHTML += `
          <div style="margin-bottom:8px;padding:8px;background:#dcfce7;border-radius:4px;border-left:4px solid #16a34a">
            <div><b>📅 Requisito de Edad</b></div>
            <div style="font-size:10px;color:#166534;margin-top:4px">
              <div><b>Estado:</b> ✅ Cumplido (${edadActual} años)</div>
              <div><b>Edad requerida:</b> ${edadRequeridaFinal} años</div>
            </div>
          </div>
        `;
      }
      
      // Planificación por aportes
      if (!cumpleAportes && (faltaAportes.y > 0 || faltaAportes.m > 0 || faltaAportes.d > 0)) {
        // Calcular si puede usar Plan de Deuda 27705
        // El Plan 27705 está disponible hasta la edad jubilatoria ordinaria (60F/65M), 
        // independientemente de si tiene regímenes especiales con menor edad
        const edadJubilatoriaOrdinaria = sexo === 'F' ? 60 : 65;
        const puedeUsarPlanDeuda = edadActual < edadJubilatoriaOrdinaria;
        const costoPlanDeuda = calcularCostoPlanDeuda(faltaAportes);
        
        planificacionHTML += `
          <div style="margin-bottom:8px;padding:8px;background:#fef2f2;border-radius:4px;border-left:4px solid #dc2626">
            <div><b>💼 Requisito de Aportes</b></div>
            <div style="font-size:10px;color:#6b7280;margin-top:4px">
              <div><b>Faltan:</b> ${fmtYMD(faltaAportes)}</div>
              <div><b>Aportes actuales:</b> ${fmtYMD(total)}</div>
              <div><b>Aportes requeridos:</b> ${fmtYMD(aportesRequeridos)}</div>
              <div style="margin-top:4px;color:#dc2626">
                <b>Acciones posibles:</b>
                <ul style="margin:4px 0;padding-left:16px">
                  <li>Continuar trabajando hasta completar los aportes faltantes</li>
                  <li>Verificar si hay períodos no declarados que puedan sumarse</li>
                  <li>Considerar moratoria previsional si aplica</li>
                  ${puedeUsarPlanDeuda ? `<li><b>Plan de Deuda 27705:</b> Comprar aportes faltantes</li>` : ''}
                </ul>
              </div>
            </div>
          </div>
        `;
        
        // Mostrar opción de Plan de Deuda 27705 si aplica
        if (puedeUsarPlanDeuda) {
          planificacionHTML += `
            <div style="margin-bottom:8px;padding:8px;background:#e0f2fe;border-radius:4px;border-left:4px solid #0ea5e9">
              <div><b>💰 Plan de Deuda 27705</b></div>
              <div style="font-size:10px;color:#6b7280;margin-top:4px">
                <div><b>Condición:</b> No haber cumplido la edad jubilatoria ordinaria (${edadJubilatoriaOrdinaria} años)</div>
                <div><b>Estado:</b> ✅ Cumple condición (edad actual: ${edadActual} años)</div>
                <div style="margin-top:6px;padding:6px;background:#f8fafc;border-radius:3px">
                  <div><b>Aportes a comprar:</b> ${fmtYMD(faltaAportes)}</div>
                  <div><b>Costo por mes:</b> $31,870.13</div>
                  <div><b>Total a pagar:</b> <span style="color:#0c4a6e;font-weight:600">$${costoPlanDeuda.total.toLocaleString('es-AR')}</span></div>
                  <div style="font-size:10px;color:#6b7280;margin-top:2px">
                    Cálculo: ${costoPlanDeuda.meses} meses × $31,870.13 = $${costoPlanDeuda.total.toLocaleString('es-AR')}
                  </div>
                </div>
                <div style="margin-top:4px;color:#0c4a6e">
                  <b>Ventaja:</b> Comprar exactamente lo que falta, sin excedentes.
                </div>
              </div>
            </div>
          `;
        } else {
          planificacionHTML += `
            <div style="margin-bottom:8px;padding:8px;background:#fef2f2;border-radius:4px;border-left:4px solid #dc2626">
              <div><b>💰 Plan de Deuda 27705</b></div>
              <div style="font-size:10px;color:#6b7280;margin-top:4px">
                <div><b>Condición:</b> No haber cumplido la edad jubilatoria ordinaria (${edadJubilatoriaOrdinaria} años)</div>
                <div><b>Estado:</b> ❌ No cumple condición (edad actual: ${edadActual} años)</div>
                <div style="margin-top:4px;color:#dc2626">
                  <b>No disponible:</b> Ya cumplió la edad jubilatoria, no puede acceder al Plan de Deuda 27705.
                </div>
              </div>
            </div>
          `;
        }
      } else if (cumpleAportes) {
        planificacionHTML += `
          <div style="margin-bottom:8px;padding:8px;background:#dcfce7;border-radius:4px;border-left:4px solid #16a34a">
            <div><b>💼 Requisito de Aportes</b></div>
            <div style="font-size:10px;color:#166534;margin-top:4px">
              <div><b>Estado:</b> ✅ Cumplido</div>
              <div><b>Aportes actuales:</b> ${fmtYMD(total)}</div>
              <div><b>Aportes requeridos:</b> ${fmtYMD(aportesRequeridos)}</div>
            </div>
          </div>
        `;
      }
      
      // Planificación especial para construcción
      if (tieneConstruccion && !validacionConstruccion.cumple) {
        const faltaConstruccion = calcularFaltanteAportes(validacionConstruccion.añosConstruccion, {y:12,m:0,d:0});
        planificacionHTML += `
          <div style="margin-bottom:8px;padding:8px;background:#fef2f2;border-radius:4px;border-left:4px solid #dc2626">
            <div><b>🏗️ Requisito Especial de Construcción</b></div>
            <div style="font-size:10px;color:#6b7280;margin-top:4px">
              <div><b>Faltan en construcción:</b> ${fmtYMD(faltaConstruccion)} (de los últimos 15 años)</div>
              <div><b>Años actuales en construcción:</b> ${fmtYMD(validacionConstruccion.añosConstruccion)}</div>
              <div><b>Período evaluado:</b> ${fmtDMY4(validacionConstruccion.fechaLimite)} a ${fmtDMY4(fS)}</div>
              <div style="margin-top:4px;color:#dc2626">
                <b>Acción requerida:</b> Trabajar en la industria de la construcción para completar al menos 12 años de los últimos 15.
              </div>
            </div>
          </div>
        `;
      } else if (tieneConstruccion && validacionConstruccion.cumple) {
      planificacionHTML += `
          <div style="margin-bottom:8px;padding:8px;background:#dcfce7;border-radius:4px;border-left:4px solid #16a34a">
            <div><b>🏗️ Requisito Especial de Construcción</b></div>
            <div style="font-size:10px;color:#166534;margin-top:4px">
              <div><b>Estado:</b> ✅ Cumplido</div>
              <div><b>Años en construcción:</b> ${fmtYMD(validacionConstruccion.añosConstruccion)}</div>
              <div><b>Período evaluado:</b> ${fmtDMY4(validacionConstruccion.fechaLimite)} a ${fmtDMY4(fS)}</div>
            </div>
          </div>
        `;
      }
      
      // Opción para calcular deuda 27705 si la persona siguiera trabajando
      if (!cumple && (faltaEdad > 0 || (faltaAportes.y > 0 || faltaAportes.m > 0 || faltaAportes.d > 0))) {
        const edadJubilatoriaOrdinaria = sexo === 'F' ? 60 : 65;
        const puedeUsarPlanDeuda = edadActual < edadJubilatoriaOrdinaria;
        
        if (puedeUsarPlanDeuda) {
          // Calcular cuántos aportes adicionales ganaría si siguiera trabajando
          const añosParaCumplirEdad = Math.max(0, faltaEdad);
          const aportesAdicionales = { y: añosParaCumplirEdad, m: 0, d: 0 };
          const totalConTrabajoFuturo = sumYMD(total, aportesAdicionales);
          const faltaAportesConTrabajo = calcularFaltanteAportes(totalConTrabajoFuturo, aportesRequeridos);
          const costoPlanDeudaConTrabajo = calcularCostoPlanDeuda(faltaAportesConTrabajo);
          
      planificacionHTML += `
            <div style="margin-bottom:8px;padding:8px;background:#f0f9ff;border-radius:4px;border-left:4px solid #0284c7">
              <div><b>🔮 Proyección con Trabajo Continuo</b></div>
              <div style="font-size:10px;color:#6b7280;margin-top:4px">
                <div><b>Escenario:</b> Si continúa trabajando hasta cumplir la edad requerida</div>
                <div><b>Aportes adicionales estimados:</b> ${fmtYMD(aportesAdicionales)}</div>
                <div><b>Total de aportes proyectado:</b> ${fmtYMD(totalConTrabajoFuturo)}</div>
                <div><b>Faltarían aportes:</b> ${fmtYMD(faltaAportesConTrabajo)}</div>
                <div style="margin-top:6px;padding:6px;background:#e0f2fe;border-radius:3px">
                  <div><b>💰 Plan de Deuda 27705 (proyectado):</b></div>
                  <div><b>Costo estimado:</b> $${costoPlanDeudaConTrabajo.total.toLocaleString('es-AR')}</div>
                  <div><b>Cuota mensual:</b> $${Math.round(costoPlanDeudaConTrabajo.total / 60).toLocaleString('es-AR')} (60 cuotas)</div>
                  <div style="font-size:10px;color:#64748b;margin-top:4px">
                    <em>Nota: Este cálculo asume aportes continuos hasta cumplir la edad requerida. 
                    El costo real puede variar según la evolución de los salarios y la inflación.</em>
                  </div>
                </div>
          </div>
        </div>
      `;
        }
      }
      
      planificacionHTML += `
          </div>
        </details>
      `;
      
      return planificacionHTML;
    }
    
    // Función auxiliar para calcular faltante de aportes
    function calcularFaltanteAportes(actual, requerido) {
      const totalDaysActual = (actual.y * 360 + actual.m * 30 + actual.d);
      const totalDaysRequerido = (requerido.y * 360 + requerido.m * 30 + requerido.d);
      
      if (totalDaysActual >= totalDaysRequerido) {
        return {y:0, m:0, d:0};
      }
      
      const diff = totalDaysRequerido - totalDaysActual;
      const y = Math.floor(diff / 360);
      const m = Math.floor((diff % 360) / 30);
      const d = diff % 30;
      
      return {y, m, d};
    }
    
    // Función para calcular el costo del Plan de Deuda 27705
    function calcularCostoPlanDeuda(faltaAportes) {
      const COSTO_POR_MES = 31870.13;
      
      // Convertir faltante a meses totales (redondeando hacia arriba)
      const mesesFaltantes = faltaAportes.y * 12 + faltaAportes.m;
      const diasFaltantes = faltaAportes.d;
      
      // Si hay días adicionales, contar como un mes más
      const mesesTotal = diasFaltantes > 0 ? mesesFaltantes + 1 : mesesFaltantes;
      
      const total = mesesTotal * COSTO_POR_MES;
      
      return {
        meses: mesesTotal,
        costoPorMes: COSTO_POR_MES,
        total: total
      };
    }

    // ============ Cálculo de Pensión PBU ============
    function calcularDerechoPBU() {
      console.log('calcularDerechoPBU ejecutándose...');
      
      // Helper para formatear Y/M/D
      const fmtYMD = (ymd) => `${ymd.y}a ${ymd.m}m ${ymd.d}d`;
      
      const tipoBeneficiario = $('#tipoBeneficiario').value;
      const fechaFallecimiento = parseISO($('#fFall').value);
      const fechaSolicitud = parseISO($('#fSol').value) || new Date();
      
      if (!tipoBeneficiario) {
        customAlert('Debe seleccionar el tipo de beneficiario');
        return;
      }
      
      if (!fechaFallecimiento) {
        customAlert('Debe ingresar la fecha de fallecimiento del trabajador');
        return;
      }
      
      // Validar requisitos del beneficiario
      const requisitosBeneficiario = validarRequisitosBeneficiario(tipoBeneficiario);
      if (!requisitosBeneficiario.cumple) {
        mostrarResultadoPBU({
          cumple: false,
          motivo: requisitosBeneficiario.motivo,
          tipoBeneficiario,
          fechaFallecimiento,
          fechaSolicitud
        });
        return;
      }
      
      // Validar requisitos del trabajador fallecido
      const requisitosTrabajador = validarRequisitosTrabajador(fechaFallecimiento, fechaSolicitud);
      if (!requisitosTrabajador.cumple) {
        mostrarResultadoPBU({
          cumple: false,
          motivo: requisitosTrabajador.motivo,
          tipoBeneficiario,
          fechaFallecimiento,
          fechaSolicitud,
          trabajador: requisitosTrabajador
        });
        return;
      }
      
      // Si cumple todos los requisitos
      mostrarResultadoPBU({
        cumple: true,
        tipoBeneficiario,
        fechaFallecimiento,
        fechaSolicitud,
        trabajador: requisitosTrabajador
      });
    }
    
    function validarRequisitosBeneficiario(tipo) {
      switch (tipo) {
        case 'conyuge':
          return validarRequisitosConyuge();
        case 'conviviente':
          return validarRequisitosConviviente();
        case 'hijo':
          return validarRequisitosHijo();
        default:
          return { cumple: false, motivo: 'Tipo de beneficiario no válido' };
      }
    }
    
    function validarRequisitosConyuge() {
      // Para cónyuge, solo se requiere que esté casado
      // No se validan fechas específicas de casamiento ni actualización de partida
      return { cumple: true };
    }
    
    function validarRequisitosConviviente() {
      const anosConvivencia = parseFloat($('#anosConvivencia').value) || 0;
      const tienenHijoReconocido = $('#tienenHijoReconocido').value === 'si';
      
      const anosRequeridos = tienenHijoReconocido ? 2 : 5;
      
      if (anosConvivencia < anosRequeridos) {
        return { 
          cumple: false, 
          motivo: `Debe acreditar ${anosRequeridos} años de convivencia (${tienenHijoReconocido ? '2 años por tener hijo reconocido' : '5 años sin hijo reconocido'})` 
        };
      }
      
      return { cumple: true };
    }
    
    function validarRequisitosHijo() {
      const edadHijoFallecimiento = parseInt($('#edadHijoFallecimiento').value) || 0;
      const estadoCivilHijo = $('#estadoCivilHijo').value;
      const cobraOtraPrestacion = $('#cobraOtraPrestacion').value === 'si';
      const incapacitadoTrabajar = $('#incapacitadoTrabajar').value === 'si';
      
      // Si está incapacitado, no hay límite de edad
      if (incapacitadoTrabajar) {
        return { cumple: true };
      }
      
      // Si no está incapacitado, debe ser menor de 18 años
      if (edadHijoFallecimiento >= 18) {
        return { cumple: false, motivo: 'El hijo debe ser menor de 18 años o estar incapacitado para trabajar' };
      }
      
      // Debe ser soltero
      if (estadoCivilHijo !== 'soltero') {
        return { cumple: false, motivo: 'El hijo debe ser soltero' };
      }
      
      // No debe cobrar otra prestación
      if (cobraOtraPrestacion) {
        return { cumple: false, motivo: 'El hijo no debe cobrar otra prestación' };
      }
      
      return { cumple: true };
    }
    
    function validarRequisitosTrabajador(fechaFallecimiento, fechaSolicitud) {
      // Helper para formatear Y/M/D
      const fmtYMD = (ymd) => `${ymd.y}a ${ymd.m}m ${ymd.d}d`;
      
      // Calcular aportes del trabajador fallecido (incluyendo moratorias y beneficios)
      const {base, ap475, apEx, total} = totalAportesYMD();
      
      // PRIMER CRITERIO: Verificar si tiene 30+ años de aportes (incluyendo moratorias)
      const aportesRequeridos = {y: 30, m: 0, d: 0};
      const cumple30Anos = ymdGte(total, aportesRequeridos);
      
      if (cumple30Anos) {
        return {
          cumple: true,
          aportes: total,
          motivo: `Cumple con 30 años de aportes (${fmtYMD(total)})`,
          tipo: 'cumple_30_anos'
        };
      }
      
      // SEGUNDO CRITERIO: Si no cumple 30 años, analizar regularidades
      const regularidad = calcularRegularidadAportes(fechaFallecimiento, fechaSolicitud);
      
      if (regularidad.cumple) {
        return {
          cumple: true,
          aportes: total,
          regularidad: regularidad,
          motivo: `No cumple 30 años pero cumple regularidad: ${regularidad.motivo}`,
          tipo: regularidad.tipo
        };
      }
      
      // No cumple ni 30 años ni regularidades
      return {
        cumple: false,
        aportes: total,
        regularidad: regularidad,
        motivo: `No cumple 30 años de aportes (${fmtYMD(total)}) ni requisitos de regularidad`,
        tipo: 'no_cumple'
      };
    }
    
    function calcularRegularidadAportes(fechaFallecimiento, fechaSolicitud) {
      // Analizar aportes en los últimos 36 meses antes del fallecimiento
      const fechaInicio36 = new Date(fechaFallecimiento);
      fechaInicio36.setMonth(fechaInicio36.getMonth() - 36);
      
      // Obtener aportes que se superponen con el período de 36 meses (incluyendo moratorias y créditos para PBU)
      const aportes36Meses = state.aportes.filter(aporte => {
        if (!aporte.desde || !aporte.hasta) return false;
        // Verificar si el período del aporte se superpone con el período de 36 meses
        return aporte.desde <= fechaFallecimiento && aporte.hasta >= fechaInicio36;
      });
      
      // Contar meses únicos con aportes en los últimos 36 meses
      const mesesConAportes36 = new Set();
      aportes36Meses.forEach(aporte => {
        // Para cada aporte, agregar todos los meses que se superponen con el período de 36 meses
        const inicioSuperposicion = new Date(Math.max(aporte.desde.getTime(), fechaInicio36.getTime()));
        const finSuperposicion = new Date(Math.min(aporte.hasta.getTime(), fechaFallecimiento.getTime()));
        
        // Agregar cada mes del período de superposición
        const fechaActual = new Date(inicioSuperposicion);
        while (fechaActual <= finSuperposicion) {
          const mesAno = `${fechaActual.getFullYear()}-${fechaActual.getMonth()}`;
          mesesConAportes36.add(mesAno);
          fechaActual.setMonth(fechaActual.getMonth() + 1);
        }
      });
      
      const mesesAportados36 = mesesConAportes36.size;
      
      // Analizar aportes en los últimos 60 meses antes del fallecimiento
      const fechaInicio60 = new Date(fechaFallecimiento);
      fechaInicio60.setMonth(fechaInicio60.getMonth() - 60);
      
      const aportes60Meses = state.aportes.filter(aporte => {
        if (!aporte.desde || !aporte.hasta) return false;
        // Verificar si el período del aporte se superpone con el período de 60 meses
        return aporte.desde <= fechaFallecimiento && aporte.hasta >= fechaInicio60;
      });
      
      // Contar meses únicos con aportes en los últimos 60 meses
      const mesesConAportes60 = new Set();
      aportes60Meses.forEach(aporte => {
        // Para cada aporte, agregar todos los meses que se superponen con el período de 60 meses
        const inicioSuperposicion = new Date(Math.max(aporte.desde.getTime(), fechaInicio60.getTime()));
        const finSuperposicion = new Date(Math.min(aporte.hasta.getTime(), fechaFallecimiento.getTime()));
        
        // Agregar cada mes del período de superposición
        const fechaActual = new Date(inicioSuperposicion);
        while (fechaActual <= finSuperposicion) {
          const mesAno = `${fechaActual.getFullYear()}-${fechaActual.getMonth()}`;
          mesesConAportes60.add(mesAno);
          fechaActual.setMonth(fechaActual.getMonth() + 1);
        }
      });
      
      const mesesAportados60 = mesesConAportes60.size;
      const {base, ap475, apEx, total} = totalAportesYMD();
      
      // CRITERIO 1: Aportante regular (30+ meses en últimos 36)
      if (mesesAportados36 >= 30) {
        return {
          tipo: 'regular',
          mesesAportados36,
          mesesAportados60,
          cumple: true,
          motivo: `Aportante regular: ${mesesAportados36} meses con aportes en últimos 36 meses (requerido: 30)`
        };
      }
      
      // CRITERIO 2: Aportante irregular (18+ meses en últimos 36)
      if (mesesAportados36 >= 18) {
        return {
          tipo: 'irregular',
          mesesAportados36,
          mesesAportados60,
          cumple: true,
          motivo: `Aportante irregular: ${mesesAportados36} meses con aportes en últimos 36 meses (requerido: 18)`
        };
      }
      
      // CRITERIO 3: Aportante irregular alternativo (12+ meses en últimos 60 + mínimo 15 años)
      const minimoAportes = 15;
      if (mesesAportados60 >= 12 && total.y >= minimoAportes) {
        return {
          tipo: 'irregular_alternativo',
          mesesAportados36,
          mesesAportados60,
          cumple: true,
          motivo: `Aportante irregular alternativo: ${mesesAportados60} meses con aportes en últimos 60 meses (requerido: 12) y ${total.y} años totales (mínimo requerido: ${minimoAportes})`
        };
      }
      
      // No cumple ningún criterio de regularidad
      return {
        tipo: 'no_cumple',
        mesesAportados36,
        mesesAportados60,
        cumple: false,
        motivo: `No cumple requisitos de regularidad: necesita 30 meses en últimos 36 (regular), 18 meses en últimos 36 (irregular), o 12 meses en últimos 60 + ${minimoAportes} años totales (irregular alternativo)`
      };
    }
    
    function mostrarResultadoPBU(resultado) {
      const resumen = document.getElementById('resumen');
      
      // Helper para formatear Y/M/D
      const fmtYMD = (ymd) => `${ymd.y}a ${ymd.m}m ${ymd.d}d`;
      
      let html = `
        <div style="padding:12px;border-radius:8px;border:1px solid #cfcfcf;background:#fff">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div><b>Beneficio:</b> Pensión de PBU</div>
            <div style="font-size:11px;color:${resultado.cumple ? '#1a7f37' : '#a33a3a'}">
              <b>Resultado:</b> ${resultado.cumple ? 'Cumple requisitos ✅' : 'No cumple ❌'}
            </div>
          </div>
          
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">
            <div>
              <h4 style="margin:0 0 6px 0">Beneficiario</h4>
              <div><b>Tipo:</b> ${getTipoBeneficiarioTexto(resultado.tipoBeneficiario)}</div>
              <div><b>Fecha de fallecimiento:</b> ${fmtDMY4(resultado.fechaFallecimiento)}</div>
              <div><b>Fecha de solicitud:</b> ${fmtDMY4(resultado.fechaSolicitud)}</div>
              <div style="margin-top:6px;color:${resultado.cumple ? '#1a7f37' : '#a33a3a'}">
                <b>Estado:</b> ${resultado.cumple ? '✅ Cumple requisitos' : '❌ No cumple requisitos'}
              </div>
            </div>
            
            <div>
              <h4 style="margin:0 0 6px 0">Trabajador Fallecido</h4>
              ${resultado.trabajador ? `
                <div><b>Aportes totales:</b> ${fmtYMD(resultado.trabajador.aportes)}</div>
                <div><b>Criterio cumplido:</b> ${getCriterioTexto(resultado.trabajador.tipo)}</div>
                ${resultado.trabajador.regularidad ? `
                  <div><b>Meses en últimos 36:</b> ${resultado.trabajador.regularidad.mesesAportados36}</div>
                  <div><b>Meses en últimos 60:</b> ${resultado.trabajador.regularidad.mesesAportados60}</div>
                ` : ''}
                <div style="margin-top:6px;color:${resultado.cumple ? '#1a7f37' : '#a33a3a'}">
                  <b>Estado:</b> ${resultado.cumple ? '✅ Cumple requisitos' : '❌ No cumple requisitos'}
                </div>
              ` : ''}
            </div>
          </div>
          
          ${!resultado.cumple ? `
            <div style="margin-top:8px;padding:8px;background:#fef2f2;border-radius:4px;border-left:3px solid #dc2626">
              <div style="color:#991b1b;font-weight:600">❌ Motivo de rechazo:</div>
              <div style="font-size:11px;margin-top:4px">${resultado.motivo}</div>
            </div>
          ` : ''}
          
          ${resultado.trabajador && resultado.trabajador.regularidad ? `
            <div style="margin-top:8px;padding:8px;background:#f0f9ff;border-radius:4px;border-left:3px solid #0ea5e9">
              <div style="color:#0c4a6e;font-weight:600">📊 Análisis de Regularidad:</div>
              <div style="font-size:0.9rem;margin-top:4px">${resultado.trabajador.regularidad.motivo}</div>
            </div>
          ` : ''}
        </div>
      `;
      
      resumen.innerHTML = html;
    }
    
    function getTipoBeneficiarioTexto(tipo) {
      switch (tipo) {
        case 'conyuge': return 'Cónyuge';
        case 'conviviente': return 'Conviviente';
        case 'hijo': return 'Hijo';
        default: return tipo;
      }
    }
    
    function getCriterioTexto(tipo) {
      switch (tipo) {
        case 'cumple_30_anos': return '30+ años de aportes';
        case 'regular': return 'Aportante Regular (30+ meses en últimos 36)';
        case 'irregular': return 'Aportante Irregular (18+ meses en últimos 36)';
        case 'irregular_alternativo': return 'Aportante Irregular Alternativo (12+ meses en últimos 60 + mínimo 15 años)';
        case 'no_cumple': return 'No cumple requisitos';
        default: return tipo;
      }
    }
    
    // ============ Cálculo de Retiro por Invalidez ============
    function calcularDerechoInvalidez() {
      console.log('calcularDerechoInvalidez ejecutándose...');
      
      // Helper para formatear Y/M/D
      const fmtYMD = (ymd) => `${ymd.y}a ${ymd.m}m ${ymd.d}d`;
      
      const fechaSolicitud = parseISO($('#fSol').value) || new Date();
      
      // Validar requisitos del trabajador (misma lógica que PBU)
      const requisitosTrabajador = validarRequisitosTrabajadorInvalidez(fechaSolicitud);
      if (!requisitosTrabajador.cumple) {
        mostrarResultadoInvalidez({
          cumple: false,
          motivo: requisitosTrabajador.motivo,
          fechaSolicitud,
          trabajador: requisitosTrabajador
        });
        return;
      }
      
      // Si cumple todos los requisitos
      mostrarResultadoInvalidez({
        cumple: true,
        fechaSolicitud,
        trabajador: requisitosTrabajador
      });
    }
    
    function validarRequisitosTrabajadorInvalidez(fechaSolicitud) {
      // Helper para formatear Y/M/D
      const fmtYMD = (ymd) => `${ymd.y}a ${ymd.m}m ${ymd.d}d`;
      
      // Calcular aportes del trabajador (incluyendo moratorias y beneficios)
      const {base, ap475, apEx, total} = totalAportesYMD();
      
      // PRIMER CRITERIO: Verificar si tiene 30+ años de aportes (incluyendo moratorias)
      const aportesRequeridos = {y: 30, m: 0, d: 0};
      const cumple30Anos = ymdGte(total, aportesRequeridos);
      
      if (cumple30Anos) {
        return {
          cumple: true,
          aportes: total,
          motivo: `Cumple con 30 años de aportes (${fmtYMD(total)})`,
          tipo: 'cumple_30_anos'
        };
      }
      
      // SEGUNDO CRITERIO: Si no cumple 30 años, analizar regularidades
      const regularidad = calcularRegularidadAportesInvalidez(fechaSolicitud);
      
      if (regularidad.cumple) {
        return {
          cumple: true,
          aportes: total,
          regularidad: regularidad,
          motivo: `No cumple 30 años pero cumple regularidad: ${regularidad.motivo}`,
          tipo: regularidad.tipo
        };
      }
      
      // No cumple ni 30 años ni regularidades
      return {
        cumple: false,
        aportes: total,
        regularidad: regularidad,
        motivo: `No cumple 30 años de aportes (${fmtYMD(total)}) ni requisitos de regularidad`,
        tipo: 'no_cumple'
      };
    }
    
    function calcularRegularidadAportesInvalidez(fechaSolicitud) {
      // Analizar aportes en los últimos 36 meses antes de la solicitud
      const fechaInicio36 = new Date(fechaSolicitud);
      fechaInicio36.setMonth(fechaInicio36.getMonth() - 36);
      
      // Obtener aportes que se superponen con el período de 36 meses (incluyendo moratorias y créditos)
      const aportes36Meses = state.aportes.filter(aporte => {
        if (!aporte.desde || !aporte.hasta) return false;
        // Verificar si el período del aporte se superpone con el período de 36 meses
        return aporte.desde <= fechaSolicitud && aporte.hasta >= fechaInicio36;
      });
      
      // Contar meses únicos con aportes en los últimos 36 meses
      const mesesConAportes36 = new Set();
      aportes36Meses.forEach(aporte => {
        // Para cada aporte, agregar todos los meses que se superponen con el período de 36 meses
        const inicioSuperposicion = new Date(Math.max(aporte.desde.getTime(), fechaInicio36.getTime()));
        const finSuperposicion = new Date(Math.min(aporte.hasta.getTime(), fechaSolicitud.getTime()));
        
        // Agregar cada mes del período de superposición
        const fechaActual = new Date(inicioSuperposicion);
        while (fechaActual <= finSuperposicion) {
          const mesAno = `${fechaActual.getFullYear()}-${fechaActual.getMonth()}`;
          mesesConAportes36.add(mesAno);
          fechaActual.setMonth(fechaActual.getMonth() + 1);
        }
      });
      
      const mesesAportados36 = mesesConAportes36.size;
      
      // Analizar aportes en los últimos 60 meses antes de la solicitud
      const fechaInicio60 = new Date(fechaSolicitud);
      fechaInicio60.setMonth(fechaInicio60.getMonth() - 60);
      
      const aportes60Meses = state.aportes.filter(aporte => {
        if (!aporte.desde || !aporte.hasta) return false;
        // Verificar si el período del aporte se superpone con el período de 60 meses
        return aporte.desde <= fechaSolicitud && aporte.hasta >= fechaInicio60;
      });
      
      // Contar meses únicos con aportes en los últimos 60 meses
      const mesesConAportes60 = new Set();
      aportes60Meses.forEach(aporte => {
        // Para cada aporte, agregar todos los meses que se superponen con el período de 60 meses
        const inicioSuperposicion = new Date(Math.max(aporte.desde.getTime(), fechaInicio60.getTime()));
        const finSuperposicion = new Date(Math.min(aporte.hasta.getTime(), fechaSolicitud.getTime()));
        
        // Agregar cada mes del período de superposición
        const fechaActual = new Date(inicioSuperposicion);
        while (fechaActual <= finSuperposicion) {
          const mesAno = `${fechaActual.getFullYear()}-${fechaActual.getMonth()}`;
          mesesConAportes60.add(mesAno);
          fechaActual.setMonth(fechaActual.getMonth() + 1);
        }
      });
      
      const mesesAportados60 = mesesConAportes60.size;
      const {base, ap475, apEx, total} = totalAportesYMD();
      
      // CRITERIO 1: Aportante regular (30+ meses en últimos 36)
      if (mesesAportados36 >= 30) {
        return {
          tipo: 'regular',
          mesesAportados36,
          mesesAportados60,
          cumple: true,
          motivo: `Aportante regular: ${mesesAportados36} meses con aportes en últimos 36 meses (requerido: 30)`
        };
      }
      
      // CRITERIO 2: Aportante irregular (18+ meses en últimos 36)
      if (mesesAportados36 >= 18) {
        return {
          tipo: 'irregular',
          mesesAportados36,
          mesesAportados60,
          cumple: true,
          motivo: `Aportante irregular: ${mesesAportados36} meses con aportes en últimos 36 meses (requerido: 18)`
        };
      }
      
      // CRITERIO 3: Aportante irregular alternativo (12+ meses en últimos 60 + mínimo 15 años)
      const minimoAportes = 15;
      if (mesesAportados60 >= 12 && total.y >= minimoAportes) {
        return {
          tipo: 'irregular_alternativo',
          mesesAportados36,
          mesesAportados60,
          cumple: true,
          motivo: `Aportante irregular alternativo: ${mesesAportados60} meses con aportes en últimos 60 meses (requerido: 12) y ${total.y} años totales (mínimo requerido: ${minimoAportes})`
        };
      }
      
      // No cumple ningún criterio de regularidad
      return {
        tipo: 'no_cumple',
        mesesAportados36,
        mesesAportados60,
        cumple: false,
        motivo: `No cumple requisitos de regularidad: necesita 30 meses en últimos 36 (regular), 18 meses en últimos 36 (irregular), o 12 meses en últimos 60 + ${minimoAportes} años totales (irregular alternativo)`
      };
    }
    
    function mostrarResultadoInvalidez(resultado) {
      const resumen = document.getElementById('resumen');
      
      // Helper para formatear Y/M/D
      const fmtYMD = (ymd) => `${ymd.y}a ${ymd.m}m ${ymd.d}d`;
      
      let html = `
        <div style="padding:12px;border-radius:8px;border:1px solid #cfcfcf;background:#fff">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div><b>Beneficio:</b> Retiro por Invalidez</div>
            <div style="font-size:11px;color:${resultado.cumple ? '#1a7f37' : '#a33a3a'}">
              <b>Resultado:</b> ${resultado.cumple ? 'Cumple requisitos ✅' : 'No cumple ❌'}
            </div>
          </div>
          
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">
            <div>
              <h4 style="margin:0 0 6px 0">Solicitante</h4>
              <div><b>Fecha de solicitud:</b> ${fmtDMY4(resultado.fechaSolicitud)}</div>
              <div style="margin-top:6px;color:${resultado.cumple ? '#1a7f37' : '#a33a3a'}">
                <b>Estado:</b> ${resultado.cumple ? '✅ Cumple requisitos' : '❌ No cumple requisitos'}
              </div>
            </div>
            
            <div>
              <h4 style="margin:0 0 6px 0">Trabajador</h4>
              ${resultado.trabajador ? `
                <div><b>Aportes totales:</b> ${fmtYMD(resultado.trabajador.aportes)}</div>
                <div><b>Criterio cumplido:</b> ${getCriterioTexto(resultado.trabajador.tipo)}</div>
                ${resultado.trabajador.regularidad ? `
                  <div><b>Meses en últimos 36:</b> ${resultado.trabajador.regularidad.mesesAportados36}</div>
                  <div><b>Meses en últimos 60:</b> ${resultado.trabajador.regularidad.mesesAportados60}</div>
                ` : ''}
                <div style="margin-top:6px;color:${resultado.cumple ? '#1a7f37' : '#a33a3a'}">
                  <b>Estado:</b> ${resultado.cumple ? '✅ Cumple requisitos' : '❌ No cumple requisitos'}
                </div>
              ` : ''}
            </div>
          </div>
          
          ${!resultado.cumple ? `
            <div style="margin-top:8px;padding:8px;background:#fef2f2;border-radius:4px;border-left:3px solid #dc2626">
              <div style="color:#991b1b;font-weight:600">❌ Motivo de rechazo:</div>
              <div style="font-size:11px;margin-top:4px">${resultado.motivo}</div>
            </div>
          ` : ''}
          
          ${resultado.trabajador && resultado.trabajador.regularidad ? `
            <div style="margin-top:8px;padding:8px;background:#f0f9ff;border-radius:4px;border-left:3px solid #0ea5e9">
              <div style="color:#0c4a6e;font-weight:600">📊 Análisis de Regularidad:</div>
              <div style="font-size:0.9rem;margin-top:4px">${resultado.trabajador.regularidad.motivo}</div>
            </div>
          ` : ''}
        </div>
      `;
      
      resumen.innerHTML = html;
    }
    
    // ============ Cálculo de PUAM ============
    function calcularDerechoPUAM() {
      console.log('calcularDerechoPUAM ejecutándose...');
      
      // Helper para formatear Y/M/D
      const fmtYMD = (ymd) => `${ymd.y}a ${ymd.m}m ${ymd.d}d`;
      
      const fechaSolicitud = parseISO($('#fSol').value) || new Date();
      const fechaNacimiento = parseISO($('#fNac').value);
      const fechaIngreso = parseISO($('#fIngreso').value);
      
      console.log('Fechas parseadas:', {fechaSolicitud, fechaNacimiento, fechaIngreso});
      
      if (!fechaNacimiento) {
        customAlert('Debe ingresar la fecha de nacimiento');
        return;
      }
      
      // Validar que las fechas sean válidas
      if (isNaN(fechaSolicitud.getTime())) {
        customAlert('La fecha de solicitud no es válida');
        return;
      }
      
      if (isNaN(fechaNacimiento.getTime())) {
        customAlert('La fecha de nacimiento no es válida');
        return;
      }
      
      if (fechaIngreso && isNaN(fechaIngreso.getTime())) {
        customAlert('La fecha de ingreso no es válida');
        return;
      }
      
      // Validar requisitos de PUAM
      const requisitosPUAM = validarRequisitosPUAM(fechaSolicitud, fechaNacimiento, fechaIngreso);
      
      if (!requisitosPUAM.cumple) {
        mostrarResultadoPUAM({
          cumple: false,
          motivo: requisitosPUAM.motivo,
          fechaSolicitud,
          fechaNacimiento,
          fechaIngreso,
          requisitos: requisitosPUAM
        });
        return;
      }
      
      // Si cumple todos los requisitos
      mostrarResultadoPUAM({
        cumple: true,
        fechaSolicitud,
        fechaNacimiento,
        fechaIngreso,
        requisitos: requisitosPUAM
      });
    }
    
    function validarRequisitosPUAM(fechaSolicitud, fechaNacimiento, fechaIngreso) {
      // Helper para formatear Y/M/D
      const fmtYMD = (ymd) => `${ymd.y}a ${ymd.m}m ${ymd.d}d`;
      
      console.log('validarRequisitosPUAM - Fechas recibidas:', {fechaSolicitud, fechaNacimiento, fechaIngreso});
      
      // PRIMER CRITERIO: Verificar edad (65 años)
      const edadActual = diff360(fechaNacimiento, fechaSolicitud);
      const edadRequerida = {y: 65, m: 0, d: 0};
      
      console.log('Edad calculada:', edadActual);
      
      // Validar que edadActual sea válido
      if (!edadActual || typeof edadActual.y === 'undefined') {
        console.error('Error: edadActual es undefined o no tiene propiedad y');
        return {
          cumple: false,
          motivo: 'Error al calcular la edad. Verifique las fechas ingresadas.',
          edad: {y: 0, m: 0, d: 0},
          edadRequerida: edadRequerida,
          tipo: 'error_calculo'
        };
      }
      
      if (!ymdGte(edadActual, edadRequerida)) {
        return {
          cumple: false,
          motivo: `No cumple la edad requerida: ${fmtYMD(edadActual)} (requerido: 65 años)`,
          edad: edadActual,
          edadRequerida: edadRequerida,
          tipo: 'no_cumple_edad'
        };
      }
      
      // SEGUNDO CRITERIO: Verificar residencia (solo si es extranjero)
      if (fechaIngreso) {
        const residencia = diff360(fechaIngreso, fechaSolicitud);
        const nacionalidad = $('#nacionalidad').value;
        const residenciaRequerida = {y: 20, m: 0, d: 0}; // 20 años por defecto (extranjero)
        
        // Validar que residencia sea válido
        if (!residencia || typeof residencia.y === 'undefined') {
          return {
            cumple: false,
            motivo: 'Error al calcular la residencia. Verifique las fechas ingresadas.',
            residencia: {y: 0, m: 0, d: 0},
            residenciaRequerida: residenciaRequerida,
            tipo: 'error_calculo_residencia'
          };
        }
        
        // Verificar si es argentino naturalizado (10 años) o extranjero (20 años)
        // Si es argentino nativo, no necesita residencia
        if (nacionalidad === 'AR') {
          return {
            cumple: true,
            motivo: `Cumple la edad requerida: ${fmtYMD(edadActual)} (argentino nativo, no requiere residencia)`,
            edad: edadActual,
            tipo: 'cumple_edad'
          };
        }
        
        // Si es extranjero, verificar residencia
        // Verificar si es argentino naturalizado (10 años) o extranjero (20 años)
        const esArgentinoNaturalizado = $('#chkNaturalizado').checked;
        
        if (esArgentinoNaturalizado) {
          residenciaRequerida.y = 10; // 10 años para argentino naturalizado
        }
        
        if (!ymdGte(residencia, residenciaRequerida)) {
          return {
            cumple: false,
            motivo: `No cumple la residencia requerida: ${fmtYMD(residencia)} (requerido: ${residenciaRequerida.y} años)`,
            residencia: residencia,
            residenciaRequerida: residenciaRequerida,
            tipo: 'no_cumple_residencia'
          };
        }
        
        return {
          cumple: true,
          motivo: `Cumple todos los requisitos: edad ${fmtYMD(edadActual)} y residencia ${fmtYMD(residencia)} (${esArgentinoNaturalizado ? 'argentino naturalizado' : 'extranjero'})`,
          edad: edadActual,
          residencia: residencia,
          tipo: 'cumple_todos'
        };
      }
      
      // Si no hay fecha de ingreso, solo verificar edad
      return {
        cumple: true,
        motivo: `Cumple la edad requerida: ${fmtYMD(edadActual)} (no se requiere residencia)`,
        edad: edadActual,
        tipo: 'cumple_edad'
      };
    }
    
    function mostrarResultadoPUAM(resultado) {
      const resumen = document.getElementById('resumen');
      
      // Helper para formatear Y/M/D con validación
      const fmtYMD = (ymd) => {
        if (!ymd || typeof ymd.y === 'undefined') {
          return '0a 0m 0d';
        }
        return `${ymd.y}a ${ymd.m}m ${ymd.d}d`;
      };
      
      console.log('mostrarResultadoPUAM - resultado:', resultado);
      console.log('mostrarResultadoPUAM - requisitos:', resultado.requisitos);
      
      let html = `
        <div style="padding:12px;border-radius:8px;border:1px solid #cfcfcf;background:#fff">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div><b>Beneficio:</b> PUAM (Pensión Universal para el Adulto Mayor)</div>
            <div style="font-size:11px;color:${resultado.cumple ? '#1a7f37' : '#a33a3a'}">
              <b>Resultado:</b> ${resultado.cumple ? 'Cumple requisitos ✅' : 'No cumple ❌'}
            </div>
          </div>
          
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">
            <div>
              <h4 style="margin:0 0 6px 0">Solicitante</h4>
              <div><b>Fecha de nacimiento:</b> ${fmtDMY4(resultado.fechaNacimiento)}</div>
              <div><b>Fecha de solicitud:</b> ${fmtDMY4(resultado.fechaSolicitud)}</div>
              ${resultado.fechaIngreso ? `<div><b>Fecha de ingreso:</b> ${fmtDMY4(resultado.fechaIngreso)}</div>` : ''}
              <div style="margin-top:6px;color:${resultado.cumple ? '#1a7f37' : '#a33a3a'}">
                <b>Estado:</b> ${resultado.cumple ? '✅ Cumple requisitos' : '❌ No cumple requisitos'}
              </div>
            </div>
            
            <div>
              <h4 style="margin:0 0 6px 0">Requisitos</h4>
              <div><b>Edad actual:</b> ${fmtYMD(resultado.requisitos?.edad)}</div>
              <div><b>Edad requerida:</b> 65 años</div>
              ${resultado.requisitos?.residencia ? `
                <div><b>Residencia:</b> ${fmtYMD(resultado.requisitos.residencia)}</div>
                <div><b>Residencia requerida:</b> ${resultado.requisitos.residenciaRequerida ? resultado.requisitos.residenciaRequerida.y : 20} años</div>
              ` : ''}
              <div style="margin-top:6px;color:${resultado.cumple ? '#1a7f37' : '#a33a3a'}">
                <b>Estado:</b> ${resultado.cumple ? '✅ Cumple requisitos' : '❌ No cumple requisitos'}
              </div>
            </div>
          </div>
          
          ${!resultado.cumple ? `
            <div style="margin-top:8px;padding:8px;background:#fef2f2;border-radius:4px;border-left:3px solid #dc2626">
              <div style="color:#991b1b;font-weight:600">❌ Motivo de rechazo:</div>
              <div style="font-size:11px;margin-top:4px">${resultado.motivo}</div>
            </div>
          ` : ''}
          
          ${resultado.cumple ? `
            <div style="margin-top:8px;padding:8px;background:#dcfce7;border-radius:4px;border-left:3px solid #16a34a">
              <div style="color:#166534;font-weight:600">✅ Requisitos cumplidos:</div>
              <div style="font-size:0.9rem;margin-top:4px">${resultado.motivo || 'Cumple todos los requisitos para PUAM'}</div>
            </div>
          ` : ''}
        </div>
      `;
      
      resumen.innerHTML = html;
    }

    function calcularDerecho(){
      console.log('calcularDerecho ejecutándose...');
      const beneficio = $('#beneficio').value;
      console.log('Beneficio seleccionado:', beneficio);
      
      // Si es PBU, usar lógica específica
      if (beneficio === 'Pensión de PBU') {
        console.log('Ejecutando lógica PBU');
        return calcularDerechoPBU();
      }
      
      // Si es Retiro por Invalidez, usar lógica específica
      if (beneficio === 'Retiro por Invalidez') {
        console.log('Ejecutando lógica Invalidez');
        return calcularDerechoInvalidez();
      }
      
      // Si es PUAM, usar lógica específica
      if (beneficio === 'PUAM') {
        console.log('Ejecutando lógica PUAM');
        return calcularDerechoPUAM();
      }
      
      console.log('Ejecutando lógica normal para beneficio:', beneficio);
      
      // Para otros beneficios, usar lógica normal
      const reqEdad = edadRequeridaBase();
      const reqApo = aportesRequeridosGlobal();
      const fN = parseISO($('#fNac').value);
      const fS = evalDate();
      const edadRefTxt = $('#fSol').value ? `a la fecha de solicitud (${fmtDMY2(fS)})` : `a la fecha actual (${fmtDMY2(fS)})`;
      const edadHoy = fN ? diff360(fN, fS) : {y:0,m:0,d:0};
      const {base, ap475, apEx, total, compensacionInsalubre} = totalAportesYMD();
      
      
      // Verificar si hay aportes en construcción y validar requisitos especiales
      const validacionConstruccion = validarConstruccion();
      const tieneConstruccion = validacionConstruccion.aportesConstruccion.length > 0;
      
      // Verificar si se debe aplicar prorrateo
      const usarProrrateo = $('#chkProrrateo').checked;
      let cumpleAportes = false;
      let prorrateoInfo = null;
      let edadRequeridaFinal = reqEdad;
      
      if (usarProrrateo) {
        prorrateoInfo = calcularProrrateo();
        if (prorrateoInfo) {
          if (prorrateoInfo.tipo === 'completo') {
            // Cumple completamente el régimen especial
            cumpleAportes = true;
            edadRequeridaFinal = getRequirementsFor(prorrateoInfo.regimen, $('#sexo').value).edad;
          } else if (prorrateoInfo.tipo === 'prorrateado_anses' || prorrateoInfo.tipo === 'prorrateado_anses_multi') {
            // Aplicar edad prorrateada según instructivo ANSES (simple o múltiple)
            edadRequeridaFinal = prorrateoInfo.edadProrrateada.años;
            // Usar el total completo (con moratorias) para determinar si cumple aportes
            const totalComputable = total; // total incluye moratorias y créditos
            cumpleAportes = ymdGte(totalComputable, reqApo);
            
          } else if (prorrateoInfo.tipo === 'prorrateado') {
            // Aplicar edad prorrateada (método anterior)
            edadRequeridaFinal = prorrateoInfo.edadProrrateada.años;
            // Usar el total completo (con moratorias) para determinar si cumple aportes
            const totalComputable = total; // total incluye moratorias y créditos
            cumpleAportes = ymdGte(totalComputable, reqApo);
          }
        } else {
          // Usar el total completo (con moratorias) para determinar si cumple
          const totalComputable = total; // total incluye moratorias y créditos
          cumpleAportes = ymdGte(totalComputable, reqApo);
        }
      } else {
        // Usar el total completo (con moratorias) para determinar si cumple
        const totalComputable = total; // total incluye moratorias y créditos
        cumpleAportes = ymdGte(totalComputable, reqApo);
      }
      
      // Validación especial para construcción
      if(tieneConstruccion){
        // Para construcción, verificar requisitos especiales
        const reqsConstruccion = getRequirementsConstruccion($('#sexo').value);
        edadRequeridaFinal = reqsConstruccion.edad;
        
        // Verificar si cumple los requisitos de construcción (usando total completo)
        const totalComputable = total; // total incluye moratorias y créditos
        const cumpleConstruccion = validacionConstruccion.cumple && ymdGte(totalComputable, {y:25,m:0,d:0});
        cumpleAportes = cumpleConstruccion;
      }
      
      // Calcular si cumple la edad requerida
      const cumpleEdad = edadHoy.y >= edadRequeridaFinal;
      

      // Helper para mostrar Y/M/D con formato agradable
      const fmtYMD = (ymd) => `${ymd.y}a ${ymd.m}m ${ymd.d}d`;
      // Calcular falta para aportes requeridos (total -> reqApo)
      function faltante(a,b){ // devuelve {y,m,d} si a<b else {y:0,m:0,d:0}
        const totalDaysA = (a.y*360 + a.m*30 + a.d);
        const totalDaysB = (b.y*360 + b.m*30 + b.d);
        if(totalDaysA >= totalDaysB) return {y:0,m:0,d:0};
        let diff = totalDaysB - totalDaysA;
        const y = Math.floor(diff/360); diff %= 360; const m = Math.floor(diff/30); const d = diff%30; return {y,m,d};
      }
      const falt = faltante(total, reqApo);

      const resumen = $('#resumen');
      console.log('Elemento resumen encontrado:', resumen);
      
      // Generar HTML del prorrateo si está habilitado
      let prorrateoHTML = '';
      if (usarProrrateo && prorrateoInfo) {
        if (prorrateoInfo.tipo === 'completo') {
          prorrateoHTML = `
            <div style="margin-top:12px;padding:10px;background:#dcfce7;border:1px solid #16a34a;border-radius:6px">
              <h4 style="margin:0 0 8px 0;color:#166534">✅ Régimen Especial Completo</h4>
              <div style="font-size:10px;color:#166534">
                <b>${prorrateoInfo.regimen}</b><br/>
                La persona cumple completamente los requisitos del régimen especial.
              </div>
            </div>`;
        } else if (prorrateoInfo.tipo === 'prorrateado_anses' || prorrateoInfo.tipo === 'prorrateado_anses_multi') {
          const esMulti = prorrateoInfo.tipo === 'prorrateado_anses_multi';
          const titulo = esMulti ? '📊 Prorrateo ANSES - Múltiples Regímenes Especiales' : '📊 Prorrateo según Instructivo ANSES';
          
          // Crear resumen para el summary
          const edadProrrateada = prorrateoInfo.edadProrrateada;
          const serviciosConAportes = prorrateoInfo.serviciosConAportes;
          const cumple = prorrateoInfo.cumple;
          const resumenProrrateo = `Edad: ${edadProrrateada.años}a ${edadProrrateada.meses}m ${edadProrrateada.días}d | Aportes: ${serviciosConAportes.y}a ${serviciosConAportes.m}m ${serviciosConAportes.d}d | ${cumple ? '✅ Cumple' : '❌ No cumple'}`;
          
          prorrateoHTML = `
            <details style="margin-top:12px">
              <summary style="padding:10px;background:#f0f9ff;border:1px solid #0ea5e9;border-radius:6px;color:#0c4a6e;font-weight:600">${titulo} - ${resumenProrrateo}</summary>
              <div style="padding:10px;background:#f0f9ff;border:1px solid #0ea5e9;border-top:0;border-radius:0 0 6px 6px;font-size:10px">
                
                ${esMulti ? `
                <div style="margin-bottom:8px;padding:8px;background:#e0f2fe;border-radius:4px">
                  <div><b>Regímenes Especiales Identificados:</b></div>
                  <div style="font-size:10px;color:#6b7280;margin-top:4px">
                    ${prorrateoInfo.detalle.especiales.map(reg => 
                      `<div style="margin:2px 0;padding:4px;background:#f8fafc;border-radius:3px">
                        <b>${reg.tipo}:</b> ${reg.ymd.y}a ${reg.ymd.m}m ${reg.ymd.d}d (${reg.peso}% del total especial)
                      </div>`
                    ).join('')}
                    <div style="margin-top:4px;font-weight:600">
                      <b>Total Regímenes Especiales:</b> ${prorrateoInfo.detalle.totales.diasEspeciales} días
                    </div>
                  </div>
                </div>
                ` : ''}
                
                <div style="margin-bottom:8px;padding:8px;background:#e0f2fe;border-radius:4px">
                  <div><b>1. Fórmula de Equivalencia:</b></div>
                  <div style="font-size:10px;color:#6b7280;margin-top:4px">
                    <b>TSD/I × SCR = SCE / SD/IR</b><br/>
                    ${prorrateoInfo.formulas.equivalencia.formula}<br/>
                    <small>TSD/I: ${prorrateoInfo.formulas.equivalencia.TSD_I} días | SCR: ${prorrateoInfo.formulas.equivalencia.SCR} días | SD/IR: ${prorrateoInfo.formulas.equivalencia.SD_IR} días</small>
                  </div>
                </div>
                
                <div style="margin-bottom:8px;padding:8px;background:#fef3c7;border-radius:4px">
                  <div><b>2. Cálculo de Edad Prorrateada:</b></div>
                  <div style="font-size:10px;color:#6b7280;margin-top:4px">
                    ${esMulti ? `
                    <b>Edad Ponderada Especiales:</b> ${prorrateoInfo.detalle.totales.edadPonderadaEspeciales} años<br/>
                    <b>Tiempo Diferencial:</b> ${prorrateoInfo.formulas.edad.TD_porcentaje}% × ${prorrateoInfo.formulas.edad.ER_SD} años = ${prorrateoInfo.formulas.edad.tiempo_edad_diferencial} años<br/>
                    ` : `
                    <b>Tiempo Diferencial:</b> ${prorrateoInfo.formulas.edad.TD_porcentaje}% × ${prorrateoInfo.formulas.edad.ER_SD} años = ${prorrateoInfo.formulas.edad.tiempo_edad_diferencial} años<br/>
                    `}
                    <b>Tiempo Común:</b> ${prorrateoInfo.formulas.edad.TC_porcentaje}% × ${prorrateoInfo.formulas.edad.ER_SC} años = ${prorrateoInfo.formulas.edad.tiempo_edad_comun} años<br/>
                    <b>Total:</b> ${prorrateoInfo.formulas.edad.total_edad_requerida} años = ${prorrateoInfo.edadProrrateada.años} años ${prorrateoInfo.edadProrrateada.meses} meses ${prorrateoInfo.edadProrrateada.días} días
                  </div>
                </div>
                
                <div style="margin-bottom:8px;padding:8px;background:#f3e8ff;border-radius:4px">
                  <div><b>3. Compensación por Excedente de Edad:</b></div>
                  <div style="font-size:10px;color:#6b7280;margin-top:4px">
                    ${prorrateoInfo.compensacion.y > 0 || prorrateoInfo.compensacion.m > 0 || prorrateoInfo.compensacion.d > 0 ? 
                      `Compensación aplicada: ${prorrateoInfo.compensacion.y} años ${prorrateoInfo.compensacion.m} meses ${prorrateoInfo.compensacion.d} días` : 
                      'No hay excedente de edad para compensar'}
                  </div>
                </div>
                
                <div style="margin-bottom:8px;padding:8px;background:#e0f2fe;border-radius:4px;border-left:4px solid #0ea5e9">
                  <div><b>Total Servicios con Aportes:</b> ${prorrateoInfo.serviciosConAportes.y} años ${prorrateoInfo.serviciosConAportes.m} meses ${prorrateoInfo.serviciosConAportes.d} días</div>
                  <div style="font-size:10px;color:#6b7280;margin-top:4px">
                    Incluye: ${esMulti ? 'Todos los regímenes especiales' : 'Servicios especiales'} + servicios comunes + compensación por excedente de edad
                  </div>
                </div>
                
                <div style="margin-top:8px;padding:8px;background:${prorrateoInfo.cumple?'#dcfce7':'#fef2f2'};border-radius:4px;font-weight:600;color:${prorrateoInfo.cumple?'#166534':'#991b1b'}">
                  ${prorrateoInfo.cumple ? '✅ Cumple requisitos de aportes (≥30 años)' : '❌ No cumple requisitos de aportes (<30 años)'}
                </div>
                
                ${prorrateoInfo.validaciones && prorrateoInfo.validaciones.necesitaDeclaracionJurada ? `
                <div style="margin-top:8px;padding:8px;background:#fef3c7;border-radius:4px;border-left:4px solid #f59e0b">
                  <div><b>⚠️ Declaración Jurada Requerida (Art. 38)</b></div>
                  <div style="font-size:10px;color:#6b7280;margin-top:4px">
                    Faltan ${prorrateoInfo.validaciones.serviciosFaltantes} años para completar los 30 años requeridos.<br/>
                    Se puede completar con hasta ${prorrateoInfo.validaciones.limiteDeclaracionJurada} años por declaración jurada.
                  </div>
                </div>
                ` : ''}
              </div>
            </div>`;
        } else if (prorrateoInfo.tipo === 'prorrateado') {
          // Crear resumen para el prorrateo anterior
          const edadProrrateada = prorrateoInfo.edadProrrateada;
          const cumple = prorrateoInfo.cumple;
          const resumenProrrateoAnterior = `Edad: ${edadProrrateada.años}a ${edadProrrateada.meses}m ${edadProrrateada.días}d | ${cumple ? '✅ Cumple' : '❌ No cumple'}`;
          
          prorrateoHTML = `
            <details style="margin-top:12px">
              <summary style="padding:10px;background:#f0f9ff;border:1px solid #0ea5e9;border-radius:6px;color:#0c4a6e;font-weight:600">📊 Cálculo por Prorrateo (Método Anterior) - ${resumenProrrateoAnterior}</summary>
              <div style="padding:10px;background:#f0f9ff;border:1px solid #0ea5e9;border-top:0;border-radius:0 0 6px 6px;font-size:10px">
              <h4 style="margin:0 0 8px 0;color:#0c4a6e">📊 Cálculo por Prorrateo (Método Anterior)</h4>
              <div style="font-size:10px">
                <div style="margin-bottom:8px;padding:8px;background:#e0f2fe;border-radius:4px">
                  <div><b>Régimen Especial:</b> ${prorrateoInfo.regimenEspecial}</div>
                  <div style="font-size:10px;color:#6b7280">
                    Días trabajados: ${prorrateoInfo.diasEspecial} | Requeridos: ${prorrateoInfo.diasRequeridosEspecial}<br/>
                    Porcentaje: ${prorrateoInfo.porcentajeEspecial}% | Edad: ${prorrateoInfo.detalle.especial.edad} años
                  </div>
                </div>
                <div style="margin-bottom:8px;padding:8px;background:#fef3c7;border-radius:4px">
                  <div><b>Régimen Común:</b> ${prorrateoInfo.regimenComun}</div>
                  <div style="font-size:10px;color:#6b7280">
                    Días trabajados: ${prorrateoInfo.diasComun} | Requeridos prorrateados: ${Math.round(prorrateoInfo.aportesComunRequeridos.años * 360 + prorrateoInfo.aportesComunRequeridos.meses * 30 + prorrateoInfo.aportesComunRequeridos.días)}<br/>
                    Porcentaje: ${prorrateoInfo.porcentajeComun}% | Edad: ${prorrateoInfo.detalle.comun.edad} años
                  </div>
                </div>
                <div style="margin-top:8px;padding:8px;background:#e0f2fe;border-radius:4px;border-left:4px solid #0ea5e9">
                  <div><b>Edad Jubilatoria Prorrateada:</b> ${prorrateoInfo.edadProrrateada.años} años ${prorrateoInfo.edadProrrateada.meses} meses ${prorrateoInfo.edadProrrateada.días} días</div>
                  <div style="font-size:10px;color:#6b7280">
                    Cálculo: (${prorrateoInfo.porcentajeEspecial}% × ${prorrateoInfo.detalle.especial.edad}) + (${prorrateoInfo.porcentajeComun}% × ${prorrateoInfo.detalle.comun.edad}) = ${prorrateoInfo.edadProrrateada.años} años ${prorrateoInfo.edadProrrateada.meses} meses ${prorrateoInfo.edadProrrateada.días} días
                  </div>
                </div>
                <div style="margin-top:8px;padding:8px;background:${prorrateoInfo.cumple?'#dcfce7':'#fef2f2'};border-radius:4px;font-weight:600;color:${prorrateoInfo.cumple?'#166534':'#991b1b'}">
                  ${prorrateoInfo.cumple ? '✅ Cumple requisitos de aportes' : '❌ No cumple requisitos de aportes'}
                </div>
              </div>
            </details>`;
        }
      }
      
      resumen.innerHTML = `
        <div style="padding:12px;border-radius:8px;border:1px solid #cfcfcf;background:#fff">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div><b>Beneficio:</b> ${$('#beneficio').value}</div>
            <div style="font-size:0.95rem;color:${(cumpleEdad && cumpleAportes)?'#1a7f37':'#a33a3a'}"><b>Resultado:</b> ${(cumpleEdad && cumpleAportes)?'Cumple requisitos ✅':'No cumple ❌'}</div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">
            <div>
              <h4 style="margin:0 0 6px 0">Edad</h4>
              <div><b>Referencia:</b> ${edadRefTxt}</div>
              <div><b>Edad del solicitante:</b> ${fmtYMD(edadHoy)}</div>
              <div><b>Edad requerida:</b> ${usarProrrateo && prorrateoInfo && (prorrateoInfo.tipo === 'prorrateado' || prorrateoInfo.tipo === 'prorrateado_anses' || prorrateoInfo.tipo === 'prorrateado_anses_multi') ? `${prorrateoInfo.edadProrrateada.años} años ${prorrateoInfo.edadProrrateada.meses} meses ${prorrateoInfo.edadProrrateada.días} días (prorrateada)` : `${edadRequeridaFinal} años 0 meses 0 días`}</div>
              <div style="margin-top:6px"><b>Estado edad:</b> ${cumpleEdad?'<span style="color:#1a7f37">Cumplida ✅</span>':'<span style="color:#a33a3a">No cumplida ❌</span>'}</div>
            </div>
            <div>
              <h4 style="margin:0 0 6px 0">Aportes ${usarProrrateo ? '(cálculo tradicional)' : '(desglose)'}</h4>
              <div><b>Aportes reales + moratoria:</b> ${fmtYMD(base)}</div>
              <div><b>Beneficio D.475:</b> ${fmtYMD(ap475)}</div>
              <div><b>Beneficio Exceso edad (art.19):</b> ${fmtYMD(apEx)}${usarProrrateo && prorrateoInfo && (prorrateoInfo.tipo === 'prorrateado_anses' || prorrateoInfo.tipo === 'prorrateado_anses_multi') && prorrateoInfo.compensacion && (prorrateoInfo.compensacion.y > 0 || prorrateoInfo.compensacion.m > 0 || prorrateoInfo.compensacion.d > 0) ? ' (prorrateo ANSES)' : ''}</div>
              ${(compensacionInsalubre.y > 0 || compensacionInsalubre.m > 0 || compensacionInsalubre.d > 0) ? `<div><b>Compensación régimen insalubre:</b> ${fmtYMD(compensacionInsalubre)}</div>` : ''}
              <div style="margin-top:6px"><b>Total computable:</b> ${fmtYMD(total)}</div>
              <div><b>Requerido:</b> ${usarProrrateo && prorrateoInfo && (prorrateoInfo.tipo === 'prorrateado' || prorrateoInfo.tipo === 'prorrateado_anses' || prorrateoInfo.tipo === 'prorrateado_anses_multi') ? (() => {
                if (prorrateoInfo.tipo === 'prorrateado_anses' || prorrateoInfo.tipo === 'prorrateado_anses_multi') {
                  return '30 años (según prorrateo ANSES)';
                } else {
                  console.log('Usando prorrateo, objeto:', prorrateoInfo.aportesTotalesRequeridos);
                  return fmtYMD(prorrateoInfo.aportesTotalesRequeridos);
                }
              })() : fmtYMD(reqApo)}</div>
              ${usarProrrateo && prorrateoInfo && prorrateoInfo.tipo === 'prorrateado' ? `
              <div style="margin-top:6px;padding:8px;background:#f0f9ff;border-radius:4px;border-left:3px solid #0ea5e9">
                <div style="font-size:10px;color:#6b7280">
                  <div><b>Fórmula aplicada:</b> (${prorrateoInfo.porcentajeEspecial}% × ${prorrateoInfo.detalle.especial.aportesRequeridos} años) ÷ 100 + (${prorrateoInfo.porcentajeComun}% × ${prorrateoInfo.detalle.comun.aportesRequeridos} años) ÷ 100</div>
                  <div style="margin-top:2px"><b>Tradicional:</b> ${fmtYMD(reqApo)}</div>
                </div>
              </div>
              ` : ''}
              ${usarProrrateo && prorrateoInfo && (prorrateoInfo.tipo === 'prorrateado_anses' || prorrateoInfo.tipo === 'prorrateado_anses_multi') ? `
              <div style="margin-top:6px;padding:8px;background:#f0f9ff;border-radius:4px;border-left:3px solid #0ea5e9">
                <div style="font-size:10px;color:#6b7280">
                  <div><b>Método ANSES:</b> ${prorrateoInfo.tipo === 'prorrateado_anses_multi' ? 'Múltiples regímenes especiales' : 'Servicios especiales'} + servicios comunes + compensación por excedente de edad</div>
                  <div style="margin-top:2px"><b>Total calculado:</b> ${fmtYMD(prorrateoInfo.serviciosConAportes)}</div>
                </div>
              </div>
              ` : ''}
            </div>
          </div>

          ${!usarProrrateo ? `
          <div style="margin-top:8px">
            <h4 style="margin:0 0 6px 0">Brecha</h4>
            ${ (falt.y||falt.m||falt.d) ? `<div>Faltan: <b>${fmtYMD(falt)}</b> para llegar al requisito de aportes</div>` : `<div><b>Ya cumple el requisito de aportes.</b></div>` }
          </div>
          ` : ''}

          ${prorrateoHTML}

          ${tieneConstruccion ? `
          <details style="margin-top:12px">
            <summary style="padding:10px;background:#f0f9ff;border:1px solid #0ea5e9;border-radius:6px;color:#0c4a6e;font-weight:600">🏗️ Régimen Especial Construcción (Ley 22.250)</summary>
            <div style="padding:10px;background:#f0f9ff;border:1px solid #0ea5e9;border-top:0;border-radius:0 0 6px 6px;font-size:10px">
              <div style="margin-bottom:8px;padding:8px;background:#e0f2fe;border-radius:4px">
                <div><b>Requisitos de Edad:</b></div>
                <div style="font-size:10px;color:#6b7280;margin-top:4px">
                  ${$('#sexo').value === 'F' ? 
                    'Mujeres: 55 años desde el 1/5/2009' : 
                    'Hombres: Edad variable según período (60→57→56→55 años)'
                  }
                </div>
              </div>
              
              <div style="margin-bottom:8px;padding:8px;background:#fef3c7;border-radius:4px">
                <div><b>Requisitos de Servicios:</b></div>
                <div style="font-size:10px;color:#6b7280;margin-top:4px">
                  <div>• 25 años con aportes</div>
                  <div>• Al menos 12 años de los últimos 15 trabajados en construcción</div>
                  <div style="margin-top:4px"><b>Período evaluado:</b> ${fmtDMY4(validacionConstruccion.fechaLimite)} a ${fmtDMY4(fS)}</div>
                </div>
              </div>
              
              <div style="margin-bottom:8px;padding:8px;background:#e0f2fe;border-radius:4px;border-left:4px solid #0ea5e9">
                <div><b>Años en construcción (últimos 15 años):</b> ${fmtYMD(validacionConstruccion.añosConstruccion)}</div>
                <div style="font-size:10px;color:#6b7280;margin-top:4px">
                  ${validacionConstruccion.cumple ? 
                    '✅ Cumple requisito de al menos 12 años' : 
                    '❌ No cumple requisito de al menos 12 años'
                  }
                </div>
              </div>
              
              <div style="margin-top:8px;padding:8px;background:${validacionConstruccion.cumple?'#dcfce7':'#fef2f2'};border-radius:4px;font-weight:600;color:${validacionConstruccion.cumple?'#166534':'#991b1b'}">
                ${validacionConstruccion.cumple ? '✅ Cumple requisitos especiales de construcción' : '❌ No cumple requisitos especiales de construcción'}
              </div>
            </div>
          </details>
          ` : ''}

          <hr style="margin:10px 0"/>
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><b>Conclusión:</b> ${cumpleEdad?'<span style="color:#1a7f37">Edad cumplida ✅</span>':'<span style="color:#a33a3a">Edad NO cumplida ❌</span>'} — ${cumpleAportes?'<span style="color:#1a7f37">Aportes cumplidos ✅</span>':'<span style="color:#a33a3a">Aportes NO cumplidos ❌</span>'}</div>
            <div><small style="color:#666">Última actualización: ${fmtDMY4(new Date())}</small></div>
          </div>
        </div>`;
      
      console.log('Resumen generado correctamente');
    }

    // Función para generar planificación por separado
    function generarPlanificacionSeparada() {
      console.log('Generando planificación...');
      
      // Verificar que se haya calculado el derecho primero
      const resumen = document.getElementById('resumen');
      if (!resumen || !resumen.innerHTML.trim()) {
        customAlert('Primero debe calcular el derecho antes de generar la planificación.');
        return;
      }
      
      try {
        // Obtener datos necesarios para la planificación
        const reqEdad = edadRequeridaBase();
        const reqApo = aportesRequeridosGlobal();
        const fN = parseISO($('#fNac').value);
        const fS = evalDate();
        const edadHoy = fN ? diff360(fN, fS) : {y:0,m:0,d:0};
        const {base, ap475, apEx, total, compensacionInsalubre} = totalAportesYMD();
        
        
        // Verificar si hay aportes en construcción
        const validacionConstruccion = validarConstruccion();
        const tieneConstruccion = validacionConstruccion.aportesConstruccion.length > 0;
        
        // Verificar si se debe aplicar prorrateo
        const usarProrrateo = $('#chkProrrateo').checked;
        let cumpleAportes = false;
        let edadRequeridaFinal = reqEdad;
        
        if (usarProrrateo) {
          const prorrateoInfo = calcularProrrateo();
          if (prorrateoInfo) {
            if (prorrateoInfo.tipo === 'completo') {
              cumpleAportes = true;
              edadRequeridaFinal = getRequirementsFor(prorrateoInfo.regimen, $('#sexo').value).edad;
          } else if (prorrateoInfo.tipo === 'prorrateado_anses' || prorrateoInfo.tipo === 'prorrateado_anses_multi') {
            edadRequeridaFinal = prorrateoInfo.edadProrrateada.años;
            // Usar el total completo (con moratorias) para determinar si cumple aportes
            const totalComputable = total; // total incluye moratorias y créditos
            cumpleAportes = ymdGte(totalComputable, reqApo);
            
          } else if (prorrateoInfo.tipo === 'prorrateado') {
            edadRequeridaFinal = prorrateoInfo.edadProrrateada.años;
            // Usar el total completo (con moratorias) para determinar si cumple aportes
            const totalComputable = total; // total incluye moratorias y créditos
            cumpleAportes = ymdGte(totalComputable, reqApo);
            }
          } else {
            // Usar el total completo (con moratorias) para determinar si cumple aportes
            const totalComputable = total; // total incluye moratorias y créditos
            cumpleAportes = ymdGte(totalComputable, reqApo);
          }
        } else {
          // Usar el total completo (con moratorias) para determinar si cumple aportes
          const totalComputable = total; // total incluye moratorias y créditos
          cumpleAportes = ymdGte(totalComputable, reqApo);
        }
        
        // Validación especial para construcción
        if(tieneConstruccion){
          const reqsConstruccion = getRequirementsConstruccion($('#sexo').value);
          edadRequeridaFinal = reqsConstruccion.edad;
          // Usar el total completo (con moratorias) para determinar si cumple aportes
          const totalComputable = total; // total incluye moratorias y créditos
          const cumpleConstruccion = validacionConstruccion.cumple && ymdGte(totalComputable, {y:25,m:0,d:0});
          cumpleAportes = cumpleConstruccion;
        }
        
        // Calcular si cumple la edad requerida
        const cumpleEdad = edadHoy.y >= edadRequeridaFinal;
        
        // Generar la planificación
        const planificacionHTML = generarPlanificacion({
            cumple: cumpleEdad && cumpleAportes,
            cumpleEdad,
            cumpleAportes,
            edadActual: edadHoy.y,
            edadRequeridaFinal,
            total,
            tieneConstruccion,
            validacionConstruccion,
            fS,
            sexo: $('#sexo').value
        });
        
        // Mostrar la planificación en el contenedor
        const planificacionContainer = document.getElementById('planificacion');
        planificacionContainer.innerHTML = planificacionHTML;
        
        console.log('Planificación generada correctamente');
        
      } catch (error) {
        console.error('Error al generar la planificación:', error);
        customAlert('Error al generar la planificación: ' + error.message);
      }
    }

    // ============ Edad (apartado) ==========
    function updateEdadActual(){
      const box=$('#edadCalc');
      const fN=parseISO($('#fNac').value);
      const fS=evalDate();
      if(!fN){ box.textContent='Complete fecha de nacimiento para calcular.'; return }
      const edad=diff360(fN,fS);
      const refTxt=$('#fSol').value?`a la fecha de solicitud (${fmtDMY2(fS)})`:`a la fecha actual (${fmtDMY2(fS)})`;
      // Fecha en que cumplió 18 años
      const f18 = new Date(fN.getTime()); f18.setFullYear(f18.getFullYear()+18);
      box.innerHTML=`<b>Edad ${refTxt}:</b> ${edad.y} años, ${edad.m} meses y ${edad.d} días.<br/><small>Cumplió 18 años el: ${fmtDMY4(f18)}</small>`;
    }

    // ============ Helpers de recálculo en vivo ==========
    function recalcDurationForRow(row){
      const d=parseISO(row.querySelector('input[data-field="desde"], #new-desde')?.value);
      const h=parseISO(row.querySelector('input[data-field="hasta"], #new-hasta')?.value);
      const outCell = row.querySelector('.dur-cell');
      const yy = row.querySelector('#new-y');
      if(!d||!h||h<d){
        if(outCell) outCell.textContent='—';
        if(yy){
          // Solo mostrar ceros, no modificar el valor del input ni limpiar campos
          row.querySelector('#new-y').textContent='0';
          row.querySelector('#new-m').textContent='0';
          row.querySelector('#new-d').textContent='0';
        }
        // No return aquí, así el usuario puede seguir editando el campo normalmente
        return;
      }
      const ymd = diff360(d,h);
      if(outCell) outCell.textContent = `${ymd.y}a ${ymd.m}m ${ymd.d}d`;
      if(yy){
        row.querySelector('#new-y').textContent=ymd.y;
        row.querySelector('#new-m').textContent=ymd.m;
        row.querySelector('#new-d').textContent=ymd.d;
      }
    }

    // ============ Listeners ==========
    document.addEventListener('DOMContentLoaded', ()=>{
      // Populate service types dropdown
      const tipoSelect = document.getElementById('new-tipo');
      tipoSelect.innerHTML = SERVICE_TYPES.map(t => `<option value="${t}">${t}</option>`).join('');

      // Function to update requirements based on selected type and sex
      function updateRequirements() {
        const tipo = document.getElementById('new-tipo').value;
        const sexo = document.getElementById('sexo').value;
        const reqs = getRequirementsFor(tipo, sexo);
        document.getElementById('new-edadreq').value = reqs.edad;
        document.getElementById('new-apreq').value = reqs.ap;
      }

      // Add event listeners to update requirements dynamically
      document.getElementById('new-tipo').addEventListener('change', updateRequirements);
      document.getElementById('sexo').addEventListener('change', updateRequirements);

      // Initial call to set default values
      updateRequirements();

      // Se eliminan los listeners que ocultaban secciones: todo visible por defecto
  ['hNacidos','hAdoptados','hDisc','hAUH'].forEach(id=>{ const el=document.getElementById(id); if(!el) return; el.addEventListener('input', ()=>{ update475Pill(); render(); }); });
  ['fNac','fSol','sexo','beneficio'].forEach(id=>{ const el=document.getElementById(id); if(!el) return; el.addEventListener('change', ()=>{ updateExcesoPill(); updateInsalubrePill(); updateEdadActual(); updateRequirementsInTable(); render(); }); });
  
  // Controlar visibilidad del checkbox de naturalizado
  document.getElementById('nacionalidad').addEventListener('change', ()=>{
    const nacionalidad = document.getElementById('nacionalidad').value;
    const boxNaturalizado = document.getElementById('boxNaturalizado');
    const chkNaturalizado = document.getElementById('chkNaturalizado');
    
    if (nacionalidad === 'EX') {
      boxNaturalizado.style.display = 'block';
    } else {
      boxNaturalizado.style.display = 'none';
      chkNaturalizado.checked = false;
    }
  });
  
  // Controlar visibilidad de la sección de aportes
  function toggleSeccionAportes() {
    const beneficio = document.getElementById('beneficio').value;
    const seccionAportes = document.getElementById('seccionAportes');
    
    if (beneficio === 'PUAM') {
      seccionAportes.style.display = 'none';
    } else {
      seccionAportes.style.display = 'block';
    }
  }
  
  // Event listener para el cambio de beneficio
  document.getElementById('beneficio').addEventListener('change', toggleSeccionAportes);
  
  // Llamar la función al cargar la página
  toggleSeccionAportes();
  
  
  // Event listener para el checkbox de prorrateo
  document.getElementById('chkProrrateo').addEventListener('change', ()=>{
    // Actualizar las filas computadas (especialmente la línea de excedente de edad)
    syncComputedRows();
    render();
    
    // Si hay un resumen calculado, recalcular automáticamente
    if(document.getElementById('resumen').innerHTML.trim()) {
      calcularDerecho();
    }
  });

      // Alta desde la fila nueva
      const newRowInputs = ['new-desde','new-hasta','new-razon','new-caja','new-tipo','new-edadreq','new-apreq'];
      newRowInputs.forEach(id=>{
        const el=document.getElementById(id); if(!el) return;
        el.addEventListener('input', ()=>{ recalcDurationForRow(document.querySelector('thead tr.newrow')); });
        el.addEventListener('change', ()=>{ recalcDurationForRow(document.querySelector('thead tr.newrow')); });
      });
      document.getElementById('btnAddRow').addEventListener('click', async ()=>{
        const d=parseISO(document.getElementById('new-desde').value);
        const h=parseISO(document.getElementById('new-hasta').value);
        if(!d||!h||h<d){ await showModal('Fechas inválidas.'); return }
        let nuevo={desde:d,hasta:h};
        let perBase={ razon: document.getElementById('new-razon').value||'', caja: document.getElementById('new-caja').value, tipo: document.getElementById('new-tipo').value, edadReq: parseInt(document.getElementById('new-edadreq').value||'0',10), apReq: parseInt(document.getElementById('new-apreq').value||'0',10), esMoratoria:false };
        if(tieneSolapamiento(nuevo)){
            const overl = state.aportes.filter(p=>p.desde && p.hasta && !p.esCredito && cmpRanges({desde:p.desde,hasta:p.hasta}, nuevo));
          const ans = await showConfirmModal(`Se detectaron períodos superpuestos. ¿Desea que el sistema ajuste automáticamente el nuevo período para evitar superposición?\n(Cancelar = editar manualmente).`);
          if(!ans) return;
          let piezas = subtractRanges(nuevo, overl.map(p=>({desde:p.desde, hasta:p.hasta})));
          if(piezas.length===0){ await showModal('Edite las fechas para resolver la superposición.'); return }
          piezas.sort((a,b)=> (b.hasta-b.desde)-(a.hasta-a.desde));
          // Agregar todos los tramos no superpuestos
          for(const tramo of piezas){
            let per = { id: state.seq++, desde: tramo.desde, hasta: tramo.hasta, ...perBase };
            per.ymd = periodoYMD(per.desde, per.hasta);
            state.aportes.push(per);
          }
          await showModal(`Período ajustado automáticamente a: ${piezas.map(f=>fmtDMY4(f.desde)+" a "+fmtDMY4(f.hasta)).join(", ")}.`);
        } else {
          let per = { id: state.seq++, desde: d, hasta: h, ...perBase };
          per.ymd = periodoYMD(per.desde, per.hasta);
          state.aportes.push(per);
        }
        // limpiar fila nueva
        document.getElementById('new-desde').value='';
        document.getElementById('new-hasta').value='';
        document.getElementById('new-razon').value='';
        // Actualizar los valores según el tipo de servicio seleccionado
        updateRequirements();
        document.getElementById('new-y').textContent='0';
        document.getElementById('new-m').textContent='0';
        document.getElementById('new-d').textContent='0';
        render();
      });

      // Delegación de eventos para acciones en filas (editar/guardar/cancelar/borrar)
      document.getElementById('aportesBody').addEventListener('click', async (e)=>{
        const btn=e.target.closest('button'); if(!btn) return;
        // Intentamos obtener el id del botón o, en su defecto, del <tr>
        let id = Number.parseInt(btn.getAttribute('data-id')||'',10);
        if(Number.isNaN(id)){
          const tr = btn.closest('tr');
          if(tr && tr.getAttribute('data-id')) id = Number.parseInt(tr.getAttribute('data-id'),10);
        }
        const idx = state.aportes.findIndex(x=>x.id===id);
        if(idx===-1) return;
        const p=state.aportes[idx];
        const act = btn.getAttribute('data-act');
        if(act==='del'){
          const ok = await showConfirmModal('Eliminar período?','Eliminar','Cancelar');
          if(!ok) return;
          // Si es una fila generada, marcamos como deshabilitada para que no se regenere automáticamente
          if(p.generatedType==='D475'){
            state.computedDisabled.D475 = true;
            state.aportes = state.aportes.filter(x=>x.generatedType!=='D475');
            render();
            return;
          }
          if(p.generatedType==='EX'){
            state.computedDisabled.EX = true;
            state.aportes = state.aportes.filter(x=>x.generatedType!=='EX');
            render();
            return;
          }
          // fila normal
          state.aportes.splice(idx,1); render();
          return;
        }
        if(act==='edit'){
          state.aportes.forEach(x=>x._editing=false);
          p._editing=true; render(); return;
        }
        if(act==='cancel'){
          p._editing=false; render(); return;
        }
        if(act==='save'){
          const row = btn.closest('tr');
          const getVal = (sel)=> row.querySelector(sel)?.value ?? '';
          const d=parseISO(getVal('input[data-field="desde"]'));
          const h=parseISO(getVal('input[data-field="hasta"]'));
          if(!d||!h||h<d){ await showModal('Fechas inválidas'); return }
          
          // Verificar solapamiento excluyendo el período que se está editando
          if(tieneSolapamiento({desde:d,hasta:h}, p.id)){
            await showModal('Las nuevas fechas se superponen con otros períodos.'); return;
          }
          
          p.desde=d; p.hasta=h; p.razon=getVal('input[data-field="razon"]');
          p.caja=row.querySelector('select[data-field="caja"]').value;
          p.tipo=row.querySelector('select[data-field="tipo"]').value;
          p.edadReq=parseInt(getVal('input[data-field="edadReq"]')||'0',10);
          p.apReq=parseInt(getVal('input[data-field="apReq"]')||'0',10);
          p.ymd=periodoYMD(d,h);
          p._editing=false; render(); return;
        }
      });

      // Recálculo en vivo dentro de filas en edición
      document.getElementById('aportesBody').addEventListener('input', (e)=>{
        const row = e.target.closest('tr'); if(!row) return; if(!row.querySelector('.dur-cell')) return; recalcDurationForRow(row);
      });
      
      // Actualizar requisitos cuando se cambia el tipo de servicio en edición
      document.getElementById('aportesBody').addEventListener('change', (e)=>{
        if (e.target.getAttribute('data-field') === 'tipo') {
          const row = e.target.closest('tr');
          if (!row || !row.querySelector('.dur-cell')) return; // Solo en filas editables
          
          const tipo = e.target.value;
          const sexo = $('#sexo').value;
          const fechaInput = row.querySelector('input[data-field="hasta"]');
          const fechaAporte = fechaInput ? parseISO(fechaInput.value) : null;
          const reqs = getRequirementsFor(tipo, sexo, fechaAporte);
          
          // Actualizar los campos de edad y aportes requeridos
          const edadReqInput = row.querySelector('input[data-field="edadReq"]');
          const apReqInput = row.querySelector('input[data-field="apReq"]');
          
          if (edadReqInput) edadReqInput.value = reqs.edad;
          if (apReqInput) apReqInput.value = reqs.ap;
        }
      });

      document.getElementById('btnAutoMoratoria').addEventListener('click', (e)=>{ e.preventDefault(); cargarMoratoriaAuto(); });
      document.getElementById('btnQuitarMoratoria').addEventListener('click', (e)=>{ e.preventDefault(); quitarMoratorias(); });
  document.getElementById('btnRestoreD475').addEventListener('click', (e)=>{ e.preventDefault(); state.computedDisabled.D475=false; syncComputedRows(); render(); });
  document.getElementById('btnRestoreEX').addEventListener('click', (e)=>{ e.preventDefault(); state.computedDisabled.EX=false; syncComputedRows(); render(); });
    document.getElementById('btnCalcular').addEventListener('click', (e)=>{ 
      console.log('Botón Calcular Derecho clickeado');
      e.preventDefault(); 
      try {
        // Mostrar la sección de Derecho
        const seccionDerecho = document.getElementById('seccionDerecho');
        if (seccionDerecho) {
          seccionDerecho.style.display = 'block';
        }
        calcularDerecho(); 
      } catch (error) {
        console.error('Error en calcularDerecho:', error);
        customAlert('Error al calcular el derecho: ' + error.message);
      }
    });
    
    document.getElementById('btnPlanificacion').addEventListener('click', (e)=>{ 
      console.log('Botón Generar Planificación clickeado');
      e.preventDefault(); 
      try {
        generarPlanificacionSeparada(); 
      } catch (error) {
        console.error('Error en generarPlanificacionSeparada:', error);
        customAlert('Error al generar la planificación: ' + error.message);
      }
    });
    document.getElementById('btnExportResumen').addEventListener('click', (e)=>{ e.preventDefault(); exportResumen(); });
    document.getElementById('btnCopyResumen').addEventListener('click', (e)=>{ e.preventDefault(); copyResumen(); });

      // Botón imprimir
      document.getElementById('btnImprimir').addEventListener('click', function() {
        console.log('Botón de imprimir clickeado');
        imprimirReporte();
      });

      // ============ Funcionalidad para campos PBU ============
      function togglePBUFields() {
        const beneficio = $('#beneficio').value;
        const pbuFields = document.getElementById('pbuFields');
        
        if (beneficio === 'Pensión de PBU') {
          pbuFields.style.display = 'block';
        } else {
          pbuFields.style.display = 'none';
        }
      }
      
      function toggleBeneficiarioFields() {
        const tipoBeneficiario = $('#tipoBeneficiario').value;
        const convivienteFields = document.getElementById('convivienteFields');
        const hijoFields = document.getElementById('hijoFields');
        
        // Ocultar todos los campos específicos
        convivienteFields.style.display = 'none';
        hijoFields.style.display = 'none';
        
        // Mostrar campos según el tipo
        if (tipoBeneficiario === 'conviviente') {
          convivienteFields.style.display = 'block';
        } else if (tipoBeneficiario === 'hijo') {
          hijoFields.style.display = 'block';
        }
        // Para cónyuge no se muestran campos adicionales
      }
      
      // Event listeners para PBU
      document.getElementById('beneficio').addEventListener('change', togglePBUFields);
      document.getElementById('tipoBeneficiario').addEventListener('change', toggleBeneficiarioFields);
      
      // ============ Sistema completo de atajos de teclado ============
      
      // Función para agregar indicadores de atajos a los botones
      function addShortcutIndicators() {
        const shortcuts = {
          'btnCalcular': 'F5',
          'btnPlanificacion': 'Ctrl+P',
          'btnImprimir': 'F6',
          'btnExportResumen': 'F10',
          'btnCopyResumen': 'F11',
          'btnAutoMoratoria': 'F8',
          'btnQuitarMoratoria': 'F9',
          'btnAddRow': 'Ctrl+Enter',
          'btnRestoreD475': 'Ctrl+D',
          'btnRestoreEX': 'Ctrl+E',
          'newComputation': 'F2',
          'saveComputation': 'F3',
          'openComputation': 'F4',
          'clearAll': 'F7',
          'resetForm': 'Ctrl+R',
          'fullScreen': 'F12',
          'helpContent': 'F1'
        };
        
        Object.entries(shortcuts).forEach(([buttonId, shortcut]) => {
          const button = document.getElementById(buttonId);
          if (button) {
            const indicator = document.createElement('span');
            indicator.className = 'shortcut-indicator';
            indicator.textContent = shortcut;
            button.appendChild(indicator);
          }
        });
      }
      
      // Función para mostrar ayuda de atajos
      function showShortcutsHelp() {
        const helpText = `
LEX▲R - Atajos de Teclado

📋 FUNCIONES PRINCIPALES:
F1 - Ayuda (este menú)
F2 - Nuevo cómputo
F3 - Guardar cómputo
F4 - Abrir cómputo
F5 - Calcular derecho
F6 - Imprimir reporte
F7 - Limpiar todo
F8 - Cargar moratoria
F9 - Quitar moratorias
F10 - Exportar resumen
F11 - Copiar resumen
F12 - Pantalla completa

⌨️ COMBINACIONES:
Ctrl+Enter - Añadir período
Ctrl+D - Restaurar D.475/21
Ctrl+E - Restaurar Art. 19
Ctrl+R - Restablecer formulario
Ctrl+N - Nuevo cómputo
Ctrl+S - Guardar cómputo
Ctrl+O - Abrir cómputo
Ctrl+P - Imprimir reporte
Ctrl+C - Copiar resumen
Ctrl+E - Exportar resumen

💡 TIP: Los atajos se muestran en la esquina superior derecha de cada botón
        `;
        customAlert(helpText);
      }
      
      // Event listener para atajos de teclado
      document.addEventListener('keydown', (e) => {
        // Solo procesar si no estamos en un input, textarea o select
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
          return;
        }
        
        const isCtrl = e.ctrlKey;
        const isShift = e.shiftKey;
        const isAlt = e.altKey;
        
        // Función para ejecutar acción de botón
        function triggerButton(buttonId) {
          const button = document.getElementById(buttonId);
          if (button) {
            button.click();
            return true;
          }
          return false;
        }
        
        // Atajos de función (F1-F12)
        if (e.key.startsWith('F') && e.key.length <= 3) {
          e.preventDefault();
          const fNumber = parseInt(e.key.substring(1));
          
          switch(fNumber) {
            case 1: // F1 - Ayuda
              showShortcutsHelp();
              break;
            case 2: // F2 - Nuevo cómputo
              if (confirm('¿Está seguro de que desea crear un nuevo cómputo? Se perderán los datos no guardados.')) {
                location.reload();
              }
              break;
            case 3: // F3 - Guardar cómputo
              const computationName = prompt('Ingrese un nombre para el cómputo:');
              if (computationName) {
                saveCurrentComputation(computationName);
              }
              break;
            case 4: // F4 - Abrir cómputo
              const savedComputations = JSON.parse(localStorage.getItem('lexarComputations') || '[]');
              if (savedComputations.length === 0) {
                customAlert('No hay cómputos guardados');
                return;
              }
              
              const computationList = savedComputations.map((comp, index) => 
                `${index + 1}. ${comp.name} - ${comp.employeeName}`
              ).join('\n');
              
              const selection = prompt(`Cómputos guardados:\n${computationList}\n\nIngrese el número del cómputo a abrir:`);
              const index = parseInt(selection) - 1;
              
              if (index >= 0 && index < savedComputations.length) {
                loadComputation(savedComputations[index]);
              }
              break;
            case 5: // F5 - Calcular derecho
              try {
                calcularDerecho();
              } catch (error) {
                console.error('Error en calcularDerecho:', error);
                customAlert('Error al calcular el derecho: ' + error.message);
              }
              break;
            case 6: // F6 - Imprimir reporte
              imprimirReporte();
              break;
            case 7: // F7 - Limpiar todo
              if (confirm('¿Está seguro de que desea limpiar todos los campos?')) {
                clearAllFields();
              }
              break;
            case 8: // F8 - Cargar moratoria
              cargarMoratoriaAuto();
              break;
            case 9: // F9 - Quitar moratorias
              quitarMoratorias();
              break;
            case 10: // F10 - Exportar resumen
              exportResumen();
              break;
            case 11: // F11 - Copiar resumen
              copyResumen();
              break;
            case 12: // F12 - Pantalla completa
              if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
              } else {
                document.exitFullscreen();
              }
              break;
          }
        }
        
        // Combinaciones con Ctrl
        else if (isCtrl && !isShift && !isAlt) {
          switch(e.key.toLowerCase()) {
            case 'enter':
              e.preventDefault();
              triggerButton('btnAddRow');
              break;
            case 'd':
              e.preventDefault();
              triggerButton('btnRestoreD475');
              break;
            case 'e':
              e.preventDefault();
              triggerButton('btnRestoreEX');
              break;
            case 'r':
              e.preventDefault();
              if (confirm('¿Está seguro de que desea restablecer el formulario?')) {
                location.reload();
              }
              break;
            case 'n':
              e.preventDefault();
              if (confirm('¿Está seguro de que desea crear un nuevo cómputo? Se perderán los datos no guardados.')) {
                location.reload();
              }
              break;
            case 's':
              e.preventDefault();
              const computationName = prompt('Ingrese un nombre para el cómputo:');
              if (computationName) {
                saveCurrentComputation(computationName);
              }
              break;
            case 'o':
              e.preventDefault();
              const savedComputations = JSON.parse(localStorage.getItem('lexarComputations') || '[]');
              if (savedComputations.length === 0) {
                customAlert('No hay cómputos guardados');
                return;
              }
              
              const computationList = savedComputations.map((comp, index) => 
                `${index + 1}. ${comp.name} - ${comp.employeeName}`
              ).join('\n');
              
              const selection = prompt(`Cómputos guardados:\n${computationList}\n\nIngrese el número del cómputo a abrir:`);
              const index = parseInt(selection) - 1;
              
              if (index >= 0 && index < savedComputations.length) {
                loadComputation(savedComputations[index]);
              }
              break;
            case 'p':
              e.preventDefault();
              generarPlanificacionSeparada();
              break;
            case 'c':
              e.preventDefault();
              copyResumen();
              break;
          }
        }
      });
      
      // Agregar indicadores de atajos a los botones
      addShortcutIndicators();

      render();
    });
    
    // Función para mostrar/ocultar comandos de teclado
    function toggleShortcutsVisibility() {
      const shortcuts = document.querySelectorAll('.shortcut-indicator');
      const toggleBtn = document.getElementById('toggleShortcuts');
      
      if (shortcuts.length > 0 && shortcuts[0].style.display !== 'none') {
        // Ocultar indicadores
        shortcuts.forEach(indicator => {
          indicator.style.display = 'none';
        });
        toggleBtn.textContent = '⌨️ Mostrar Comandos';
      } else {
        // Mostrar indicadores
        shortcuts.forEach(indicator => {
          indicator.style.display = 'inline';
        });
        toggleBtn.textContent = '⌨️ Ocultar Comandos';
      }
    }

// Imprimir reporte completo con datos del formulario
function imprimirReporte() {
  console.log('Iniciando función imprimirReporte()');
  
  try {
  // Recopilar datos del formulario
  const datosFormulario = {
      nombre: document.getElementById('nombre')?.value || '',
      cuil: document.getElementById('cuil')?.value || '',
      beneficio: document.getElementById('beneficio')?.value || '',
      sexo: document.getElementById('sexo')?.value || '',
      nacionalidad: document.getElementById('nacionalidad')?.value || '',
      fIngreso: document.getElementById('fIngreso')?.value || '',
      fNac: document.getElementById('fNac')?.value || '',
      fFall: document.getElementById('fFall')?.value || '',
      fSol: document.getElementById('fSol')?.value || '',
      hNacidos: document.getElementById('hNacidos')?.value || '0',
      hAdoptados: document.getElementById('hAdoptados')?.value || '0',
      hDisc: document.getElementById('hDisc')?.value || '0',
      hAUH: document.getElementById('hAUH')?.value || '0'
    };
    
    console.log('Datos del formulario:', datosFormulario);

    // Crear contenido del reporte optimizado para una página
  const reporteHTML = `
      <div style="font-family: Arial, sans-serif; padding: 8px; font-size: 10px; line-height: 1.2; max-width: 100%;">
        <!-- Encabezado compacto -->
        <div style="text-align: center; margin-bottom: 8px; border-bottom: 1px solid #333; padding-bottom: 5px;">
          <h1 style="margin: 0; color: #333; font-size: 14px;">LEX▲R - Cómputo de derecho Previsional</h1>
          <p style="margin: 2px 0 0 0; font-size: 9px; color: #666;">Reporte: ${new Date().toLocaleDateString('es-ES')} ${new Date().toLocaleTimeString('es-ES')}</p>
        </div>
        
        <!-- Datos para el cálculo - Compacto -->
        <div style="margin-bottom: 8px; padding: 6px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 2px;">
          <h2 style="margin: 0 0 6px 0; color: #333; font-size: 11px; border-bottom: 1px solid #ccc; padding-bottom: 2px;">1. Datos del cálculo</h2>
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 4px; font-size: 9px;">
            <div><strong>Nombre:</strong> ${datosFormulario.nombre || 'No especificado'}</div>
            <div><strong>CUIL:</strong> ${datosFormulario.cuil || 'No especificado'}</div>
            <div><strong>Beneficio:</strong> ${datosFormulario.beneficio || 'No especificado'}</div>
            <div><strong>Sexo:</strong> ${datosFormulario.sexo === 'M' ? 'Masculino' : datosFormulario.sexo === 'F' ? 'Femenino' : 'No especificado'}</div>
          <div><strong>Nacionalidad:</strong> ${datosFormulario.nacionalidad === 'AR' ? 'Argentina' : 'Extranjera'}</div>
          ${datosFormulario.fIngreso ? `<div><strong>Ingreso país:</strong> ${datosFormulario.fIngreso}</div>` : ''}
            <div><strong>F. nacimiento:</strong> ${datosFormulario.fNac || 'No especificada'}</div>
            ${datosFormulario.fFall ? `<div><strong>F. fallecimiento:</strong> ${datosFormulario.fFall}</div>` : ''}
            <div><strong>F. solicitud:</strong> ${datosFormulario.fSol || 'Fecha actual'}</div>
        </div>
        
        ${datosFormulario.sexo === 'F' ? `
          <div style="margin-top: 6px; padding: 4px; background: #e9ecef; border-radius: 2px;">
            <h3 style="margin: 0 0 4px 0; color: #333; font-size: 10px;">Decreto 475/2021 (solo mujeres)</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 4px; font-size: 9px;">
              <div><strong>Hijos nacidos:</strong> ${datosFormulario.hNacidos}</div>
            <div><strong>Hijos adoptados:</strong> ${datosFormulario.hAdoptados}</div>
            <div><strong>Hijos con discapacidad:</strong> ${datosFormulario.hDisc}</div>
              <div><strong>Hijos con AUH:</strong> ${datosFormulario.hAUH}</div>
          </div>
        </div>
        ` : ''}
      </div>

        <!-- Tabla de aportes - Compacta -->
        <div style="margin-bottom: 8px;">
          <h2 style="margin: 0 0 6px 0; color: #333; font-size: 11px; border-bottom: 1px solid #ccc; padding-bottom: 2px;">2. Tabla de aportes</h2>
          <div style="overflow-x: auto; font-size: 8px; max-width: 100%;">
            ${(() => {
              const tabla = document.querySelector('table');
              if (!tabla) return '<p style="font-size: 9px;">No hay datos de aportes cargados</p>';
              
              // Crear una nueva tabla solo con las filas de datos (excluir fila de carga y botones)
              const thead = tabla.querySelector('thead');
              const tbody = tabla.querySelector('tbody');
              const tfoot = tabla.querySelector('tfoot');
              
              if (!thead) return '<p style="font-size: 9px;">No hay datos de aportes cargados</p>';
              
              // Filtrar la fila de carga (newrow) del thead
              const headerRows = Array.from(thead.querySelectorAll('tr')).filter(tr => !tr.classList.contains('newrow'));
              
              // Crear nueva tabla limpia
              let nuevaTabla = '<table style="width: 100%; max-width: 100%; table-layout: fixed; font-size: 7px; border-collapse: collapse;">';
              
              // Agregar encabezados (solo la primera fila, sin la fila de carga, sin columna de acciones)
              if (headerRows.length > 0) {
                nuevaTabla += '<thead>';
                headerRows.forEach(tr => {
                  const filaLimpia = tr.cloneNode(true);
                  // Remover la última columna (Acciones)
                  const celdas = filaLimpia.querySelectorAll('th');
                  if (celdas.length > 0) {
                    celdas[celdas.length - 1].remove();
                  }
                  
                  const filaHTML = filaLimpia.outerHTML
                    .replace(/style="[^"]*"/g, '')
                    .replace(/<th/g, '<th style="border: 1px solid #ddd; padding: 1px 2px; background-color: #f2f2f2; font-weight: bold; font-size: 7px;"');
                  
                  nuevaTabla += filaHTML;
                });
                nuevaTabla += '</thead>';
              }
              
              // Agregar filas de datos (sin botones y sin columna de acciones)
              if (tbody && tbody.children.length > 0) {
                nuevaTabla += '<tbody>';
                Array.from(tbody.children).forEach(tr => {
                  // Remover botones y la última columna (Acciones)
                  const filaLimpia = tr.cloneNode(true);
                  const botones = filaLimpia.querySelectorAll('button');
                  botones.forEach(btn => btn.remove());
                  
                  // Remover la última celda (columna de acciones)
                  const celdas = filaLimpia.querySelectorAll('td');
                  if (celdas.length > 0) {
                    celdas[celdas.length - 1].remove();
                  }
                  
                  // Limpiar estilos y aplicar estilos de reporte
                  const filaHTML = filaLimpia.outerHTML
                    .replace(/style="[^"]*"/g, '')
                    .replace(/<td/g, '<td style="border: 1px solid #ddd; padding: 1px 2px; font-size: 7px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"');
                  
                  nuevaTabla += filaHTML;
                });
                nuevaTabla += '</tbody>';
              }
              
              // Agregar pie de tabla (totales, sin columna de acciones)
              if (tfoot) {
                nuevaTabla += '<tfoot>';
                Array.from(tfoot.children).forEach(tr => {
                  const filaLimpia = tr.cloneNode(true);
                  // Remover la última celda (columna de acciones)
                  const celdas = filaLimpia.querySelectorAll('td');
                  if (celdas.length > 0) {
                    celdas[celdas.length - 1].remove();
                  }
                  
                  const filaHTML = filaLimpia.outerHTML
                    .replace(/style="[^"]*"/g, '')
                    .replace(/<td/g, '<td style="border: 1px solid #ddd; padding: 1px 2px; font-size: 7px; font-weight: bold; background-color: #f2f2f2;"');
                  
                  nuevaTabla += filaHTML;
                });
                nuevaTabla += '</tfoot>';
              }
              
              nuevaTabla += '</table>';
              return nuevaTabla;
            })()}
          </div>
      </div>

        <!-- Resultado del cálculo - Compacto -->
        <div style="margin-bottom: 8px;">
          <h2 style="margin: 0 0 6px 0; color: #333; font-size: 11px; border-bottom: 1px solid #ccc; padding-bottom: 2px;">3. Resultado del cálculo</h2>
          <div style="font-size: 9px;">
            ${document.getElementById('resumen') && document.getElementById('resumen').innerHTML ? document.getElementById('resumen').innerHTML : '<p>No se ha realizado el cálculo</p>'}
          </div>
        </div>

        <!-- Planificación si existe - Compacta -->
        ${document.querySelector('[style*="Planificación"]') ? `
        <div style="margin-bottom: 8px;">
          <h2 style="margin: 0 0 6px 0; color: #333; font-size: 11px; border-bottom: 1px solid #ccc; padding-bottom: 2px;">4. Planificación</h2>
          <div style="font-size: 9px;">
            ${document.querySelector('[style*="Planificación"]').parentElement.innerHTML}
          </div>
      </div>
      ` : ''}
      
        <!-- Pie de página compacto -->
        <div style="margin-top: 8px; text-align: center; font-size: 8px; color: #666; border-top: 1px solid #ccc; padding-top: 4px;">
          <p style="margin: 0;">LEX▲R - Sistema de cómputo previsional | El derecho es orientativo</p>
      </div>
    </div>
  `;

    console.log('Creando ventana de impresión...');

    // Crear ventana de impresión optimizada
    const ventanaImpresion = window.open('', '_blank', 'width=900,height=700,scrollbars=yes,resizable=yes');
    
    if (!ventanaImpresion) {
      customAlert('No se pudo abrir la ventana de impresión. Verifique que el navegador no esté bloqueando ventanas emergentes.');
      return;
    }
    
  ventanaImpresion.document.write(`
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <title>Reporte Previsional</title>
      <style>
          * { box-sizing: border-box; }
          body { 
            margin: 0; 
            padding: 5px; 
            font-family: Arial, sans-serif; 
            font-size: 11px; 
            line-height: 1.2;
          }
          table { 
            border-collapse: collapse; 
            width: 100%; 
            max-width: 100%;
            margin: 3px 0; 
            font-size: 11px; 
            table-layout: fixed;
            word-wrap: break-word;
          }
          th, td { 
            border: 1px solid #ddd; 
            padding: 1px 2px; 
            text-align: left; 
            font-size: 11px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
          }
          th { 
            background-color: #f2f2f2; 
            font-weight: bold; 
            font-size: 11px;
          }
          h1, h2, h3 { 
            margin: 0; 
            padding: 0; 
          }
          .details, .summary { 
            font-size: 9px !important; 
          }
        @media print {
            body { 
              margin: 0; 
              padding: 3px; 
              font-size: 9px;
            }
            @page { 
              margin: 0.5cm; 
              size: A4;
            }
            table { 
              font-size: 6px; 
              width: 100%;
              max-width: 100%;
              table-layout: fixed;
            }
            th, td { 
              padding: 1px; 
              font-size: 6px;
              overflow: hidden;
              text-overflow: ellipsis;
              white-space: nowrap;
            }
          }
      </style>
    </head>
    <body>
      ${reporteHTML}
    </body>
    </html>
  `);
  ventanaImpresion.document.close();
    
    console.log('Contenido escrito en la ventana, iniciando impresión...');
  
  // Esperar a que se cargue y luego imprimir
  setTimeout(() => {
    ventanaImpresion.focus();
    ventanaImpresion.print();
      console.log('Comando de impresión enviado');
  }, 500);
    
  } catch (error) {
    console.error('Error al generar el reporte:', error);
    customAlert('Error al generar el reporte. Por favor, intente nuevamente.');
  }
}

// Exportar solo el resumen: abrir ventana de impresión con el contenido de #resumen
function exportResumen(){
  const resumen = document.getElementById('resumen'); if(!resumen) return; 
  const w = window.open('','_blank','width=800,height=600');
  const html = `<!doctype html><html><head><meta charset="utf-8"><title>Resumen</title><style>body{font-family:Tahoma,Arial,sans-serif;padding:12px}</style></head><body>${resumen.innerHTML}</body></html>`;
  w.document.open(); w.document.write(html); w.document.close();
  w.focus();
  // invocar impresión del popup
  setTimeout(()=>{ try{ w.print(); } catch(e){} }, 300);
}

// Copiar el resumen a portapapeles como texto plano
function copyResumen(){
  const resumen = document.getElementById('resumen'); if(!resumen) return;
  // Extraer texto y limpiarlo
  const txt = resumen.innerText.replace(/\s+\n/g,'\n').trim();
  if(navigator.clipboard && navigator.clipboard.writeText){
    navigator.clipboard.writeText(txt).then(()=>{ showModal('Resumen copiado al portapapeles.'); }).catch(()=>{ showModal('No se pudo copiar automáticamente. Seleccione y copie manualmente.'); });
  } else {
    // Fallback: crear textarea
    const ta = document.createElement('textarea'); ta.value = txt; document.body.appendChild(ta); ta.select(); try{ document.execCommand('copy'); showModal('Resumen copiado al portapapeles.'); } catch(e){ showModal('No se pudo copiar automáticamente. Seleccione y copie manualmente.'); } finally{ document.body.removeChild(ta); }
  }
}


function showModal(msg, btnText = 'OK') {
  return new Promise(resolve => {
    const backdrop = document.getElementById('customModalBackdrop');
    document.getElementById('customModalMsg').innerHTML = msg;
    const btns = document.getElementById('customModalBtns');
    btns.innerHTML = '';
    const okBtn = document.createElement('button');
    okBtn.textContent = btnText;
    okBtn.onclick = () => { backdrop.style.display = 'none'; resolve(); };
    btns.appendChild(okBtn);
    backdrop.style.display = 'flex';
    okBtn.focus();
  });
}
function showConfirmModal(msg, okText = 'Aceptar', cancelText = 'Cancelar') {
  return new Promise(resolve => {
    const backdrop = document.getElementById('customModalBackdrop');
    document.getElementById('customModalMsg').innerHTML = msg;
    const btns = document.getElementById('customModalBtns');
    btns.innerHTML = '';
    const okBtn = document.createElement('button');
    okBtn.textContent = okText;
    okBtn.onclick = () => { backdrop.style.display = 'none'; resolve(true); };
    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = cancelText;
    cancelBtn.onclick = () => { backdrop.style.display = 'none'; resolve(false); };
    btns.appendChild(okBtn);
    btns.appendChild(cancelBtn);
    backdrop.style.display = 'flex';
    okBtn.focus();
  });
}

// ================= Funcionalidad del Header =================
document.addEventListener('DOMContentLoaded', function() {
  // Funcionalidad de búsqueda
  const searchInput = document.getElementById('searchInput');
  const searchBtn = document.getElementById('searchBtn');
  
  // Almacenamiento local para cómputos guardados
  let savedComputations = JSON.parse(localStorage.getItem('lexarComputations') || '[]');
  
  // Función de búsqueda
  async function searchComputations(query) {
    if (!query.trim()) {
      customAlert('Por favor ingrese un término de búsqueda');
      return;
    }
    
    try {
      const results = await searchComputationsInDatabase(query);
      
      if (results.length === 0) {
        customAlert('No se encontraron cómputos que coincidan con la búsqueda');
        return;
      }
      
      // Crear lista de cómputos encontrados
      const resultList = results.map((comp, index) => 
        `${index + 1}. ${comp.nombre} ${comp.apellido} - ${comp.datos.beneficio} (${new Date(comp.fecha).toLocaleDateString()})`
      ).join('\n');
      
      const selection = prompt(`Cómputos encontrados:\n${resultList}\n\nIngrese el número del cómputo a cargar:`);
      const index = parseInt(selection) - 1;
      
      if (index >= 0 && index < results.length) {
        await loadComputationFromDatabase(results[index].id);
      }
    } catch (error) {
      console.error('Error al buscar cómputos:', error);
      customAlert('Error al buscar cómputos');
    }
  }
  
  // Event listeners para búsqueda
  searchBtn.addEventListener('click', () => {
    searchComputations(searchInput.value);
  });
  
  searchInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      searchComputations(searchInput.value);
    }
  });
  
  // Funcionalidad de menús desplegables
  const dropdowns = document.querySelectorAll('.dropdown');
  
  dropdowns.forEach(dropdown => {
    const btn = dropdown.querySelector('.dropdown-btn');
    const content = dropdown.querySelector('.dropdown-content');
    
    // Función para ajustar posición del dropdown
    function adjustDropdownPosition() {
      const rect = btn.getBoundingClientRect();
      const contentRect = content.getBoundingClientRect();
      const viewportWidth = window.innerWidth;
      
      // Resetear estilos de posición
      content.style.left = '';
      content.style.right = '';
      
      // Verificar si se sale por la derecha
      if (rect.left + contentRect.width > viewportWidth) {
        content.style.left = 'auto';
        content.style.right = '0';
      }
      
      // Verificar si se sale por la izquierda
      if (rect.left < 0) {
        content.style.left = '0';
        content.style.right = 'auto';
      }
    }
    
    // Cerrar otros dropdowns al abrir uno
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      dropdowns.forEach(other => {
        if (other !== dropdown) {
          other.querySelector('.dropdown-content').style.display = 'none';
        }
      });
      
      if (content.style.display === 'block') {
        content.style.display = 'none';
      } else {
        content.style.display = 'block';
        // Ajustar posición después de mostrar
        setTimeout(adjustDropdownPosition, 0);
      }
    });
  });
  
  // Cerrar dropdowns al hacer clic fuera
  document.addEventListener('click', () => {
    dropdowns.forEach(dropdown => {
      dropdown.querySelector('.dropdown-content').style.display = 'none';
    });
  });
  
  // Ajustar posición de dropdowns al redimensionar ventana
  window.addEventListener('resize', () => {
    dropdowns.forEach(dropdown => {
      const content = dropdown.querySelector('.dropdown-content');
      if (content.style.display === 'block') {
        const btn = dropdown.querySelector('.dropdown-btn');
        const rect = btn.getBoundingClientRect();
        const contentRect = content.getBoundingClientRect();
        const viewportWidth = window.innerWidth;
        
        // Resetear estilos de posición
        content.style.left = '';
        content.style.right = '';
        
        // Verificar si se sale por la derecha
        if (rect.left + contentRect.width > viewportWidth) {
          content.style.left = 'auto';
          content.style.right = '0';
        }
      }
    });
  });
  
  // Sistema de modales personalizados
  function customAlert(message, title = 'Alerta') {
    return new Promise((resolve) => {
      document.getElementById('alertTitle').textContent = title;
      document.getElementById('alertMessage').textContent = message;
      document.getElementById('customAlert').style.display = 'block';
      
      const closeAlert = () => {
        document.getElementById('customAlert').style.display = 'none';
        resolve();
      };
      
      document.getElementById('alertOk').onclick = closeAlert;
      document.getElementById('closeAlert').onclick = closeAlert;
      
      // Cerrar al hacer clic fuera del modal
      document.getElementById('customAlert').onclick = (e) => {
        if (e.target.id === 'customAlert') {
          closeAlert();
        }
      };
    });
  }

  function customConfirm(message, title = 'Confirmar') {
    return new Promise((resolve) => {
      document.getElementById('confirmTitle').textContent = title;
      document.getElementById('confirmMessage').textContent = message;
      document.getElementById('customConfirm').style.display = 'block';
      
      const closeConfirm = (result) => {
        document.getElementById('customConfirm').style.display = 'none';
        resolve(result);
      };
      
      document.getElementById('confirmOk').onclick = () => closeConfirm(true);
      document.getElementById('confirmCancel').onclick = () => closeConfirm(false);
      document.getElementById('closeConfirm').onclick = () => closeConfirm(false);
      
      // Cerrar al hacer clic fuera del modal
      document.getElementById('customConfirm').onclick = (e) => {
        if (e.target.id === 'customConfirm') {
          closeConfirm(false);
        }
      };
    });
  }

  function customPrompt(message, defaultValue = '', title = 'Ingresar datos') {
    return new Promise((resolve) => {
      document.getElementById('promptTitle').textContent = title;
      document.getElementById('promptMessage').textContent = message;
      document.getElementById('promptInput').value = defaultValue;
      document.getElementById('customPrompt').style.display = 'block';
      
      // Enfocar el input
      setTimeout(() => {
        document.getElementById('promptInput').focus();
        document.getElementById('promptInput').select();
      }, 100);
      
      const closePrompt = (result) => {
        document.getElementById('customPrompt').style.display = 'none';
        resolve(result);
      };
      
      document.getElementById('promptOk').onclick = () => {
        const value = document.getElementById('promptInput').value;
        closePrompt(value);
      };
      
      document.getElementById('promptCancel').onclick = () => closePrompt(null);
      document.getElementById('closePrompt').onclick = () => closePrompt(null);
      
      // Enter para aceptar, Escape para cancelar
      const handleKeyPress = (e) => {
        if (e.key === 'Enter') {
          const value = document.getElementById('promptInput').value;
          closePrompt(value);
        } else if (e.key === 'Escape') {
          closePrompt(null);
        }
      };
      
      document.getElementById('promptInput').onkeydown = handleKeyPress;
      
      // Cerrar al hacer clic fuera del modal
      document.getElementById('customPrompt').onclick = (e) => {
        if (e.target.id === 'customPrompt') {
          closePrompt(null);
        }
      };
    });
  }

  // Funciones de la base de datos
  async function saveComputationToDatabase() {
    try {
      if (!db) {
        await initDatabase();
      }
      
      const nombreCompleto = document.getElementById('nombre')?.value || '';
      const nombreCompletoArray = nombreCompleto.trim().split(' ');
      const nombre = nombreCompletoArray[0] || '';
      const apellido = nombreCompletoArray.slice(1).join(' ') || '';
      
      const computationData = {
        fecha: new Date().toISOString(),
        nombre: nombre,
        apellido: apellido,
        datos: {
          nombre: nombre,
          apellido: apellido,
          sexo: document.getElementById('sexo')?.value || '',
          cuil: document.getElementById('cuil')?.value || '',
          fechaNacimiento: document.getElementById('fNac')?.value || '',
          nacionalidad: document.getElementById('nacionalidad')?.value || '',
          fechaIngreso: document.getElementById('fIngreso')?.value || '',
          naturalizado: document.getElementById('chkNaturalizado')?.checked || false,
          beneficio: document.getElementById('beneficio')?.value || '',
          tipoBeneficiario: document.getElementById('tipoBeneficiario')?.value || '',
          fechaFallecimiento: document.getElementById('fFall')?.value || '',
          fechaSolicitud: document.getElementById('fSol')?.value || '',
          anosConvivencia: document.getElementById('anosConvivencia')?.value || '',
          tienenHijoReconocido: document.getElementById('tienenHijoReconocido')?.value || '',
          edadHijoFallecimiento: document.getElementById('edadHijoFallecimiento')?.value || '',
          estadoCivilHijo: document.getElementById('estadoCivilHijo')?.value || '',
          cobraOtraPrestacion: document.getElementById('cobraOtraPrestacion')?.value || '',
          incapacitadoTrabajar: document.getElementById('incapacitadoTrabajar')?.value || '',
          hNacidos: document.getElementById('hNacidos')?.value || '0',
          hAdoptados: document.getElementById('hAdoptados')?.value || '0',
          hDisc: document.getElementById('hDisc')?.value || '0',
          hAUH: document.getElementById('hAUH')?.value || '0',
          aportes: state.aportes || []
        }
      };
      
      console.log('Datos a guardar:', computationData);
      
      const transaction = db.transaction([STORE_NAME], 'readwrite');
      const store = transaction.objectStore(STORE_NAME);
      
      let request;
      console.log('editingComputationId en saveComputationToDatabase:', editingComputationId);
      if (editingComputationId) {
        // Si estamos editando un cómputo existente, actualizar en lugar de crear uno nuevo
        computationData.id = editingComputationId;
        console.log('Actualizando cómputo existente con ID:', editingComputationId);
        request = store.put(computationData);
      } else {
        // Si es un cómputo nuevo, crear uno nuevo
        console.log('Creando nuevo cómputo');
        request = store.add(computationData);
      }
      
      return new Promise((resolve, reject) => {
        request.onsuccess = () => {
          const newId = request.result;
          console.log('Cómputo guardado exitosamente con ID:', newId);
          
          // Asignar el ID generado al objeto de datos
          if (!editingComputationId) {
            computationData.id = newId;
          }
          
          if (editingComputationId) {
            customAlert('Cómputo actualizado exitosamente en la base de datos');
            editingComputationId = null; // Limpiar el ID de edición
          } else {
            customAlert('Cómputo guardado exitosamente en la base de datos');
          }
          resolve(newId);
        };
        request.onerror = () => {
          console.error('Error al guardar en IndexedDB:', request.error);
          reject(request.error);
        };
      });
    } catch (error) {
      console.error('Error en saveComputationToDatabase:', error);
      throw error;
    }
  }

  async function getAllComputations() {
    try {
      if (!db) {
        await initDatabase();
      }
      
      const transaction = db.transaction([STORE_NAME], 'readonly');
      const store = transaction.objectStore(STORE_NAME);
      const request = store.getAll();
      
      return new Promise((resolve, reject) => {
        request.onsuccess = () => {
          console.log('Cómputos obtenidos:', request.result);
          resolve(request.result);
        };
        request.onerror = () => {
          console.error('Error al obtener cómputos:', request.error);
          reject(request.error);
        };
      });
    } catch (error) {
      console.error('Error en getAllComputations:', error);
      throw error;
    }
  }


  // Funcionalidad de los menús
  // Menú Archivo
  document.getElementById('newComputation')?.addEventListener('click', async (e) => {
    console.log('Nuevo cómputo clickeado');
    e.preventDefault();
    const confirmed = await customConfirm('¿Está seguro de que desea crear un nuevo cómputo? Se perderán los datos no guardados.');
    if (confirmed) {
      editingComputationId = null; // Limpiar el ID de edición
      location.reload();
    }
  });
  
  document.getElementById('saveComputation')?.addEventListener('click', async (e) => {
    console.log('Guardar cómputo clickeado');
    e.preventDefault();
    try {
      // Verificar que hay datos para guardar
      const nombre = document.getElementById('nombre')?.value;
      
      if (!nombre || nombre.trim() === '') {
        customAlert('Debe ingresar nombre y apellido para guardar el cómputo');
        return;
      }
      
      await saveComputationToDatabase();
    } catch (error) {
      console.error('Error al guardar cómputo:', error);
      customAlert('Error al guardar el cómputo');
    }
  });
  
  document.getElementById('openComputation')?.addEventListener('click', async (e) => {
    console.log('Abrir cómputo clickeado');
    e.preventDefault();
    try {
      const allComputations = await getAllComputations();
      
      if (allComputations.length === 0) {
        customAlert('No hay cómputos guardados');
        return;
      }
      
      const computationList = allComputations.map((comp, index) => 
        `${index + 1}. ${comp.nombre} ${comp.apellido} - ${comp.datos.beneficio} (${new Date(comp.fecha).toLocaleDateString()})`
      ).join('\n');
      
      const selection = await customPrompt(`Cómputos guardados:\n${computationList}\n\nIngrese el número del cómputo a abrir:`, '', 'Abrir Cómputo');
      if (selection === null) return;
      const index = parseInt(selection) - 1;
      
      if (index >= 0 && index < allComputations.length) {
        await loadComputationFromDatabase(allComputations[index].id);
      }
    } catch (error) {
      console.error('Error al abrir cómputo:', error);
      customAlert('Error al abrir el cómputo');
    }
  });

  document.getElementById('manageComputations')?.addEventListener('click', async (e) => {
    e.preventDefault();
    try {
      await showComputationsModal();
    } catch (error) {
      console.error('Error al abrir modal de gestión:', error);
      customAlert('Error al abrir la gestión de cómputos');
    }
  });
  
  document.getElementById('exportPDF')?.addEventListener('click', (e) => {
    e.preventDefault();
    // Usar la función existente de exportar PDF
    if (typeof exportarPDF === 'function') {
      exportarPDF();
    } else {
      customAlert('Función de exportar PDF no disponible');
    }
  });
  
  // Menú Editar
  document.getElementById('clearAll')?.addEventListener('click', async (e) => {
    e.preventDefault();
    const confirmed = await customConfirm('¿Está seguro de que desea limpiar todos los campos?');
    if (confirmed) {
      clearAllFields();
    }
  });
  
  document.getElementById('resetForm')?.addEventListener('click', async (e) => {
    e.preventDefault();
    const confirmed = await customConfirm('¿Está seguro de que desea restablecer el formulario?');
    if (confirmed) {
      location.reload();
    }
  });
  
  // Menú Ver
  document.getElementById('togglePreview')?.addEventListener('click', (e) => {
    e.preventDefault();
    customAlert('Vista previa del cómputo (funcionalidad en desarrollo)');
  });
  
  document.getElementById('fullScreen')?.addEventListener('click', (e) => {
    e.preventDefault();
    if (!document.fullscreenElement) {
      document.documentElement.requestFullscreen();
    } else {
      document.exitFullscreen();
    }
  });
  
  // Toggle shortcuts visibility
  document.getElementById('toggleShortcuts')?.addEventListener('click', (e) => {
    e.preventDefault();
    toggleShortcutsVisibility();
  });
  
  // Menú Herramientas
  document.getElementById('calculator')?.addEventListener('click', (e) => {
    e.preventDefault();
    customAlert('Calculadora (funcionalidad en desarrollo)');
  });
  
  document.getElementById('dateCalculator')?.addEventListener('click', (e) => {
    e.preventDefault();
    customAlert('Calculadora de fechas (funcionalidad en desarrollo)');
  });
  
  document.getElementById('settings')?.addEventListener('click', (e) => {
    e.preventDefault();
    customAlert('Configuración (funcionalidad en desarrollo)');
  });
  
  // Menú Ayuda
  document.getElementById('helpContent')?.addEventListener('click', (e) => {
    e.preventDefault();
    customAlert('Contenido de ayuda (funcionalidad en desarrollo)');
  });
  
  document.getElementById('aboutApp')?.addEventListener('click', (e) => {
    e.preventDefault();
    customAlert('LEX▲R - Cómputo de derecho Previsional\nVersión 1.0\nDesarrollado para cálculos previsionales');
  });
});

// Función para ver cómputo (cierra el modal)
async function viewComputation(id) {
  console.log('viewComputation llamada con ID:', id);
  // Limpiar el ID de edición para que no se confunda con edición
  editingComputationId = null;
  console.log('editingComputationId limpiado en viewComputation:', editingComputationId);
  await loadComputationFromDatabase(id);
  hideComputationsModal();
}

// Función global para cargar cómputo desde la base de datos
async function loadComputationFromDatabase(id) {
  try {
    console.log('loadComputationFromDatabase llamada con ID:', id);
    if (!db) {
      await initDatabase();
    }
    
    const transaction = db.transaction([STORE_NAME], 'readonly');
    const store = transaction.objectStore(STORE_NAME);
    const request = store.get(id);
    
    return new Promise((resolve, reject) => {
      request.onsuccess = () => {
        const computation = request.result;
        console.log('Cómputo obtenido de la base de datos:', computation);
        if (computation) {
          // Cargar datos en el formulario
        console.log('Datos del cómputo cargado:', computation);
        console.log('Nombre:', computation.datos.nombre);
        console.log('Apellido:', computation.datos.apellido);
          
          if (computation.datos.nombre || computation.datos.apellido) {
            const nombreField = document.getElementById('nombre');
            if (nombreField) {
              const nombreCompleto = `${computation.datos.nombre || ''} ${computation.datos.apellido || ''}`.trim();
              console.log('Nombre completo a cargar:', nombreCompleto);
              nombreField.value = nombreCompleto;
              console.log('Valor asignado al campo:', nombreField.value);
            }
          }
          if (computation.datos.sexo) {
            const sexoField = document.getElementById('sexo');
            if (sexoField) sexoField.value = computation.datos.sexo;
          }
          if (computation.datos.cuil) {
            const cuilField = document.getElementById('cuil');
            if (cuilField) cuilField.value = computation.datos.cuil;
          }
          if (computation.datos.fechaNacimiento) {
            const fechaNacimientoField = document.getElementById('fNac');
            if (fechaNacimientoField) {
              fechaNacimientoField.value = computation.datos.fechaNacimiento;
              console.log('Fecha de nacimiento cargada:', computation.datos.fechaNacimiento);
            }
          }
          if (computation.datos.nacionalidad) {
            const nacionalidadField = document.getElementById('nacionalidad');
            if (nacionalidadField) nacionalidadField.value = computation.datos.nacionalidad;
          }
          if (computation.datos.fechaIngreso) {
            const fechaIngresoField = document.getElementById('fIngreso');
            if (fechaIngresoField) fechaIngresoField.value = computation.datos.fechaIngreso;
          }
          if (computation.datos.naturalizado !== undefined) {
            const naturalizadoField = document.getElementById('chkNaturalizado');
            if (naturalizadoField) naturalizadoField.checked = computation.datos.naturalizado;
          }
          if (computation.datos.beneficio) {
            const beneficioField = document.getElementById('beneficio');
            if (beneficioField) beneficioField.value = computation.datos.beneficio;
          }
          if (computation.datos.tipoBeneficiario) {
            const tipoBeneficiarioField = document.getElementById('tipoBeneficiario');
            if (tipoBeneficiarioField) tipoBeneficiarioField.value = computation.datos.tipoBeneficiario;
          }
          if (computation.datos.fechaFallecimiento) {
            const fechaFallecimientoField = document.getElementById('fFall');
            if (fechaFallecimientoField) fechaFallecimientoField.value = computation.datos.fechaFallecimiento;
          }
          if (computation.datos.fechaSolicitud) {
            const fechaSolicitudField = document.getElementById('fSol');
            if (fechaSolicitudField) fechaSolicitudField.value = computation.datos.fechaSolicitud;
          }
          if (computation.datos.anosConvivencia) {
            const anosConvivenciaField = document.getElementById('anosConvivencia');
            if (anosConvivenciaField) anosConvivenciaField.value = computation.datos.anosConvivencia;
          }
          if (computation.datos.tienenHijoReconocido) {
            const tienenHijoReconocidoField = document.getElementById('tienenHijoReconocido');
            if (tienenHijoReconocidoField) tienenHijoReconocidoField.value = computation.datos.tienenHijoReconocido;
          }
          if (computation.datos.edadHijoFallecimiento) {
            const edadHijoFallecimientoField = document.getElementById('edadHijoFallecimiento');
            if (edadHijoFallecimientoField) edadHijoFallecimientoField.value = computation.datos.edadHijoFallecimiento;
          }
          if (computation.datos.estadoCivilHijo) {
            const estadoCivilHijoField = document.getElementById('estadoCivilHijo');
            if (estadoCivilHijoField) estadoCivilHijoField.value = computation.datos.estadoCivilHijo;
          }
          if (computation.datos.cobraOtraPrestacion) {
            const cobraOtraPrestacionField = document.getElementById('cobraOtraPrestacion');
            if (cobraOtraPrestacionField) cobraOtraPrestacionField.value = computation.datos.cobraOtraPrestacion;
          }
          if (computation.datos.incapacitadoTrabajar) {
            const incapacitadoTrabajarField = document.getElementById('incapacitadoTrabajar');
            if (incapacitadoTrabajarField) incapacitadoTrabajarField.value = computation.datos.incapacitadoTrabajar;
          }
          if (computation.datos.hNacidos) {
            const hNacidosField = document.getElementById('hNacidos');
            if (hNacidosField) hNacidosField.value = computation.datos.hNacidos;
          }
          if (computation.datos.hAdoptados) {
            const hAdoptadosField = document.getElementById('hAdoptados');
            if (hAdoptadosField) hAdoptadosField.value = computation.datos.hAdoptados;
          }
          if (computation.datos.hDisc) {
            const hDiscField = document.getElementById('hDisc');
            if (hDiscField) hDiscField.value = computation.datos.hDisc;
          }
          if (computation.datos.hAUH) {
            const hAUHField = document.getElementById('hAUH');
            if (hAUHField) hAUHField.value = computation.datos.hAUH;
          }
          if (computation.datos.aportes) {
            state.aportes = computation.datos.aportes;
            render();
          }
          
          alert('Cómputo cargado exitosamente');
          resolve(computation);
        } else {
          console.log('Cómputo no encontrado con ID:', id);
          alert('Cómputo no encontrado');
          resolve(null);
        }
      };
      request.onerror = () => {
        console.error('Error al obtener cómputo:', request.error);
        alert('Error al cargar el cómputo: ' + request.error.message);
        reject(request.error);
      };
    });
  } catch (error) {
    console.error('Error en loadComputationFromDatabase:', error);
    alert('Error al cargar el cómputo: ' + error.message);
    throw error;
  }
}

// Funciones auxiliares para el header
function saveCurrentComputation(name) {
  // Recopilar datos del formulario actual
  const formData = {
    name: name,
    employeeName: document.getElementById('nombre_empleado')?.value || '',
    employeeId: document.getElementById('cedula_empleado')?.value || '',
    // Agregar más campos según sea necesario
    timestamp: new Date().toISOString()
  };
  
  // Guardar en localStorage
  savedComputations.push(formData);
  localStorage.setItem('lexarComputations', JSON.stringify(savedComputations));
  
  customAlert(`Cómputo "${name}" guardado exitosamente`);
}

function loadComputation(computation) {
  // Cargar datos en el formulario
  if (computation.employeeName) {
    const employeeNameField = document.getElementById('nombre_empleado');
    if (employeeNameField) employeeNameField.value = computation.employeeName;
  }
  
  if (computation.employeeId) {
    const employeeIdField = document.getElementById('cedula_empleado');
    if (employeeIdField) employeeIdField.value = computation.employeeId;
  }
  
  customAlert(`Cómputo "${computation.name}" cargado exitosamente`);
}

// Base de datos IndexedDB para cómputos
let db;
const DB_NAME = 'LexarComputos';
const DB_VERSION = 1;
const STORE_NAME = 'computos';

// Inicializar base de datos
function initDatabase() {
  return new Promise((resolve, reject) => {
    console.log('Inicializando base de datos IndexedDB...');
    const request = indexedDB.open(DB_NAME, DB_VERSION);
    
    request.onerror = () => {
      console.error('Error al abrir IndexedDB:', request.error);
      reject(request.error);
    };
    
    request.onsuccess = () => {
      db = request.result;
      console.log('Base de datos IndexedDB inicializada correctamente');
      resolve(db);
    };
    
    request.onupgradeneeded = (event) => {
      console.log('Actualizando esquema de base de datos...');
      const database = event.target.result;
      if (!database.objectStoreNames.contains(STORE_NAME)) {
        const store = database.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
        store.createIndex('nombre', 'datos.nombre', { unique: false });
        store.createIndex('apellido', 'datos.apellido', { unique: false });
        store.createIndex('fecha', 'fecha', { unique: false });
        store.createIndex('beneficio', 'datos.beneficio', { unique: false });
        console.log('Esquema de base de datos creado');
      }
    };
  });
}


// Función para buscar cómputos en la base de datos
async function searchComputationsInDatabase(searchTerm) {
  try {
    if (!db) {
      await initDatabase();
    }
    
    const transaction = db.transaction([STORE_NAME], 'readonly');
    const store = transaction.objectStore(STORE_NAME);
    const request = store.getAll();
    
    return new Promise((resolve, reject) => {
      request.onsuccess = () => {
        const allComputations = request.result;
        const filtered = allComputations.filter(comp => {
          const searchLower = searchTerm.toLowerCase();
          return (
            comp.datos.nombre?.toLowerCase().includes(searchLower) ||
            comp.datos.apellido?.toLowerCase().includes(searchLower) ||
            comp.datos.beneficio?.toLowerCase().includes(searchLower) ||
            comp.nombre?.toLowerCase().includes(searchLower) ||
            comp.apellido?.toLowerCase().includes(searchLower)
          );
        });
        resolve(filtered);
      };
      request.onerror = () => reject(request.error);
    });
  } catch (error) {
    console.error('Error al buscar cómputos:', error);
    return [];
  }
}


// Función para eliminar cómputo
// Función para confirmar eliminación de cómputo
async function confirmDeleteComputation(id) {
  console.log('Función confirmDeleteComputation llamada con ID:', id);
  if (confirm('¿Está seguro de que desea eliminar este cómputo? Esta acción no se puede deshacer.')) {
    try {
      console.log('Confirmación recibida, procediendo a eliminar...');
      await deleteComputationFromDatabase(id);
      console.log('Cómputo eliminado, recargando lista...');
      // Recargar la lista después de eliminar
      await loadComputationsList();
      console.log('Lista recargada exitosamente');
    } catch (error) {
      console.error('Error al eliminar cómputo:', error);
      alert('Error al eliminar el cómputo: ' + error.message);
    }
  } else {
    console.log('Eliminación cancelada por el usuario');
  }
}

async function deleteComputationFromDatabase(id) {
  try {
    console.log('Intentando eliminar cómputo con ID:', id);
    if (!db) {
      await initDatabase();
    }
    
    const transaction = db.transaction([STORE_NAME], 'readwrite');
    const store = transaction.objectStore(STORE_NAME);
    const request = store.delete(id);
    
    return new Promise((resolve, reject) => {
      request.onsuccess = () => {
        console.log('Cómputo eliminado exitosamente con ID:', id);
        alert('Cómputo eliminado exitosamente');
        resolve();
      };
      request.onerror = () => {
        console.error('Error al eliminar cómputo:', request.error);
        alert('Error al eliminar el cómputo: ' + request.error.message);
        reject(request.error);
      };
    });
  } catch (error) {
    console.error('Error al eliminar cómputo:', error);
    alert('Error al eliminar el cómputo: ' + error.message);
  }
}

// Función para obtener todos los cómputos
async function getAllComputations() {
  try {
    if (!db) {
      await initDatabase();
    }
    
    const transaction = db.transaction([STORE_NAME], 'readonly');
    const store = transaction.objectStore(STORE_NAME);
    const request = store.getAll();
    
    return new Promise((resolve, reject) => {
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });
  } catch (error) {
    console.error('Error al obtener cómputos:', error);
    return [];
  }
}

function clearAllFields() {
  // Limpiar todos los campos del formulario
  const inputs = document.querySelectorAll('input[type="text"], input[type="number"], input[type="date"]');
  inputs.forEach(input => {
    if (input.type === 'date') {
      input.value = '';
    } else {
      input.value = '';
    }
  });
  
  const selects = document.querySelectorAll('select');
  selects.forEach(select => {
    select.selectedIndex = 0;
  });
}

// Funciones para el modal de gestión de cómputos
async function showComputationsModal() {
  const modal = document.getElementById('computationsModal');
  modal.style.display = 'block';
  await loadComputationsList();
}

function hideComputationsModal() {
  const modal = document.getElementById('computationsModal');
  modal.style.display = 'none';
}

// Variables globales para el modal expandido
let allComputations = [];
let filteredComputations = [];
let currentPage = 1;
let itemsPerPage = 10;
let currentFilters = {
  search: '',
  benefit: '',
  dateFrom: '',
  dateTo: '',
  sortBy: 'fecha_desc'
};

async function loadComputationsList() {
  try {
    allComputations = await getAllComputations();
    filteredComputations = [...allComputations];
    
    updateStats();
    applyFilters();
    renderComputationsList();
  } catch (error) {
    console.error('Error al cargar lista de cómputos:', error);
    document.getElementById('computationsList').innerHTML = '<div style="padding: 20px; text-align: center; color: #dc2626;">Error al cargar cómputos</div>';
  }
}

function updateStats() {
  const totalElement = document.getElementById('totalComputations');
  const filteredElement = document.getElementById('filteredComputations');
  const lastElement = document.getElementById('lastComputation');
  
  if (totalElement) totalElement.textContent = allComputations.length;
  if (filteredElement) filteredElement.textContent = filteredComputations.length;
  
  if (lastElement && allComputations.length > 0) {
    const lastComputation = allComputations.sort((a, b) => new Date(b.fecha) - new Date(a.fecha))[0];
    lastElement.textContent = new Date(lastComputation.fecha).toLocaleDateString();
  }
}

function applyFilters() {
  let filtered = [...allComputations];
  
  // Filtro de búsqueda
  if (currentFilters.search) {
    const searchTerm = currentFilters.search.toLowerCase();
    filtered = filtered.filter(comp => 
      comp.nombre.toLowerCase().includes(searchTerm) ||
      comp.apellido.toLowerCase().includes(searchTerm) ||
      (comp.datos.beneficio && comp.datos.beneficio.toLowerCase().includes(searchTerm))
    );
  }
  
  // Filtro por beneficio
  if (currentFilters.benefit) {
    filtered = filtered.filter(comp => comp.datos.beneficio === currentFilters.benefit);
  }
  
  // Filtro por fecha
  if (currentFilters.dateFrom) {
    filtered = filtered.filter(comp => new Date(comp.fecha) >= new Date(currentFilters.dateFrom));
  }
  
  if (currentFilters.dateTo) {
    filtered = filtered.filter(comp => new Date(comp.fecha) <= new Date(currentFilters.dateTo));
  }
  
  // Ordenamiento
  filtered.sort((a, b) => {
    switch (currentFilters.sortBy) {
      case 'fecha_desc':
        return new Date(b.fecha) - new Date(a.fecha);
      case 'fecha_asc':
        return new Date(a.fecha) - new Date(b.fecha);
      case 'nombre_asc':
        return (a.nombre + ' ' + a.apellido).localeCompare(b.nombre + ' ' + b.apellido);
      case 'nombre_desc':
        return (b.nombre + ' ' + b.apellido).localeCompare(a.nombre + ' ' + a.apellido);
      case 'beneficio_asc':
        return (a.datos.beneficio || '').localeCompare(b.datos.beneficio || '');
      default:
        return 0;
    }
  });
  
  filteredComputations = filtered;
  currentPage = 1;
  updateStats();
  renderComputationsList();
}

function renderComputationsList() {
  const listContainer = document.getElementById('computationsList');
  
  if (filteredComputations.length === 0) {
    listContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #64748b;">No hay cómputos que coincidan con los filtros</div>';
    updatePagination();
    return;
  }
  
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const pageComputations = filteredComputations.slice(startIndex, endIndex);
  
  const listHTML = pageComputations.map(comp => `
    <div class="computation-item">
      <div class="computation-info">
        <div class="computation-name">${comp.nombre} ${comp.apellido}</div>
        <div class="computation-details">
          ${comp.datos.beneficio || 'Sin beneficio especificado'} • 
          ${comp.datos.sexo || 'Sin especificar'} • 
          ${comp.datos.nacionalidad || 'Sin especificar'}
        </div>
        <div class="computation-date">${new Date(comp.fecha).toLocaleDateString()} ${new Date(comp.fecha).toLocaleTimeString()}</div>
      </div>
      <div class="computation-actions">
        <button class="action-btn btn-view" onclick="viewComputation(${comp.id})" title="Cargar cómputo">👁️ Ver</button>
        <button class="action-btn btn-edit" onclick="editComputation(${comp.id})" title="Editar cómputo">✏️ Editar</button>
        <button class="action-btn btn-delete" onclick="confirmDeleteComputation(${comp.id})" title="Eliminar cómputo">🗑️ Eliminar</button>
      </div>
    </div>
  `).join('');
  
  listContainer.innerHTML = listHTML;
  updatePagination();
}

function updatePagination() {
  const totalPages = Math.ceil(filteredComputations.length / itemsPerPage);
  const paginationInfo = document.getElementById('paginationInfo');
  const prevBtn = document.getElementById('prevPageBtn');
  const nextBtn = document.getElementById('nextPageBtn');
  const pageNumbers = document.getElementById('pageNumbers');
  
  if (paginationInfo) {
    const startItem = (currentPage - 1) * itemsPerPage + 1;
    const endItem = Math.min(currentPage * itemsPerPage, filteredComputations.length);
    paginationInfo.textContent = `Mostrando ${startItem}-${endItem} de ${filteredComputations.length} cómputos`;
  }
  
  if (prevBtn) prevBtn.disabled = currentPage === 1;
  if (nextBtn) nextBtn.disabled = currentPage === totalPages;
  
  if (pageNumbers) {
    const pages = [];
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
    
    if (endPage - startPage + 1 < maxVisiblePages) {
      startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }
    
    for (let i = startPage; i <= endPage; i++) {
      pages.push(`<span class="page-number ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</span>`);
    }
    
    pageNumbers.innerHTML = pages.join('');
  }
}

function goToPage(page) {
  currentPage = page;
  renderComputationsList();
}

function editComputation(id) {
  console.log('editComputation llamada con ID:', id);
  // Establecer el ID del cómputo que se está editando
  editingComputationId = id;
  console.log('editingComputationId establecido a:', editingComputationId);
  // Cargar el cómputo para edición
  loadComputationFromDatabase(id);
  hideComputationsModal();
  console.log('Modal cerrado, editingComputationId debería ser:', editingComputationId);
}

async function exportAllComputations() {
  try {
    const computations = await getAllComputations();
    const exportData = {
      exportDate: new Date().toISOString(),
      totalComputations: computations.length,
      computations: computations
    };
    
    const dataStr = JSON.stringify(exportData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(dataBlob);
    
    const link = document.createElement('a');
    link.href = url;
    link.download = `lexar_computos_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    
    URL.revokeObjectURL(url);
    customAlert('Cómputos exportados exitosamente');
  } catch (error) {
    console.error('Error al exportar cómputos:', error);
    customAlert('Error al exportar cómputos');
  }
}

async function deleteAllComputations() {
  const confirmed = await customConfirm('¿Está seguro de que desea eliminar TODOS los cómputos? Esta acción no se puede deshacer.');
  if (!confirmed) return;
  
  try {
    const computations = await getAllComputations();
    for (const comp of computations) {
      await deleteComputationFromDatabase(comp.id);
    }
    await loadComputationsList();
    customAlert('Todos los cómputos han sido eliminados');
  } catch (error) {
    console.error('Error al eliminar todos los cómputos:', error);
    alert('Error al eliminar cómputos');
  }
}

async function loadComputationFromModal(id) {
  try {
    await loadComputationFromDatabase(id);
    hideComputationsModal();
  } catch (error) {
    console.error('Error al cargar cómputo:', error);
    customAlert('Error al cargar el cómputo');
  }
}

async function deleteComputationFromModal(id) {
  if (confirm('¿Está seguro de que desea eliminar este cómputo?')) {
    try {
      console.log('Eliminando cómputo desde modal con ID:', id);
      await deleteComputationFromDatabase(id);
      await loadComputationsList(); // Recargar la lista
    } catch (error) {
      console.error('Error al eliminar cómputo:', error);
      alert('Error al eliminar el cómputo: ' + error.message);
    }
  }
}

async function searchComputationsInModal() {
  const searchTerm = document.getElementById('modalSearchInput').value.trim();
  if (!searchTerm) {
    await loadComputationsList();
    return;
  }
  
  try {
    const results = await searchComputationsInDatabase(searchTerm);
    const listContainer = document.getElementById('computationsList');
    
    if (results.length === 0) {
      listContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #64748b;">No se encontraron cómputos con ese término</div>';
      return;
    }
    
    const listHTML = results.map(comp => `
      <div class="computation-item">
        <div class="computation-info">
          <div class="computation-name">${comp.nombre} ${comp.apellido}</div>
          <div class="computation-details">
            Beneficio: ${comp.datos.beneficio} | 
            Fecha: ${new Date(comp.fecha).toLocaleDateString()} |
            Aportes: ${comp.datos.aportes ? comp.datos.aportes.length : 0} períodos
          </div>
        </div>
        <div class="computation-actions">
          <button class="action-btn-small" onclick="loadComputationFromModal(${comp.id})">📂 Cargar</button>
          <button class="action-btn-small danger" onclick="deleteComputationFromModal(${comp.id})">🗑️ Eliminar</button>
        </div>
      </div>
    `).join('');
    
    listContainer.innerHTML = listHTML;
  } catch (error) {
    console.error('Error al buscar cómputos:', error);
    document.getElementById('computationsList').innerHTML = '<div style="padding: 20px; text-align: center; color: #dc2626;">Error al buscar cómputos</div>';
  }
}

// Event listeners para el modal
document.addEventListener('DOMContentLoaded', () => {
  // Cerrar modal al hacer clic en la X
  document.getElementById('closeModal')?.addEventListener('click', hideComputationsModal);
  
  // Cerrar modal al hacer clic fuera de él
  document.getElementById('computationsModal')?.addEventListener('click', (e) => {
    if (e.target.id === 'computationsModal') {
      hideComputationsModal();
    }
  });
  
  // Búsqueda en el modal
  document.getElementById('modalSearchBtn')?.addEventListener('click', () => {
    currentFilters.search = document.getElementById('modalSearchInput').value;
    applyFilters();
  });
  
  document.getElementById('modalSearchInput')?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      currentFilters.search = e.target.value;
      applyFilters();
    }
  });
  
  // Limpiar búsqueda
  document.getElementById('clearSearchBtn')?.addEventListener('click', () => {
    document.getElementById('modalSearchInput').value = '';
    currentFilters.search = '';
    applyFilters();
  });
  
  // Actualizar lista
  document.getElementById('refreshListBtn')?.addEventListener('click', loadComputationsList);
  
  // Exportar todos los cómputos
  document.getElementById('exportAllBtn')?.addEventListener('click', exportAllComputations);
  
  // Eliminar todos los cómputos
  document.getElementById('deleteAllBtn')?.addEventListener('click', deleteAllComputations);
  
  // Filtros avanzados
  document.getElementById('applyFiltersBtn')?.addEventListener('click', () => {
    currentFilters.benefit = document.getElementById('benefitFilter').value;
    currentFilters.dateFrom = document.getElementById('dateFromFilter').value;
    currentFilters.dateTo = document.getElementById('dateToFilter').value;
    currentFilters.sortBy = document.getElementById('sortByFilter').value;
    applyFilters();
  });
  
  document.getElementById('clearFiltersBtn')?.addEventListener('click', () => {
    document.getElementById('benefitFilter').value = '';
    document.getElementById('dateFromFilter').value = '';
    document.getElementById('dateToFilter').value = '';
    document.getElementById('sortByFilter').value = 'fecha_desc';
    currentFilters.benefit = '';
    currentFilters.dateFrom = '';
    currentFilters.dateTo = '';
    currentFilters.sortBy = 'fecha_desc';
    applyFilters();
  });
  
  // Paginación
  document.getElementById('prevPageBtn')?.addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--;
      renderComputationsList();
    }
  });
  
  document.getElementById('nextPageBtn')?.addEventListener('click', () => {
    const totalPages = Math.ceil(filteredComputations.length / itemsPerPage);
    if (currentPage < totalPages) {
      currentPage++;
      renderComputationsList();
    }
  });
  
  // Función de prueba para verificar la base de datos
  window.testDatabase = async function() {
    try {
      console.log('Probando base de datos...');
      await initDatabase();
      console.log('Base de datos inicializada correctamente');
      
      // Probar guardar un cómputo de prueba
      const testData = {
        fecha: new Date().toISOString(),
        nombre: 'Test',
        apellido: 'Usuario',
        datos: {
          nombre: 'Test',
          apellido: 'Usuario',
          sexo: 'M',
          fechaNacimiento: '1990-01-01',
          nacionalidad: 'AR',
          beneficio: 'Jubilación Ordinaria',
          aportes: []
        }
      };
      
      const transaction = db.transaction([STORE_NAME], 'readwrite');
      const store = transaction.objectStore(STORE_NAME);
      const request = store.add(testData);
      
      request.onsuccess = () => {
        console.log('Cómputo de prueba guardado con ID:', request.result);
        customAlert('Base de datos funcionando correctamente');
      };
      
      request.onerror = () => {
        console.error('Error al guardar cómputo de prueba:', request.error);
        customAlert('Error en la base de datos: ' + request.error.message);
      };
      
    } catch (error) {
      console.error('Error en prueba de base de datos:', error);
      customAlert('Error en la base de datos: ' + error.message);
    }
  };

});
  </script>

  <!-- Modal para gestión de cómputos -->
  <div id="computationsModal" class="modal" style="display: none;">
    <div class="modal-content computations-modal">
      <div class="modal-header">
        <h2>🗂️ Gestión de Cómputos</h2>
        <span class="close" id="closeModal">&times;</span>
      </div>
      <div class="modal-body">
        <!-- Barra de herramientas compacta -->
        <div class="toolbar-section">
          <div class="search-group">
            <input type="text" id="modalSearchInput" placeholder="Buscar cómputos..." class="search-input">
            <button id="modalSearchBtn" class="btn btn-primary">🔍</button>
            <button id="clearSearchBtn" class="btn btn-secondary">❌</button>
          </div>
          <div class="action-group">
            <button id="refreshListBtn" class="btn btn-success">🔄</button>
            <button id="exportAllBtn" class="btn btn-info">📤</button>
            <button id="deleteAllBtn" class="btn btn-danger">🗑️</button>
          </div>
        </div>

        <!-- Filtros compactos -->
        <div class="filters-section">
          <div class="filter-group">
            <label>Beneficio:</label>
            <select id="benefitFilter" class="filter-select">
              <option value="">Todos</option>
              <option value="Jubilación Ordinaria">Jubilación</option>
              <option value="Pensión por Fallecimiento (PBU)">PBU</option>
              <option value="Retiro por Invalidez">Invalidez</option>
              <option value="PUAM">PUAM</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Desde:</label>
            <input type="date" id="dateFromFilter" class="filter-input">
          </div>
          <div class="filter-group">
            <label>Hasta:</label>
            <input type="date" id="dateToFilter" class="filter-input">
          </div>
          <div class="filter-group">
            <label>Ordenar:</label>
            <select id="sortByFilter" class="filter-select">
              <option value="fecha_desc">Fecha ↓</option>
              <option value="fecha_asc">Fecha ↑</option>
              <option value="nombre_asc">Nombre A-Z</option>
              <option value="nombre_desc">Nombre Z-A</option>
              <option value="beneficio_asc">Beneficio</option>
            </select>
          </div>
          <button id="applyFiltersBtn" class="btn btn-primary">Aplicar</button>
          <button id="clearFiltersBtn" class="btn btn-secondary">Limpiar</button>
        </div>

        <!-- Estadísticas compactas -->
        <div class="stats-section">
          <div class="stat-card">
            <div class="stat-number" id="totalComputations">0</div>
            <div class="stat-label">Total</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="filteredComputations">0</div>
            <div class="stat-label">Mostrados</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="lastComputation">-</div>
            <div class="stat-label">Último</div>
          </div>
        </div>

        <!-- Lista de cómputos -->
        <div class="computations-container">
          <div id="computationsList" class="computations-list">
            <!-- Lista de cómputos se cargará aquí -->
          </div>
        </div>

        <!-- Paginación -->
        <div class="pagination-section">
          <div class="pagination-info">
            <span id="paginationInfo">Mostrando 0 de 0 cómputos</span>
          </div>
          <div class="pagination-controls">
            <button id="prevPageBtn" class="btn btn-secondary" disabled>⬅️ Anterior</button>
            <span id="pageNumbers" class="page-numbers"></span>
            <button id="nextPageBtn" class="btn btn-secondary" disabled>➡️ Siguiente</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de alerta personalizada -->
  <div id="customAlert" class="modal" style="display: none;">
    <div class="modal-content alert-modal">
      <div class="modal-header">
        <h2 id="alertTitle">Alerta</h2>
        <span class="close" id="closeAlert">&times;</span>
      </div>
      <div class="modal-body">
        <p id="alertMessage">Mensaje de alerta</p>
        <div class="alert-buttons">
          <button id="alertOk" class="btn btn-primary">Aceptar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de confirmación personalizada -->
  <div id="customConfirm" class="modal" style="display: none;">
    <div class="modal-content confirm-modal">
      <div class="modal-header">
        <h2 id="confirmTitle">Confirmar</h2>
        <span class="close" id="closeConfirm">&times;</span>
      </div>
      <div class="modal-body">
        <p id="confirmMessage">¿Está seguro de que desea continuar?</p>
        <div class="confirm-buttons">
          <button id="confirmCancel" class="btn btn-secondary">Cancelar</button>
          <button id="confirmOk" class="btn btn-primary">Aceptar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de prompt personalizada -->
  <div id="customPrompt" class="modal" style="display: none;">
    <div class="modal-content prompt-modal">
      <div class="modal-header">
        <h2 id="promptTitle">Ingresar datos</h2>
        <span class="close" id="closePrompt">&times;</span>
      </div>
      <div class="modal-body">
        <p id="promptMessage">Ingrese la información solicitada:</p>
        <input type="text" id="promptInput" class="prompt-input" placeholder="Ingrese aquí...">
        <div class="prompt-buttons">
          <button id="promptCancel" class="btn btn-secondary">Cancelar</button>
          <button id="promptOk" class="btn btn-primary">Aceptar</button>
        </div>
      </div>
    </div>
  </div>

  <style>
    .modal {
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    
      .modal-content {
        background-color: #ffffff;
        border: 1px solid #858585;
        box-shadow: 0 8px 32px rgba(139, 127, 255, 0.2);
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 90%;
        max-width: 1000px;
        max-height: 90vh;
        overflow-y: auto;
      backdrop-filter: blur(10px);
    }
    
    .modal-header {
      background: #858585;
      color: white;
      padding: 6px 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-header h2 {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    
    .close {
      color: white;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      padding: 4px 8px;
      transition: all 0.2s ease;
    }
    
    .close:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.1);
    }
    
    .modal-body {
      padding: 24px;
      background: linear-gradient(135deg, #f8f7ff 0%, #f0efff 100%);
    }
    
    .search-section {
      margin-bottom: 5px;
      display: flex;
      align-items: center;
    }
    
    .computations-list {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #858585;
    }
    
    .computation-item {
      padding: 2px;
      border-bottom: 1px solid #858585;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .computation-item:last-child {
      border-bottom: none;
    }
    
    .computation-info {
      flex: 1;
    }
    
    .computation-name {
      font-weight: 600;
      color: #202020;
      margin-bottom: 4px;
      white-space: normal;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    
    .computation-details {
      font-size: 12px;
      color: #202020;
    }
    
    .computation-actions {
      display: flex;
      gap: 8px;
    }
    
    .action-btn-small {
      padding: 4px 8px;
      font-size: 11px;
      border: 1px solid #858585;
      background: #f1f5f9;
      color: #202020;
      cursor: pointer;
    }
    
    .action-btn-small:hover {
      background: #e2e8f0;
    }
    
    .action-btn-small.danger {
      background: #fee2e2;
      color: #991b1b;
      border-color: #fecaca;
    }
    
    .action-btn-small.danger:hover {
      background: #fecaca;
    }
    

    /* Estilos para modales personalizados */
    .alert-modal, .confirm-modal, .prompt-modal {
      max-width: 400px;
      margin: 10% auto;
    }

    .alert-buttons, .confirm-buttons, .prompt-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }

    .btn-primary {
      background: #b0b0b0;
      color: #202020;
      border: 1px solid #b0b0b0;
      padding: 8px 16px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s ease;
    }

    .btn-primary:hover {
      background: #ffffff;
      border-color: #858585;
    }

    .btn-secondary {
      background: #b0b0b0;
      color: #202020;
      border: 1px solid #b0b0b0;
      padding: 8px 16px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s ease;
    }

    .btn-secondary:hover {
      background: #ffffff;
      border-color: #abcbda;
    }

    .prompt-input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #858585;
      border-radius: 4px;
      font-size: 11px;
      margin: 10px 0;
      box-sizing: border-box;
    }

    .prompt-input:focus {
      outline: none;
      border-color: #858585;
      box-shadow: 0 0 0 2px rgba(139, 127, 255, 0.1);
    }


    /* Estilos para el modal de gestión de cómputos - Consistente con el sitio */
    .computations-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 1000px;
      max-height: 90vh;
      overflow-y: auto;
    }

    /* Barra de herramientas - Consistente con el sitio */
    .toolbar-section {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      padding: 12px 16px;
      background: #f8f7ff;
      border: 1px solid #858585;
    }

    .search-group {
      display: flex;
      align-items: center;
      gap: 4px;
      flex: 1;
    }

    .search-group .search-input {
      flex: 1;
      padding: 4px;
      border: 1px solid #858585;
      font-size: 12px;
      height: 32px;
      transition: all 0.2s ease;
      background: white;
    }

    .search-group .search-input:focus {
      border-color: #003399;
      outline: none;
    }

    .action-group {
      display: flex;
      gap: 8px;
    }

    /* Botones compactos estilo Windows */
    .btn {
      padding: 1px 4px;
      border: 1px solid #858585;
      cursor: pointer;
      font-size: 12px;
      height: 32px;
      background: #858585;
      color: #202020;
      transition: all 0.2s ease;
      font-weight: 500;
    }

    .btn:hover {
      background: #abcbda;
      border-color: #003399;
    }

    .btn-primary {
      background: #0078d4;
      color: white;
      border-color: #005a9e;
    }

    .btn-primary:hover {
      background: #106ebe;
    }

    .btn-success {
      background: #9c8bff;
      color: white;
      border-color: #8b7fff;
      transition: all 0.2s ease;
    }

    .btn-success:hover {
      background: #7a6bff;
      border-color: #6b5bff;
      box-shadow: 0 2px 4px rgba(156, 139, 255, 0.3);
    }

    .btn-info {
      background: #8b7fff;
      color: white;
      border-color: #b6b2ff;
      transition: all 0.2s ease;
    }

    .btn-info:hover {
      background: #6b5bff;
      border-color: #8b7fff;
      box-shadow: 0 2px 4px rgba(139, 127, 255, 0.3);
    }

    .btn-danger {
      background: #ff6b6b;
      color: white;
      border-color: #ff5252;
      transition: all 0.2s ease;
    }

    .btn-danger:hover {
      background: #ff5252;
      border-color: #ff1744;
      box-shadow: 0 2px 4px rgba(255, 107, 107, 0.3);
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #000;
      border-color: #a0a0a0;
    }

    .btn-secondary:hover {
      background: #e0e0e0;
    }

    /* Filtros compactos - Consistente con el sitio */
    .filters-section {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      padding: 6px 8px;
      background: #f8f7ff;
      border: 1px solid #858585;
      border-radius: 4px;
      flex-wrap: wrap;
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .filter-group label {
      font-size: 9px;
      font-weight: 600;
      color: #000;
      white-space: nowrap;
    }

    .filter-select, .filter-input {
      padding: 2px 4px;
      border: 1px solid #b6b2ff;
      border-radius: 2px;
      font-size: 9px;
      background: white;
      height: 20px;
    }

    .filter-input {
      width: 80px;
    }

    /* Estadísticas compactas - Consistente con el sitio */
    .stats-section {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      padding: 4px 8px;
      background: #f8f7ff;
      border: 1px solid #858585;
      border-radius: 4px;
    }

    .stat-card {
      background: #e3e3e3;
      color: #202020;
      padding: 4px 8px;
      border-radius: 4px;
      text-align: center;
      border: 1px solid #858585;
      min-width: 60px;
    }

    .stat-number {
      font-size: 12px;
      font-weight: bold;
      margin-bottom: 2px;
    }

    .stat-label {
      font-size: 8px;
      color: #6b5bff;
    }

    /* Lista de cómputos - Consistente con el sitio */
    .computations-container {
      max-height: 350px;
      overflow-y: auto;
      border: 1px solid #858585;
      background: white;
    }

    .computations-list {
      padding: 0;
    }

    .computation-item {
      display: flex;
      align-items: space-between;
      border-bottom: 1px solid #858585;
      transition: all 0.2s ease;
      font-size: 11px;
    }

    .computation-item:hover {
      background: #e3e3e3;
    }

    .computation-item:last-child {
      border-bottom: none;
    }

    .computation-info {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 2px;
    }

    .computation-name {
      font-weight: 600;
      font-size: 12px;
      color: #202020;
      white-space: normal;
      word-wrap: break-word;
      overflow-wrap: break-word;
      margin-right: 4px;
    }

    .computation-details {
      font-size: 8px;
      color: #575757;
      margin-right: 4px;
    }

    .computation-date {
      font-size: 8px;
      color: #858585;
    }

    .computation-actions {
      display: flex;
      gap: 2px;
    }

    .action-btn {
      border: 1px solid #a0a0a0;
      border-radius: 1px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.1s;
      background: #f0f0f0;
      color: #000;
    }

    .btn-view {
      width: 100%;
      height: 20%;
      background: #a0a0a0;
      color: #202020;
      border-color: #a0a0a0;
      transition: all 0.2s ease;
    }

    .btn-view:hover {
      background: #abcbda;
      border-color: #003399;
    }

    .btn-edit {
      width: 100%;
      height: 20%;
      background: #a0a0a0;
      color: #202020;
      border-color: #a0a0a0;
      transition: all 0.2s ease;
    }

    .btn-edit:hover {
      background: #abcbda;
      border-color: #003399;
    }

    .btn-delete {
      width: 100%;
      height: 20%;
      background: #a0a0a0;
      color: #202020;
      border-color: #a0a0a0;
      transition: all 0.2s ease;
    }

    .btn-delete:hover {
      background: #abcbda;
      border-color: #003399;
    }

    /* Paginación compacta - Consistente con el sitio */
    .pagination-section {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
      padding: 4px 8px;
      background: #f8f7ff;
      border: 1px solid #858585;
      border-radius: 4px;
    }

    .pagination-info {
      font-size: 9px;
      color: #666;
    }

    .pagination-controls {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .page-numbers {
      display: flex;
      gap: 2px;
    }

    .page-number {
      padding: 2px 6px;
      border: 1px solid #858585;
      border-radius: 4px;
      cursor: pointer;
      font-size: 9px;
      background: #e3e3e3;
      color: #202020;
    }

    .page-number.active {
      background: #858585;
      color: white;
      border-color: #858585;
    }

    .page-number:hover:not(.active) {
      background: #e3e3e3;
    }


    /* Estilos para el modal de login */
    .login-modal {
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 10000;
      margin: 0;
      padding: 0;
    }

    .login-container {
      background: white;
      margin: 0;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .login-header {
      background: linear-gradient(135deg, #4168ea 0%, #1e40af 100%);
      color: white;
      padding: 20px;
      text-align: center;
      flex-shrink: 0;
    }

    .login-logo h1 {
      font-size: 2.5em;
      margin: 0;
      font-weight: 700;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .login-logo p {
      margin: 10px 0 0 0;
      font-size: 1.1em;
      opacity: 0.9;
    }

    .login-form-container {
      padding: 30px;
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .login-form-container h2 {
      text-align: center;
      margin-bottom: 30px;
      color: #1e293b;
      font-size: 1.5em;
    }

    .login-btn {
      width: 100%;
      padding: 15px;
      font-size: 16px;
      font-weight: 600;
      background: linear-gradient(135deg, #4168ea 0%, #1e40af 100%);
      border: none;
      border-radius: 10px;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .login-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(65, 104, 234, 0.3);
    }

    .btn-icon {
      font-size: 1.2em;
    }

    .login-footer {
      background: #f8fafc;
      padding: 15px;
      text-align: center;
      color: #64748b;
      font-size: 0.9em;
      flex-shrink: 0;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #374151;
    }

    .form-group input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }

    .form-group input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }

    .form-actions {
      text-align: center;
      margin-top: 20px;
    }

    .error-message {
      background: #fef2f2;
      color: #dc2626;
      padding: 8px 12px;
      border-radius: 4px;
      border: 1px solid #fecaca;
      margin-top: 10px;
      font-size: 12px;
    }


    /* Estilos para información del usuario */
    .user-info {
      height: 35px;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      gap: 15px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid #858585;
    }

    .user-profile {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: linear-gradient(135deg, #4168ea 0%, #1e40af 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #202020;
      font-weight: 600;
      font-size: 16px;
      position: relative;
      overflow: hidden;
    }

    .user-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }

    .user-details {
      display: flex;
      flex-direction: column;
      gap: 1px;
    }

    .user-name {
      font-weight: 600;
      color: #202020;
      font-size: 14px;
    }

    .user-email {
      color: #202020;
      font-size: 11px;
    }

    .user-menu-btn {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #202020;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: all 0.3s ease;
    }

    .user-menu-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.1);
    }

    /* Dropdown del usuario */
    .user-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background: white;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      border: 1px solid #e2e8f0;
      min-width: 200px;
      z-index: 1000;
      display: none;
    }

    .user-dropdown.show {
      display: block;
    }

    .user-dropdown-item {
      padding: 12px 16px;
      cursor: pointer;
      transition: background-color 0.2s;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-dropdown-item:hover {
      background: #f8fafc;
    }

    .user-dropdown-item:first-child {
      border-radius: 10px 10px 0 0;
    }

    .user-dropdown-item:last-child {
      border-radius: 0 0 10px 10px;
    }


  </style>

  <script>
  // ============ SISTEMA DE AUTENTICACIÓN ============
  
  // Lista de correos electrónicos autorizados
  const authorizedEmails = [
    'admin@lexar.com',
    'usuario1@lexar.com',
    'usuario2@lexar.com',
    'test@lexar.com'
  ];

  // Contraseñas para cada usuario (en un entorno real, esto debería estar en un servidor)
  const userPasswords = {
    'admin@lexar.com': 'admin123',
    'usuario1@lexar.com': 'user123',
    'usuario2@lexar.com': 'user456',
    'test@lexar.com': 'test123'
  };

  // Función para verificar credenciales
  function authenticateUser(email, password) {
    if (!authorizedEmails.includes(email)) {
      return { success: false, message: 'Correo electrónico no autorizado' };
    }
    
    if (userPasswords[email] !== password) {
      return { success: false, message: 'Contraseña incorrecta' };
    }
    
    return { success: true, message: 'Autenticación exitosa' };
  }

  // Función para mostrar la aplicación
  function showApplication() {
    document.getElementById('loginModal').style.display = 'none';
    document.getElementById('mainHeader').style.display = 'block';
    document.getElementById('actionButtonsBar').style.display = 'flex';
    document.getElementById('mainLayout').style.display = 'flex';
    
    // Mostrar información del usuario
    showUserInfo();
  }

  // Función para mostrar información del usuario
  function showUserInfo() {
    const userEmail = localStorage.getItem('lexar_user_email');
    if (userEmail) {
      const userInfo = document.getElementById('userInfo');
      const userName = document.getElementById('userName');
      const userEmailSpan = document.getElementById('userEmail');
      const userInitials = document.getElementById('userInitials');
      
      // Extraer nombre del email (antes del @)
      const name = userEmail.split('@')[0];
      const initials = name.substring(0, 2).toUpperCase();
      
      userName.textContent = name.charAt(0).toUpperCase() + name.slice(1);
      userEmailSpan.textContent = userEmail;
      userInitials.textContent = initials;
      
      userInfo.style.display = 'flex';
    }
  }

  // Función para cargar foto de perfil
  function loadUserAvatar() {
    const userEmail = localStorage.getItem('lexar_user_email');
    const avatarImg = document.getElementById('userAvatarImg');
    const userInitials = document.getElementById('userInitials');
    
    // Intentar cargar foto desde localStorage
    const savedAvatar = localStorage.getItem('lexar_user_avatar');
    if (savedAvatar) {
      avatarImg.src = savedAvatar;
      avatarImg.style.display = 'block';
      userInitials.style.display = 'none';
    } else {
      avatarImg.style.display = 'none';
      userInitials.style.display = 'flex';
    }
  }

  // Función para cambiar foto de perfil
  function changeUserAvatar() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const avatarImg = document.getElementById('userAvatarImg');
          const userInitials = document.getElementById('userInitials');
          
          avatarImg.src = e.target.result;
          avatarImg.style.display = 'block';
          userInitials.style.display = 'none';
          
          // Guardar en localStorage
          localStorage.setItem('lexar_user_avatar', e.target.result);
        };
        reader.readAsDataURL(file);
      }
    };
    input.click();
  }

  // Función para mostrar error de login
  function showLoginError(message) {
    const errorDiv = document.getElementById('loginError');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
  }

  // Función para ocultar error de login
  function hideLoginError() {
    const errorDiv = document.getElementById('loginError');
    errorDiv.style.display = 'none';
  }

  // Event listener para el formulario de login
  document.getElementById('loginForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    
    hideLoginError();
    
    const authResult = authenticateUser(email, password);
    
    if (authResult.success) {
      // Guardar sesión en localStorage
      localStorage.setItem('lexar_authenticated', 'true');
      localStorage.setItem('lexar_user_email', email);
      showApplication();
      loadUserAvatar();
    } else {
      showLoginError(authResult.message);
    }
  });

  // Verificar si ya está autenticado al cargar la página
  window.addEventListener('load', function() {
    const isAuthenticated = localStorage.getItem('lexar_authenticated');
    const userEmail = localStorage.getItem('lexar_user_email');
    
    if (isAuthenticated === 'true' && userEmail && authorizedEmails.includes(userEmail)) {
      showApplication();
      loadUserAvatar();
    }
  });

  // Función para cerrar sesión (opcional)
  function logout() {
    localStorage.removeItem('lexar_authenticated');
    localStorage.removeItem('lexar_user_email');
    location.reload();
  }

  // Agregar botón de cerrar sesión al menú (opcional)
  document.addEventListener('DOMContentLoaded', function() {
    // Agregar opción de cerrar sesión al menú Archivo
    const exitMenuItem = document.getElementById('exitApp');
    if (exitMenuItem) {
      exitMenuItem.addEventListener('click', function(e) {
        e.preventDefault();
        if (confirm('¿Desea cerrar sesión?')) {
          logout();
        }
      });
    }

    // Event listener para el dropdown del usuario
    const userMenuBtn = document.getElementById('userMenuBtn');
    const userDropdown = document.getElementById('userDropdown');
    
    if (userMenuBtn && userDropdown) {
      userMenuBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        userDropdown.classList.toggle('show');
      });

      // Cerrar dropdown al hacer clic fuera
      document.addEventListener('click', function(e) {
        if (!userMenuBtn.contains(e.target) && !userDropdown.contains(e.target)) {
          userDropdown.classList.remove('show');
        }
      });
    }
  });
  </script>
</body>
</html>
